# План внедрения модального окна «Карточка урока»

## 1. Точки открытия
- Тап по карточке урока на экранах «День», «Неделя», «Сегодня».
- Выбор занятия из списка ученика («Ближайшие занятия»).
- Навигация остаётся на текущем экране; окно управляется локальным состоянием или ViewModel.

## 2. Состав данных
- Ученик: имя и аватар/инициалы.
- Предмет и класс (из `SubjectPreset` или данных урока).
- Время начала и длительность (`Lesson`).
- Стоимость (из `Lesson`, либо из пресета при пустом значении).
- Статус оплаты (`Payment`: `PAID`/`DUE`/`NONE`).
- Короткая заметка (`Lesson` или отдельная таблица заметок).
- (Опционально) Формат урока: онлайн/офлайн, адрес или ссылка.

## 3. Источники
- Репозиторий отдаёт агрегированную модель `LessonDetails` (проекция `Lesson` + `Student` + `SubjectPreset` + `Payment` + `Note`).
- Для статуса оплаты используем подписку на запись `Payment` по `lessonId`.
- Для заметок — отдельное хранилище или поле в `Lesson`.

## 4. Действия пользователя
- **Отметить как оплачено**: создать/обновить `Payment` со статусом `PAID`, суммой и датой; обновлять UI реактивно.
- **Сделать долгом**: перевести платёж в `DUE` либо удалить запись (в зависимости от модели).
- **Сохранить заметку**: поле до 300–500 символов, кнопка «Сохранить заметку», Snackbar при успехе.
- **Редактировать**: переход на экран редактирования урока, окно закрывается; после возврата данные обновлены через `Flow`.
- **Закрыть**: кнопка-крестик, свайп вниз или системная кнопка Back.

## 5. Валидации и ограничения
- При отметке оплаты проверять, что сумма ≥ 0 и валюта соответствует настройкам.
- При изменении статуса подтверждать действие, если сумма отличается от текущей или не задана.
- Предупреждать при закрытии окна с несохранённой заметкой.

## 6. UI-структура
- Шапка: аватар и имя ученика, кнопка закрытия.
- Карточка «Предмет / Класс».
- Два мини-блока: «Время» и «Длительность».
- Блок стоимости и чип статуса (Оплачено/Долг/–).
- Основная кнопка: «Отметить как оплачено» для `DUE`/`NONE`, «Сделать долгом» для `PAID`.
- Поле заметки и кнопка «Сохранить заметку».
- Вторичная кнопка «Редактировать».

## 7. Поведение и UX
- Модальное bottom sheet (60–90 % высоты) со свайп-закрытием и вертикальной прокруткой.
- Кнопки показывают прогресс при длительных операциях.
- Цвета статусов: `PAID` — зелёный/нейтральный чип, `DUE` — красный.
- Snackbar для подтверждения («Оплата отмечена», «Заметка сохранена»).

## 8. Интеграция с репозиториями
- `observeLessonDetails(lessonId)` — основной поток данных.
- `markPaid(lessonId, amount, at)` / `markDue(lessonId)` — обновляют `Payment`.
- `saveNote(lessonId, text)` — обновляет заметку.
- Все методы вызываются из ViewModel; UI подписан на `Flow`/`State`.

## 9. Навигация
- Bottom sheet открывается без смены маршрута.
- Кнопка «Редактировать» ведёт на `/lesson/{id}/edit`.
- После сохранения на экране редактирования окно повторно не открываем (по UX-решению), данные обновляются реактивно.

## 10. Пограничные случаи
- Урок в прошлом: разрешено отмечать оплату и добавлять заметку.
- Отменённый/перенесённый урок: скорректировать доступность оплаты.
- При отсутствии `Payment` создавать запись при первом действии.
- При конкурентных изменениях обновлять данные и предлагать повторить действие.

## 11. Доступность и локализация
- Добавить доступные лейблы и корректный порядок фокуса.
- Форматы времени и валюты — из локали пользователя.
- Touch-таргеты ≥ 48 dp.
