# Алгоритм внедрения модального окна «Карточка урока»

Ниже представлен детализированный алгоритм внедрения всплывающего окна «Карточка урока», которое ускоряет сценарий «провёл → отметил → заметка» без изменения текущей навигации приложения.

## 1. Инициация окна
1. Обработать тапы по карточке урока на экранах «День», «Неделя», «Сегодня».
2. Добавить обработчик выбора занятия в списке ученика («Ближайшие занятия»).
3. В обоих случаях не изменять маршрут: окно открывается поверх текущего экрана и управляется локальным состоянием/`ViewModel`.

## 2. Запрашиваемые данные
1. Получить ФИО ученика и аватар/инициалы.
2. Подготовить связку «Предмет + Класс» из `SubjectPreset` либо данных самого урока.
3. Извлечь время начала и длительность урока (`Lesson`).
4. Определить стоимость: брать из `Lesson`, а при отсутствии — из пресета.
5. Определить статус оплаты (`Payment`: `PAID`/`DUE`/`NONE`).
6. Получить краткую заметку (поле `Lesson` либо связанная таблица заметок).
7. (Опционально) Добавить формат урока (онлайн/офлайн) и адрес/ссылку.

## 3. Источники данных
1. Настроить репозиторий на возврат агрегированной модели `LessonDetails` = `Lesson` + `Student` + `SubjectPreset` + `Payment` + `Note`.
2. Для статуса оплаты подписаться на поток `Payment` по `lessonId`.
3. Для заметок использовать отдельное хранилище либо поле в `Lesson`, синхронизированное с `LessonDetails`.

## 4. Сценарии внутри окна
1. **Отметить как оплачено**
   - Создать или обновить `Payment` со статусом `PAID`, суммой и датой.
   - После подтверждения немедленно обновить бейдж и основную кнопку.
2. **Сделать долгом**
   - Если текущий статус `PAID`, перевести запись в `DUE` или удалить платёж (по принятой модели).
3. **Сохранить заметку**
   - Ограничить ввод длиной 300–500 символов.
   - Кнопка «Сохранить заметку» запускает `saveNote`; при успехе показать Snackbar.
4. **Редактировать**
   - По нажатию закрыть окно и перейти на маршрут `/lesson/{id}/edit`.
   - После возврата данные автоматически обновляются благодаря `Flow`.
5. **Закрыть**
   - Предусмотреть крестик в шапке, свайп вниз и аппаратную кнопку Back.

## 5. Валидации и ограничения
1. При установке статуса `PAID` проверять, что сумма ≥ 0 и соответствует валюте настроек.
2. При переключении статуса показывать подтверждение, если сумма отличается от текущей либо отсутствует.
3. При попытке закрыть окно с несохранённой заметкой запрашивать подтверждение, чтобы не потерять изменения.

## 6. Структура интерфейса
1. Шапка: аватар ученика + имя, справа кнопка закрытия.
2. Информационная карточка «Предмет / Класс».
3. Два мини-блока с иконками: «Время» и «Длительность».
4. Блок стоимости с подписью и маленьким чипом статуса (Оплачено/Долг/–).
5. Основная кнопка действия:
   - при `DUE`/`NONE` — «Отметить как оплачено»;
   - при `PAID` — «Сделать долгом» или «Отменить оплату».
6. Поле заметки со счётчиком символов и кнопка «Сохранить заметку».
7. Вторичная (outlined) кнопка «Редактировать».

## 7. Поведение и UX
1. Использовать modal bottom sheet высотой 60–90 % экрана со свайп-закрытием.
2. Внутри предусмотреть вертикальную прокрутку, чтобы клавиатура не перекрывала кнопки.
3. Кнопки отображают индикатор прогресса при длительных операциях.
4. Цвета статусов: `PAID` — зелёный/нейтральный чип, `DUE` — красный.
5. Отображать Snackbar после успешных действий («Оплата отмечена», «Заметка сохранена»).

## 8. Интеграция с репозиториями
1. `observeLessonDetails(lessonId)` — поток данных для всего окна.
2. `markPaid(lessonId, amount, at)` и `markDue(lessonId)` — методы обновления `Payment`.
3. `saveNote(lessonId, text)` — метод сохранения заметки.
4. Все методы вызываются из `ViewModel`; UI подписан на `Flow`/`State`.

## 9. Навигация и возврат
1. Bottom sheet открывается без изменения маршрута.
2. Кнопка «Редактировать» инициирует навигацию на `/lesson/{id}/edit`.
3. После редактирования и возврата окно открывать не обязательно; данные обновятся реактивно.

## 10. Пограничные ситуации
1. Для уроков в прошлом разрешать отметку оплаты и сохранение заметок.
2. Для отменённых/перенесённых уроков корректировать доступность кнопок оплаты (можно отключать).
3. При отсутствии `Payment` создавать запись при первом действии пользователя.
4. При конкурентных изменениях обновлять данные и предлагать повторить действие.

## 11. Доступность и локализация
1. Добавить понятные `contentDescription`, подписи и корректный порядок фокуса.
2. Использовать форматы времени и валюты согласно локали пользователя.
3. Соблюдать минимальные размеры интерактивных областей ≥ 48 dp.
