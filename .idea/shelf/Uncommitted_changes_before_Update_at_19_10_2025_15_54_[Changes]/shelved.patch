Index: app/src/main/java/com/tutorly/ui/lessoncreation/LessonCreationViewModel.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.tutorly.ui.lessoncreation\r\n\r\nimport androidx.lifecycle.ViewModel\r\nimport androidx.lifecycle.viewModelScope\r\nimport com.tutorly.domain.model.LessonCreateRequest\r\nimport com.tutorly.domain.model.LessonDetails\r\nimport com.tutorly.domain.repo.LessonsRepository\r\nimport com.tutorly.domain.repo.StudentsRepository\r\nimport com.tutorly.domain.repo.SubjectPresetsRepository\r\nimport com.tutorly.domain.repo.UserSettingsRepository\r\nimport com.tutorly.models.Student\r\nimport com.tutorly.models.SubjectPreset\r\nimport dagger.hilt.android.lifecycle.HiltViewModel\r\nimport java.math.BigDecimal\r\nimport java.math.RoundingMode\r\nimport java.time.Duration\r\nimport java.time.Instant\r\nimport java.time.LocalDate\r\nimport java.time.LocalTime\r\nimport java.time.ZoneId\r\nimport java.time.ZonedDateTime\r\nimport java.time.format.DateTimeFormatter\r\nimport java.util.Currency\r\nimport java.util.Locale\r\nimport javax.inject.Inject\r\nimport kotlin.collections.ArrayDeque\r\nimport kotlinx.coroutines.flow.MutableSharedFlow\r\nimport kotlinx.coroutines.flow.MutableStateFlow\r\nimport kotlinx.coroutines.flow.StateFlow\r\nimport kotlinx.coroutines.flow.asSharedFlow\r\nimport kotlinx.coroutines.flow.asStateFlow\r\nimport kotlinx.coroutines.flow.first\r\nimport kotlinx.coroutines.flow.update\r\nimport kotlinx.coroutines.launch\r\nimport kotlin.math.max\r\n\r\nprivate const val TIME_INPUT_INVALID_MESSAGE = \"Введите время в формате ЧЧ:ММ\"\r\n\r\n@HiltViewModel\r\nclass LessonCreationViewModel @Inject constructor(\r\n    private val lessonsRepository: LessonsRepository,\r\n    private val studentsRepository: StudentsRepository,\r\n    private val subjectPresetsRepository: SubjectPresetsRepository,\r\n    private val userSettingsRepository: UserSettingsRepository\r\n) : ViewModel() {\r\n\r\n    private val _uiState = MutableStateFlow(LessonCreationUiState())\r\n    val uiState: StateFlow<LessonCreationUiState> = _uiState.asStateFlow()\r\n\r\n    private val _events = MutableSharedFlow<LessonCreationEvent>(extraBufferCapacity = 1)\r\n    val events = _events.asSharedFlow()\r\n\r\n    private var cachedSubjects: List<SubjectPreset> = emptyList()\r\n    private var durationEdited: Boolean = false\r\n    private var priceEdited: Boolean = false\r\n    private var currentZone: ZoneId = ZoneId.systemDefault()\r\n    private var conflictRequest: LessonCreateRequest? = null\r\n    private var pendingStudentConfig: LessonCreationConfig? = null\r\n    private var pendingNewStudentName: String? = null\r\n    private val snackbarQueue: ArrayDeque<SnackbarPayload> = ArrayDeque()\r\n    private val rateHistoryCache: MutableMap<Long, List<RateUsage>> = mutableMapOf()\r\n    private var currentRateHistory: List<RateUsage> = emptyList()\r\n    private var currentStudentBaseRateCents: Int? = null\r\n    private var currentStudentBaseRateDuration: Int? = null\r\n\r\n    init {\r\n        viewModelScope.launch {\r\n            cachedSubjects = subjectPresetsRepository.all()\r\n            _uiState.update { state ->\r\n                val options = cachedSubjects.map { it.toOption() }\r\n                val selected = state.selectedSubjectId?.takeIf { id -> options.any { it.id == id } }\r\n                state.copy(\r\n                    subjects = options,\r\n                    availableSubjects = resolveAvailableSubjects(state.selectedStudent, state.locale, selected),\r\n                    selectedSubjectId = selected\r\n                )\r\n            }\r\n            val currentSelected = _uiState.value.selectedSubjectId\r\n            if (currentSelected != null && cachedSubjects.any { it.id == currentSelected }) {\r\n                onSubjectSelected(currentSelected)\r\n            }\r\n        }\r\n    }\r\n\r\n    fun start(config: LessonCreationConfig) {\r\n        pendingStudentConfig = null\r\n        pendingNewStudentName = null\r\n        viewModelScope.launch {\r\n            cachedSubjects = subjectPresetsRepository.all()\r\n            val settings = userSettingsRepository.get()\r\n            val locale = Locale(settings.locale)\r\n            val currencySymbol = runCatching { Currency.getInstance(settings.currency).getSymbol(locale) }\r\n                .getOrDefault(settings.currency)\r\n            val zone = config.zoneId ?: config.start?.zone ?: ZoneId.systemDefault()\r\n            val start = config.start ?: ZonedDateTime.now(zone)\r\n            currentZone = zone\r\n            val slotStep = gcd(settings.slotStepMinutes, 5).coerceAtLeast(5)\r\n            val roundedStart = roundToStep(start, slotStep)\r\n            val startTime = roundedStart.toLocalTime()\r\n            val baseDuration = config.duration?.toMinutes()?.toInt()\r\n                ?: settings.defaultLessonDurationMinutes\r\n            val basePrice = settings.defaultLessonPriceCents\r\n\r\n            durationEdited = config.duration != null\r\n            priceEdited = false\r\n            currentRateHistory = emptyList()\r\n            currentStudentBaseRateCents = null\r\n            currentStudentBaseRateDuration = null\r\n\r\n            val students = loadStudents(\"\")\r\n            val subjectOptions = cachedSubjects.map { it.toOption() }\r\n\r\n            _uiState.value = LessonCreationUiState(\r\n                isVisible = true,\r\n                studentQuery = \"\",\r\n                students = students,\r\n                selectedStudent = null,\r\n                subjects = subjectOptions,\r\n                availableSubjects = subjectOptions,\r\n                selectedSubjectId = null,\r\n                date = roundedStart.toLocalDate(),\r\n                time = startTime,\r\n                timeInput = formatTime(startTime, locale),\r\n                durationMinutes = baseDuration,\r\n                priceCents = basePrice,\r\n                note = config.note.orEmpty(),\r\n                currencySymbol = currencySymbol,\r\n                slotStepMinutes = slotStep,\r\n                origin = config.origin,\r\n                locale = locale,\r\n                zoneId = currentZone\r\n            )\r\n\r\n            config.studentId?.let { selectStudent(it, applyDefaults = config.duration == null && config.subjectId == null) }\r\n            config.subjectId?.let { onSubjectSelected(it) }\r\n        }\r\n    }\r\n\r\n    fun dismiss() {\r\n        _uiState.update {\r\n            it.copy(\r\n                isVisible = false,\r\n                snackbarMessage = null,\r\n                snackbarActionLabel = null,\r\n                showConflictDialog = null,\r\n                studentDuplicatePrompt = null\r\n            )\r\n        }\r\n        conflictRequest = null\r\n        pendingNewStudentName = null\r\n        snackbarQueue.clear()\r\n    }\r\n\r\n    fun prepareForStudentCreation() {\r\n        val state = _uiState.value\r\n        if (!state.isVisible) return\r\n        pendingStudentConfig = LessonCreationConfig(\r\n            start = ZonedDateTime.of(state.date, state.time, currentZone),\r\n            duration = Duration.ofMinutes(state.durationMinutes.toLong()),\r\n            studentId = null,\r\n            subjectId = state.selectedSubjectId,\r\n            note = state.note,\r\n            zoneId = currentZone,\r\n            origin = state.origin\r\n        )\r\n    }\r\n\r\n    fun onStudentCreated(studentId: Long): Boolean {\r\n        val pending = pendingStudentConfig ?: return false\r\n        pendingStudentConfig = null\r\n        start(pending.copy(studentId = studentId))\r\n        return true\r\n    }\r\n\r\n    fun onStudentQueryChange(query: String) {\r\n        pendingNewStudentName = null\r\n        val currentState = _uiState.value\r\n        val selected = currentState.selectedStudent\r\n        val enforced = enforceCapitalized(query, currentState.locale)\r\n        val keepSelection = selected?.name?.equals(enforced, ignoreCase = true) == true\r\n        val availableSubjects = if (keepSelection) {\r\n            currentState.availableSubjects\r\n        } else {\r\n            resolveAvailableSubjects(null, currentState.locale, currentState.selectedSubjectId)\r\n        }\r\n        val pricePresets = if (keepSelection) currentState.pricePresets else emptyList()\r\n        _uiState.update {\r\n            it.copy(\r\n                studentQuery = enforced,\r\n                selectedStudent = if (keepSelection) selected else null,\r\n                availableSubjects = availableSubjects,\r\n                pricePresets = pricePresets,\r\n                studentDuplicatePrompt = null\r\n            )\r\n        }\r\n        if (!keepSelection) {\r\n            currentRateHistory = emptyList()\r\n            currentStudentBaseRateCents = null\r\n            currentStudentBaseRateDuration = null\r\n        }\r\n        viewModelScope.launch {\r\n            val students = loadStudents(enforced)\r\n            _uiState.update { current ->\r\n                if (current.studentQuery == enforced) {\r\n                    current.copy(students = students)\r\n                } else {\r\n                    current\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    fun onStudentSelected(studentId: Long) {\r\n        pendingNewStudentName = null\r\n        viewModelScope.launch {\r\n            selectStudent(studentId, applyDefaults = true)\r\n        }\r\n    }\r\n\r\n    private suspend fun selectStudent(studentId: Long, applyDefaults: Boolean) {\r\n        val state = _uiState.value\r\n        val selected = state.students.firstOrNull { it.id == studentId }\r\n            ?: studentsRepository.getByIdSafe(studentId)?.toOption()\r\n        if (selected == null) return\r\n\r\n        durationEdited = durationEdited && !applyDefaults\r\n        priceEdited = false\r\n\r\n        val latest = lessonsRepository.latestLessonForStudent(studentId)\r\n        val subjectId = latest?.subjectId ?: state.selectedSubjectId\r\n        val duration = when {\r\n            durationEdited -> state.durationMinutes\r\n            latest != null -> Duration.between(latest.startAt, latest.endAt).toMinutes().toInt()\r\n            else -> state.durationMinutes\r\n        }\r\n        val studentRate = selected.rateCents?.takeIf { it > 0 }\r\n        val price = when {\r\n            priceEdited -> state.priceCents\r\n            studentRate != null -> studentRate\r\n            latest != null -> latest.priceCents\r\n            else -> state.priceCents\r\n        }\r\n\r\n        currentRateHistory = loadRateHistory(studentId)\r\n        currentStudentBaseRateCents = studentRate\r\n        currentStudentBaseRateDuration = studentRate?.let { duration.takeIf { it > 0 } }\r\n        val pricePresets = computePricePresets(duration)\r\n\r\n        val availableSubjectOptions = resolveAvailableSubjects(selected, state.locale, subjectId)\r\n        val resolvedSubjectId = when {\r\n            subjectId != null && availableSubjectOptions.any { it.id == subjectId } -> subjectId\r\n            applyDefaults && availableSubjectOptions.isNotEmpty() -> availableSubjectOptions.first().id\r\n            else -> subjectId\r\n        }\r\n        val firstStudentSubject = selected.subjects\r\n            .map { it.trim() }\r\n            .firstOrNull { it.isNotEmpty() }\r\n            .orEmpty()\r\n        val resolvedSubjectName = resolvedSubjectId?.let { id ->\r\n            availableSubjectOptions.firstOrNull { it.id == id }?.name\r\n        } ?: firstStudentSubject\r\n\r\n        _uiState.update {\r\n            it.copy(\r\n                selectedStudent = selected,\r\n                students = mergeStudentOption(it.students, selected),\r\n                studentQuery = selected.name,\r\n                selectedSubjectId = resolvedSubjectId,\r\n                durationMinutes = duration,\r\n                priceCents = price,\r\n                pricePresets = pricePresets,\r\n                availableSubjects = availableSubjectOptions,\r\n                subjectInput = if (applyDefaults || it.selectedStudent?.id != selected.id) {\r\n                    resolvedSubjectName\r\n                } else {\r\n                    it.subjectInput.ifBlank { resolvedSubjectName }\r\n                }\r\n            )\r\n        }\r\n\r\n        if (applyDefaults) {\r\n            if (resolvedSubjectId != null) {\r\n                onSubjectSelected(resolvedSubjectId)\r\n            } else if (resolvedSubjectName.isNotBlank()) {\r\n                onSubjectInputChanged(resolvedSubjectName)\r\n            }\r\n        }\r\n    }\r\n\r\n    private fun resolveAvailableSubjects(\r\n        student: StudentOption?,\r\n        locale: Locale,\r\n        keepSubjectId: Long? = null\r\n    ): List<SubjectOption> {\r\n        if (cachedSubjects.isEmpty()) return emptyList()\r\n        val allOptions = cachedSubjects.map { it.toOption() }\r\n        val subjects = student?.subjects.orEmpty()\r\n            .map { it.trim() }\r\n            .filter { it.isNotEmpty() }\r\n        if (subjects.isEmpty()) return includeSubjectIfNeeded(allOptions, allOptions, keepSubjectId)\r\n\r\n        val normalized = subjects.map { it.lowercase(locale) }.toSet()\r\n        val filtered = cachedSubjects.filter { preset ->\r\n            normalized.contains(preset.name.lowercase(locale))\r\n        }\r\n        val options = (if (filtered.isEmpty()) cachedSubjects else filtered).map { it.toOption() }\r\n        return includeSubjectIfNeeded(options, allOptions, keepSubjectId)\r\n    }\r\n\r\n    private fun includeSubjectIfNeeded(\r\n        primary: List<SubjectOption>,\r\n        allOptions: List<SubjectOption>,\r\n        keepSubjectId: Long?\r\n    ): List<SubjectOption> {\r\n        if (keepSubjectId == null || primary.any { it.id == keepSubjectId }) {\r\n            return primary\r\n        }\r\n        val fallback = allOptions.firstOrNull { it.id == keepSubjectId } ?: return primary\r\n        return primary + fallback\r\n    }\r\n\r\n    fun onSubjectSelected(subjectId: Long?) {\r\n        val state = _uiState.value\r\n        if (subjectId == null) {\r\n            _uiState.update { it.copy(selectedSubjectId = null) }\r\n            return\r\n        }\r\n        val subject = state.subjects.firstOrNull { it.id == subjectId }\r\n        if (subject == null) {\r\n            _uiState.update { it.copy(selectedSubjectId = null) }\r\n            return\r\n        }\r\n        applySubjectOption(subject, state)\r\n    }\r\n\r\n    fun onSubjectInputChanged(value: String) {\r\n        val state = _uiState.value\r\n        val enforced = enforceCapitalized(value, state.locale)\r\n        val normalized = enforced.trim()\r\n        if (normalized.isEmpty()) {\r\n            _uiState.update { it.copy(subjectInput = enforced, selectedSubjectId = null) }\r\n            return\r\n        }\r\n        val match = state.availableSubjects.firstOrNull { it.name.equals(normalized, ignoreCase = true) }\r\n            ?: state.subjects.firstOrNull { it.name.equals(normalized, ignoreCase = true) }\r\n        if (match != null) {\r\n            applySubjectOption(match, state)\r\n        } else {\r\n            _uiState.update {\r\n                it.copy(\r\n                    subjectInput = enforced,\r\n                    selectedSubjectId = null\r\n                )\r\n            }\r\n        }\r\n    }\r\n\r\n    private fun applySubjectOption(option: SubjectOption, state: LessonCreationUiState) {\r\n        val newDuration = if (durationEdited) state.durationMinutes else option.durationMinutes\r\n        val newPrice = if (priceEdited) state.priceCents else option.defaultPriceCents\r\n        _uiState.update {\r\n            it.copy(\r\n                selectedSubjectId = option.id,\r\n                subjectInput = option.name,\r\n                durationMinutes = newDuration,\r\n                priceCents = newPrice,\r\n                pricePresets = computePricePresets(newDuration)\r\n            )\r\n        }\r\n    }\r\n\r\n    fun onDateSelected(date: LocalDate) {\r\n        _uiState.update { it.copy(date = date) }\r\n    }\r\n\r\n    fun onTimeSelected(time: LocalTime) {\r\n        val state = _uiState.value\r\n        val aligned = alignTimeToStep(time, state.slotStepMinutes)\r\n        _uiState.update {\r\n            it.copy(\r\n                time = aligned,\r\n                timeInput = formatTime(aligned, it.locale),\r\n                errors = it.errors - LessonCreationField.TIME\r\n            )\r\n        }\r\n    }\r\n\r\n    fun onTimeInputChanged(rawValue: String) {\r\n        val state = _uiState.value\r\n        val digits = rawValue.filter { it.isDigit() }.take(4)\r\n        val formatted = formatTimeInput(digits)\r\n        if (digits.length < 3) {\r\n            _uiState.update {\r\n                it.copy(\r\n                    timeInput = formatted,\r\n                    errors = it.errors - LessonCreationField.TIME\r\n                )\r\n            }\r\n            return\r\n        }\r\n\r\n        val padded = digits.padStart(4, '0')\r\n        val hours = padded.substring(0, 2).toInt()\r\n        val minutes = padded.substring(2, 4).toInt()\r\n        if (hours !in 0..23 || minutes !in 0..59) {\r\n            _uiState.update {\r\n                it.copy(\r\n                    timeInput = formatted,\r\n                    errors = it.errors + (LessonCreationField.TIME to TIME_INPUT_INVALID_MESSAGE)\r\n                )\r\n            }\r\n            return\r\n        }\r\n\r\n        val aligned = alignTimeToStep(LocalTime.of(hours, minutes), state.slotStepMinutes)\r\n        _uiState.update {\r\n            it.copy(\r\n                time = aligned,\r\n                timeInput = formatTime(aligned, it.locale),\r\n                errors = it.errors - LessonCreationField.TIME\r\n            )\r\n        }\r\n    }\r\n\r\n    fun onDurationChanged(value: Int) {\r\n        durationEdited = true\r\n        val sanitized = value.coerceAtLeast(0)\r\n        _uiState.update {\r\n            it.copy(\r\n                durationMinutes = sanitized,\r\n                pricePresets = computePricePresets(sanitized)\r\n            )\r\n        }\r\n    }\r\n\r\n    fun onPriceChanged(value: Int) {\r\n        priceEdited = true\r\n        _uiState.update { it.copy(priceCents = value.coerceAtLeast(0)) }\r\n    }\r\n\r\n    fun onNoteChanged(value: String) {\r\n        val locale = _uiState.value.locale\r\n        _uiState.update { it.copy(note = enforceCapitalized(value, locale)) }\r\n    }\r\n\r\n    fun submit() {\r\n        viewModelScope.launch { attemptSubmit(force = false) }\r\n    }\r\n\r\n    fun confirmConflict() {\r\n        viewModelScope.launch { conflictRequest?.let { createLesson(it) } }\r\n    }\r\n\r\n    fun dismissConflict() {\r\n        conflictRequest = null\r\n        _uiState.update { it.copy(showConflictDialog = null) }\r\n    }\r\n\r\n    fun consumeSnackbar() {\r\n        val next = if (snackbarQueue.isEmpty()) null else snackbarQueue.removeFirst()\r\n        if (next == null) {\r\n            _uiState.update { it.copy(snackbarMessage = null, snackbarActionLabel = null) }\r\n        } else {\r\n            _uiState.update {\r\n                it.copy(\r\n                    snackbarMessage = next.message,\r\n                    snackbarActionLabel = next.actionLabel\r\n                )\r\n            }\r\n        }\r\n    }\r\n\r\n    private suspend fun attemptSubmit(force: Boolean) {\r\n        var state = _uiState.value\r\n        val errors = mutableMapOf<LessonCreationField, String>()\r\n        val trimmedName = state.studentQuery.trim()\r\n        var student = state.selectedStudent\r\n        if (student == null && trimmedName.isBlank()) {\r\n            errors[LessonCreationField.STUDENT] = \"Укажите ученика\"\r\n        }\r\n        if (state.durationMinutes <= 0) {\r\n            errors[LessonCreationField.DURATION] = \"Длительность должна быть больше 0\"\r\n        } else if (state.durationMinutes % state.slotStepMinutes != 0) {\r\n            errors[LessonCreationField.DURATION] = \"Длительность кратна шагу ${state.slotStepMinutes} мин\"\r\n        }\r\n        if (state.priceCents < 0) {\r\n            errors[LessonCreationField.PRICE] = \"Стоимость не может быть отрицательной\"\r\n        }\r\n\r\n        val start = ZonedDateTime.of(state.date, state.time, currentZone)\r\n        val end = start.plusMinutes(state.durationMinutes.toLong())\r\n        if (end.toLocalDate().isAfter(state.date)) {\r\n            errors[LessonCreationField.TIME] = \"Урок должен закончиться в тот же день\"\r\n        }\r\n\r\n        if (errors.isNotEmpty()) {\r\n            _uiState.update { it.copy(errors = errors) }\r\n            return\r\n        }\r\n\r\n        if (student == null) {\r\n            val similar = findSimilarStudent(trimmedName)\r\n            if (similar != null && !force) {\r\n                _uiState.update {\r\n                    it.copy(\r\n                        errors = emptyMap(),\r\n                        studentDuplicatePrompt = StudentDuplicatePrompt(\r\n                            existingStudent = similar,\r\n                            enteredName = trimmedName,\r\n                            forceSubmission = force\r\n                        )\r\n                    )\r\n                }\r\n                return\r\n            }\r\n\r\n            val created = createStudentFromInput(trimmedName, state) ?: return\r\n            _uiState.update { it.copy(studentDuplicatePrompt = null) }\r\n            selectStudent(created.id, applyDefaults = false)\r\n            state = _uiState.value\r\n            student = state.selectedStudent\r\n        } else {\r\n            pendingNewStudentName = null\r\n        }\r\n\r\n        if (student == null) {\r\n            errors[LessonCreationField.STUDENT] = \"Укажите ученика\"\r\n            _uiState.update { it.copy(errors = errors) }\r\n            return\r\n        }\r\n\r\n        val normalizedSubjectInput = state.subjectInput.trim()\r\n        val selectedSubjectName = state.subjects.firstOrNull { it.id == state.selectedSubjectId }?.name\r\n        val title = normalizedSubjectInput.takeUnless {\r\n            it.isEmpty() || (selectedSubjectName != null && selectedSubjectName.equals(it, ignoreCase = true))\r\n        }\r\n\r\n        val request = LessonCreateRequest(\r\n            studentId = student.id,\r\n            subjectId = state.selectedSubjectId,\r\n            title = title,\r\n            startAt = start.toInstant(),\r\n            endAt = end.toInstant(),\r\n            priceCents = state.priceCents,\r\n            note = state.note.takeUnless { it.isBlank() }\r\n        )\r\n\r\n        if (!force) {\r\n            val conflicts = lessonsRepository.findConflicts(request.startAt, request.endAt)\r\n            if (conflicts.isNotEmpty()) {\r\n                conflictRequest = request\r\n                _uiState.update {\r\n                    it.copy(\r\n                        errors = emptyMap(),\r\n                        showConflictDialog = ConflictInfo(\r\n                            conflicts = conflicts.map { conflict -> conflict.toConflictLesson(currentZone) },\r\n                            start = start,\r\n                            end = end\r\n                        )\r\n                    )\r\n                }\r\n                return\r\n            }\r\n        }\r\n\r\n        createLesson(request)\r\n    }\r\n\r\n    fun useDuplicateStudent() {\r\n        val prompt = _uiState.value.studentDuplicatePrompt ?: return\r\n        viewModelScope.launch {\r\n            pendingNewStudentName = null\r\n            _uiState.update { it.copy(studentDuplicatePrompt = null) }\r\n            selectStudent(prompt.existingStudent.id, applyDefaults = true)\r\n            attemptSubmit(prompt.forceSubmission)\r\n        }\r\n    }\r\n\r\n    fun createDuplicateStudent() {\r\n        val prompt = _uiState.value.studentDuplicatePrompt ?: return\r\n        viewModelScope.launch {\r\n            val created = createStudentFromInput(prompt.enteredName, _uiState.value) ?: return@launch\r\n            _uiState.update { it.copy(studentDuplicatePrompt = null) }\r\n            selectStudent(created.id, applyDefaults = false)\r\n            attemptSubmit(prompt.forceSubmission)\r\n        }\r\n    }\r\n\r\n    fun dismissDuplicateStudent() {\r\n        _uiState.update { it.copy(studentDuplicatePrompt = null) }\r\n    }\r\n\r\n    private suspend fun createLesson(request: LessonCreateRequest) {\r\n        _uiState.update { it.copy(isSubmitting = true, errors = emptyMap()) }\r\n        runCatching {\r\n            lessonsRepository.create(request)\r\n        }.onSuccess {\r\n            val start = ZonedDateTime.ofInstant(request.startAt, currentZone)\r\n            val end = ZonedDateTime.ofInstant(request.endAt, currentZone)\r\n            val durationMinutes = Duration.between(request.startAt, request.endAt).toMinutes().toInt()\r\n            if (durationMinutes > 0) {\r\n                val usage = RateUsage(\r\n                    priceCents = request.priceCents,\r\n                    durationMinutes = durationMinutes,\r\n                    timestamp = request.startAt\r\n                )\r\n                rateHistoryCache[request.studentId] =\r\n                    (rateHistoryCache[request.studentId] ?: emptyList()) + usage\r\n                if (_uiState.value.selectedStudent?.id == request.studentId) {\r\n                    currentRateHistory = currentRateHistory + usage\r\n                }\r\n            }\r\n            val formatter = DateTimeFormatter.ofPattern(\"dd MMM HH:mm\", _uiState.value.locale)\r\n            val baseMessage = \"Урок добавлен на ${start.format(formatter)}–${end.toLocalTime().format(DateTimeFormatter.ofPattern(\"HH:mm\"))}\"\r\n            val newStudentName = pendingNewStudentName\r\n            _uiState.update {\r\n                it.copy(\r\n                    isSubmitting = false,\r\n                    isVisible = false,\r\n                    errors = emptyMap(),\r\n                    showConflictDialog = null,\r\n                    selectedStudent = null,\r\n                    studentQuery = \"\",\r\n                    pricePresets = emptyList()\r\n                )\r\n            }\r\n            currentRateHistory = emptyList()\r\n            currentStudentBaseRateCents = null\r\n            currentStudentBaseRateDuration = null\r\n            conflictRequest = null\r\n            if (newStudentName != null) {\r\n                enqueueSnackbar(\"Новый ученик \\\"$newStudentName\\\" сохранён.\", actionLabel = \"Отменить\")\r\n            }\r\n            enqueueSnackbar(baseMessage)\r\n            pendingNewStudentName = null\r\n            _events.tryEmit(\r\n                LessonCreationEvent.Created(\r\n                    start = start,\r\n                    studentId = request.studentId\r\n                )\r\n            )\r\n        }.onFailure { error ->\r\n            _uiState.update {\r\n                it.copy(\r\n                    isSubmitting = false,\r\n                    snackbarMessage = error.message ?: \"Не удалось сохранить занятие\",\r\n                    snackbarActionLabel = null\r\n                )\r\n            }\r\n        }\r\n    }\r\n\r\n    private suspend fun createStudentFromInput(\r\n        rawName: String,\r\n        sourceState: LessonCreationUiState\r\n    ): StudentOption? {\r\n        val trimmed = rawName.trim()\r\n        val name = trimmed.ifEmpty { DEFAULT_NEW_STUDENT_NAME }\r\n        val subjectName = resolveStudentSubject(sourceState)\r\n        val grade = resolveStudentGrade(sourceState)\r\n        val rateCents = sourceState.priceCents.takeIf { it > 0 }\r\n        val newStudent = Student(\r\n            name = name,\r\n            rateCents = rateCents,\r\n            subject = subjectName,\r\n            grade = grade\r\n        )\r\n        val newId = runCatching { studentsRepository.upsert(newStudent) }\r\n            .onFailure { error ->\r\n                _uiState.update {\r\n                    it.copy(\r\n                        snackbarMessage = error.message ?: \"Не удалось сохранить ученика\",\r\n                        snackbarActionLabel = null\r\n                    )\r\n                }\r\n            }\r\n            .getOrNull() ?: return null\r\n        pendingNewStudentName = name\r\n        return studentsRepository.getByIdSafe(newId)?.toOption() ?: newStudent.copy(id = newId).toOption()\r\n    }\r\n\r\n    private fun resolveStudentSubject(state: LessonCreationUiState): String? {\r\n        val selectedSubject = state.selectedSubjectId?.let { id ->\r\n            state.subjects.firstOrNull { it.id == id }?.name\r\n        }\r\n        val manualSubject = state.subjectInput.trim().takeIf { it.isNotEmpty() }\r\n        return (selectedSubject ?: manualSubject)?.trim()?.takeIf { it.isNotEmpty() }\r\n    }\r\n\r\n    private fun resolveStudentGrade(state: LessonCreationUiState): String? {\r\n        return extractGrade(state.note) ?: extractGrade(state.subjectInput)\r\n    }\r\n\r\n    private fun extractGrade(source: String?): String? {\r\n        if (source.isNullOrBlank()) return null\r\n        val match = GRADE_REGEX.find(source)\r\n        val gradeNumber = match?.groups?.get(2)?.value\r\n        return gradeNumber?.let { \"$it класс\" }\r\n    }\r\n\r\n    private fun enqueueSnackbar(message: String, actionLabel: String? = null) {\r\n        val current = _uiState.value\r\n        if (current.snackbarMessage == null) {\r\n            _uiState.update {\r\n                it.copy(\r\n                    snackbarMessage = message,\r\n                    snackbarActionLabel = actionLabel\r\n                )\r\n            }\r\n        } else {\r\n            snackbarQueue.addLast(SnackbarPayload(message, actionLabel))\r\n        }\r\n    }\r\n\r\n    private suspend fun findSimilarStudent(name: String): StudentOption? {\r\n        val locale = _uiState.value.locale\r\n        val normalizedQuery = normalizeNameForComparison(name, locale)\r\n        if (normalizedQuery.isEmpty()) return null\r\n        val candidates = runCatching { studentsRepository.allActive() }.getOrDefault(emptyList())\r\n        var bestOption: StudentOption? = null\r\n        var bestScore = Int.MAX_VALUE\r\n        candidates.forEach { candidate ->\r\n            val option = candidate.toOption()\r\n            val normalizedCandidate = normalizeNameForComparison(option.name, locale)\r\n            if (normalizedCandidate.isEmpty()) return@forEach\r\n            val contains = normalizedCandidate.contains(normalizedQuery) || normalizedQuery.contains(normalizedCandidate)\r\n            val score = if (contains) {\r\n                0\r\n            } else {\r\n                tokenDistance(normalizedQuery, normalizedCandidate)\r\n            }\r\n            if (contains || score <= 2) {\r\n                if (score < bestScore) {\r\n                    bestScore = score\r\n                    bestOption = option\r\n                }\r\n            }\r\n        }\r\n        return bestOption\r\n    }\r\n\r\n    private suspend fun loadStudents(query: String): List<StudentOption> {\r\n        val normalized = query.trim()\r\n        val list = runCatching {\r\n            if (normalized.isEmpty()) {\r\n                studentsRepository.allActive()\r\n            } else {\r\n                studentsRepository.searchActive(normalized)\r\n            }\r\n        }.getOrDefault(emptyList())\r\n        return list.sortedBy { it.name.lowercase(Locale.getDefault()) }.map { it.toOption() }\r\n    }\r\n\r\n    private suspend fun loadRateHistory(studentId: Long): List<RateUsage> {\r\n        rateHistoryCache[studentId]?.let { return it }\r\n        val lessons = runCatching { lessonsRepository.observeByStudent(studentId).first() }\r\n            .getOrDefault(emptyList())\r\n        val history = lessons.mapNotNull { lesson ->\r\n            val durationMinutes = Duration.between(lesson.startAt, lesson.endAt).toMinutes().toInt()\r\n            if (durationMinutes <= 0) {\r\n                null\r\n            } else {\r\n                RateUsage(\r\n                    priceCents = lesson.priceCents,\r\n                    durationMinutes = durationMinutes,\r\n                    timestamp = lesson.startAt\r\n                )\r\n            }\r\n        }\r\n        rateHistoryCache[studentId] = history\r\n        return history\r\n    }\r\n\r\n    private fun computePricePresets(durationMinutes: Int): List<Int> {\r\n        if (durationMinutes <= 0) return emptyList()\r\n        val aggregates = mutableMapOf<Int, RateAggregate>()\r\n        currentRateHistory.forEach { usage ->\r\n            val scaled = scalePrice(usage.priceCents, usage.durationMinutes, durationMinutes) ?: return@forEach\r\n            if (scaled <= 0) return@forEach\r\n            val aggregate = aggregates.getOrPut(scaled) { RateAggregate() }\r\n            aggregate.count += 1\r\n            if (usage.timestamp > aggregate.lastUsed) {\r\n                aggregate.lastUsed = usage.timestamp\r\n            }\r\n        }\r\n        val baseRate = currentStudentBaseRateCents\r\n        val baseDuration = currentStudentBaseRateDuration\r\n        if (baseRate != null && baseDuration != null && baseDuration > 0) {\r\n            val scaled = scalePrice(baseRate, baseDuration, durationMinutes)\r\n            if (scaled != null && scaled > 0) {\r\n                val aggregate = aggregates.getOrPut(scaled) { RateAggregate() }\r\n                aggregate.count += 1\r\n                if (aggregate.lastUsed < Instant.MAX) {\r\n                    aggregate.lastUsed = Instant.MAX\r\n                }\r\n            }\r\n        }\r\n        if (aggregates.isEmpty()) return emptyList()\r\n        return aggregates.entries\r\n            .sortedWith(\r\n                compareByDescending<Map.Entry<Int, RateAggregate>> { it.value.count }\r\n                    .thenByDescending { it.value.lastUsed }\r\n                    .thenBy { it.key }\r\n            )\r\n            .map { it.key }\r\n            .take(4)\r\n    }\r\n\r\n    private fun scalePrice(priceCents: Int, fromMinutes: Int, toMinutes: Int): Int? {\r\n        if (priceCents <= 0 || fromMinutes <= 0 || toMinutes <= 0) return null\r\n        val scaledRub = BigDecimal(priceCents)\r\n            .divide(BigDecimal(100))\r\n            .multiply(BigDecimal(toMinutes))\r\n            .divide(BigDecimal(fromMinutes), 0, RoundingMode.HALF_UP)\r\n        return runCatching { scaledRub.multiply(BigDecimal(100)).intValueExact() }.getOrNull()\r\n    }\r\n}\r\n\r\nprivate data class RateUsage(\r\n    val priceCents: Int,\r\n    val durationMinutes: Int,\r\n    val timestamp: Instant\r\n)\r\n\r\nprivate data class RateAggregate(\r\n    var count: Int = 0,\r\n    var lastUsed: Instant = Instant.MIN\r\n)\r\n\r\nprivate fun LessonDetails.toConflictLesson(zoneId: ZoneId): ConflictLesson {\r\n    val start = ZonedDateTime.ofInstant(startAt, zoneId)\r\n    val end = ZonedDateTime.ofInstant(endAt, zoneId)\r\n    return ConflictLesson(\r\n        id = id,\r\n        studentName = studentName,\r\n        start = start,\r\n        end = end\r\n    )\r\n}\r\n\r\nprivate fun SubjectPreset.toOption(): SubjectOption = SubjectOption(\r\n    id = id,\r\n    name = name,\r\n    colorArgb = colorArgb,\r\n    durationMinutes = durationMinutes,\r\n    defaultPriceCents = defaultPriceCents\r\n)\r\n\r\nprivate fun Student.toOption(): StudentOption {\r\n    val subjects = subject\r\n        ?.split(',', ';', '\\n')\r\n        ?.map { it.trim() }\r\n        ?.filter { it.isNotEmpty() }\r\n        ?.distinct()\r\n        ?: emptyList()\r\n\r\n    return StudentOption(\r\n        id = id,\r\n        name = name,\r\n        rateCents = rateCents,\r\n        subjects = subjects\r\n    )\r\n}\r\n\r\n\r\nprivate fun roundToStep(start: ZonedDateTime, stepMinutes: Int): ZonedDateTime {\r\n    val minute = start.minute\r\n    val remainder = minute % stepMinutes\r\n    val adjust = if (remainder == 0) 0 else stepMinutes - remainder\r\n    return start.plusMinutes(adjust.toLong()).withSecond(0).withNano(0)\r\n}\r\n\r\nprivate fun alignTimeToStep(time: LocalTime, stepMinutes: Int): LocalTime {\r\n    val remainder = time.minute % stepMinutes\r\n    val adjusted = if (remainder == 0) {\r\n        time\r\n    } else {\r\n        time.minusMinutes(remainder.toLong())\r\n    }\r\n    return adjusted.withSecond(0).withNano(0)\r\n}\r\n\r\nprivate fun formatTime(time: LocalTime, locale: Locale): String {\r\n    return time.format(DateTimeFormatter.ofPattern(\"HH:mm\", locale))\r\n}\r\n\r\nprivate fun formatTimeInput(digits: String): String {\r\n    if (digits.isEmpty()) return \"\"\r\n    if (digits.length <= 2) return digits\r\n    val padded = digits.padStart(4, '0')\r\n    val hours = padded.substring(0, 2)\r\n    val minuteDigits = (digits.length - 2).coerceIn(0, 2)\r\n    if (minuteDigits == 0) return hours\r\n    val minutes = padded.substring(2, 2 + minuteDigits)\r\n    return \"$hours:$minutes\"\r\n}\r\n\r\nprivate fun enforceCapitalized(value: String, locale: Locale): String {\r\n    val index = value.indexOfFirst { it.isLetter() }\r\n    if (index == -1) return value\r\n    val current = value[index]\r\n    val titleCased = current.titlecase(locale)\r\n    if (current == titleCased) return value\r\n    val chars = value.toCharArray()\r\n    chars[index] = titleCased\r\n    return String(chars)\r\n}\r\n\r\nprivate fun gcd(a: Int, b: Int): Int {\r\n    var x = kotlin.math.abs(a)\r\n    var y = kotlin.math.abs(b)\r\n    if (x == 0) return y\r\n    if (y == 0) return x\r\n    while (y != 0) {\r\n        val temp = y\r\n        y = x % y\r\n        x = temp\r\n    }\r\n    return x\r\n}\r\n\r\nprivate suspend fun StudentsRepository.getByIdSafe(id: Long): Student? = runCatching { getById(id) }.getOrNull()\r\n\r\nprivate fun mergeStudentOption(options: List<StudentOption>, selected: StudentOption): List<StudentOption> {\r\n    val filtered = options.filterNot { it.id == selected.id }\r\n    return listOf(selected) + filtered\r\n}\r\n\r\nprivate fun normalizeNameForComparison(value: String, locale: Locale): String {\r\n    return value\r\n        .lowercase(locale)\r\n        .replace(NON_WORD_REGEX, \" \")\r\n        .replace(WHITESPACE_REGEX, \" \")\r\n        .trim()\r\n}\r\n\r\nprivate fun tokenDistance(query: String, candidate: String): Int {\r\n    var best = levenshteinDistance(query, candidate)\r\n    val queryTokens = query.split(' ').filter { it.isNotBlank() }\r\n    val candidateTokens = candidate.split(' ').filter { it.isNotBlank() }\r\n    for (source in queryTokens) {\r\n        for (target in candidateTokens) {\r\n            val distance = levenshteinDistance(source, target)\r\n            if (distance < best) {\r\n                best = distance\r\n            }\r\n        }\r\n    }\r\n    return best\r\n}\r\n\r\nprivate fun levenshteinDistance(a: String, b: String): Int {\r\n    if (a == b) return 0\r\n    if (a.isEmpty()) return b.length\r\n    if (b.isEmpty()) return a.length\r\n    var previous = IntArray(b.length + 1) { it }\r\n    var current = IntArray(b.length + 1)\r\n    for (i in 1..a.length) {\r\n        current[0] = i\r\n        for (j in 1..b.length) {\r\n            val cost = if (a[i - 1] == b[j - 1]) 0 else 1\r\n            current[j] = minOf(\r\n                current[j - 1] + 1,\r\n                previous[j] + 1,\r\n                previous[j - 1] + cost\r\n            )\r\n        }\r\n        val temp = previous\r\n        previous = current\r\n        current = temp\r\n    }\r\n    return previous[b.length]\r\n}\r\n\r\nprivate const val DEFAULT_NEW_STUDENT_NAME = \"Ученик\"\r\nprivate val NON_WORD_REGEX = Regex(\"[^\\\\p{L}\\\\p{Nd}]\")\r\nprivate val WHITESPACE_REGEX = Regex(\"\\\\s+\")\r\nprivate val GRADE_REGEX = Regex(\"\"\"(?i)(\\n|^|\\s)(\\d{1,2})\\s*(класс|кл\\\\.?)\"\"\")\r\n\r\nprivate data class SnackbarPayload(\r\n    val message: String,\r\n    val actionLabel: String?\r\n)\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/tutorly/ui/lessoncreation/LessonCreationViewModel.kt b/app/src/main/java/com/tutorly/ui/lessoncreation/LessonCreationViewModel.kt
--- a/app/src/main/java/com/tutorly/ui/lessoncreation/LessonCreationViewModel.kt	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ b/app/src/main/java/com/tutorly/ui/lessoncreation/LessonCreationViewModel.kt	(date 1760877298876)
@@ -176,7 +176,7 @@
         pendingNewStudentName = null
         val currentState = _uiState.value
         val selected = currentState.selectedStudent
-        val enforced = enforceCapitalized(query, currentState.locale)
+        val enforced = query
         val keepSelection = selected?.name?.equals(enforced, ignoreCase = true) == true
         val availableSubjects = if (keepSelection) {
             currentState.availableSubjects
@@ -335,7 +335,7 @@
 
     fun onSubjectInputChanged(value: String) {
         val state = _uiState.value
-        val enforced = enforceCapitalized(value, state.locale)
+        val enforced =value
         val normalized = enforced.trim()
         if (normalized.isEmpty()) {
             _uiState.update { it.copy(subjectInput = enforced, selectedSubjectId = null) }
@@ -440,7 +440,7 @@
 
     fun onNoteChanged(value: String) {
         val locale = _uiState.value.locale
-        _uiState.update { it.copy(note = enforceCapitalized(value, locale)) }
+        _uiState.update { it.copy(note = value) }
     }
 
     fun submit() {
@@ -895,16 +895,16 @@
     return "$hours:$minutes"
 }
 
-private fun enforceCapitalized(value: String, locale: Locale): String {
-    val index = value.indexOfFirst { it.isLetter() }
-    if (index == -1) return value
-    val current = value[index]
-    val titleCased = current.titlecase(locale)
-    if (current == titleCased) return value
-    val chars = value.toCharArray()
-    chars[index] = titleCased
-    return String(chars)
-}
+//private fun enforceCapitalized(value: String, locale: Locale): String {
+//    val index = value.indexOfFirst { it.isLetter() }
+//    if (index == -1) return value
+//    val current = value[index]
+//    val titleCased = current.titlecase(locale)
+//    if (current == titleCased) return value
+//    val chars = value.toCharArray()
+//    chars[index] = titleCased
+//    return String(chars)
+//}
 
 private fun gcd(a: Int, b: Int): Int {
     var x = kotlin.math.abs(a)
Index: .idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23_[Changes]/shelved.patch
===================================================================
diff --git a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23_[Changes]/shelved.patch b/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23_[Changes]/shelved.patch
deleted file mode 100644
--- a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23_[Changes]/shelved.patch	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ /dev/null	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
@@ -1,63 +0,0 @@
-Index: app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt
-IDEA additional info:
-Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
-<+>package com.tutorly.ui\r\n\r\nimport androidx.compose.animation.AnimatedContent\r\nimport androidx.compose.animation.ExperimentalAnimationApi\r\nimport androidx.compose.animation.core.tween\r\nimport androidx.compose.animation.fadeIn\r\nimport androidx.compose.animation.fadeOut\r\nimport androidx.compose.animation.slideInHorizontally\r\nimport androidx.compose.animation.slideOutHorizontally\r\nimport androidx.compose.animation.togetherWith\r\nimport androidx.compose.foundation.BorderStroke\nimport androidx.compose.foundation.Canvas\nimport androidx.compose.foundation.gestures.detectHorizontalDragGestures\nimport androidx.compose.foundation.gestures.detectTapGestures\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.lazy.grid.GridCells\nimport androidx.compose.foundation.lazy.grid.LazyVerticalGrid\nimport androidx.compose.foundation.lazy.grid.items\nimport androidx.compose.foundation.rememberScrollState\nimport androidx.compose.foundation.verticalScroll\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.Add\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.clipToBounds\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.input.pointer.pointerInput\nimport androidx.compose.ui.platform.LocalDensity\nimport androidx.compose.ui.res.stringResource\nimport androidx.compose.ui.text.style.TextAlign\nimport androidx.compose.ui.text.style.TextOverflow\nimport androidx.compose.ui.unit.Dp\nimport androidx.compose.ui.unit.dp\nimport androidx.hilt.navigation.compose.hiltViewModel\nimport com.tutorly.R\nimport com.tutorly.ui.CalendarEvent\nimport com.tutorly.domain.model.PaymentStatusIcon\nimport com.tutorly.models.PaymentStatus\nimport com.tutorly.ui.components.AppTopBar\nimport com.tutorly.ui.components.LessonBrief\nimport com.tutorly.ui.components.WeekMosaic\nimport com.tutorly.ui.theme.NowRed\r\nimport com.tutorly.ui.lessoncreation.LessonCreationConfig\r\nimport com.tutorly.ui.lessoncreation.LessonCreationOrigin\r\nimport com.tutorly.ui.lessoncreation.LessonCreationSheet\r\nimport com.tutorly.ui.lessoncreation.LessonCreationViewModel\r\nimport com.tutorly.ui.lessoncard.LessonCardSheet\nimport com.tutorly.ui.lessoncard.LessonCardViewModel\nimport java.time.DayOfWeek\nimport java.time.Duration\nimport java.time.LocalDate\nimport java.time.LocalTime\nimport java.time.ZonedDateTime\nimport java.time.ZoneId\nimport java.time.YearMonth\nimport java.time.format.DateTimeFormatter\nimport java.time.format.TextStyle\nimport java.time.temporal.TemporalAdjusters\nimport java.util.*\nimport kotlin.math.abs\r\nimport kotlin.math.max\r\nimport kotlin.math.min\r\nimport kotlin.math.roundToInt\r\n\r\nenum class CalendarMode { DAY, WEEK, MONTH }\r\n\r\n@OptIn(ExperimentalAnimationApi::class)\r\n@Composable\r\nfun CalendarScreen(\n    modifier: Modifier = Modifier,\n    onAddStudent: () -> Unit = {},\n    creationViewModel: LessonCreationViewModel,\n    viewModel: CalendarViewModel = hiltViewModel()\n) {\n    val uiState by viewModel.uiState.collectAsState()\r\n    val creationState by creationViewModel.uiState.collectAsState()\r\n    val lessonCardViewModel: LessonCardViewModel = hiltViewModel()\n    val lessonCardState by lessonCardViewModel.uiState.collectAsState()\n    val snackbarHostState = remember { SnackbarHostState() }\n    var direction by remember { mutableStateOf(0) } // -1 назад, +1 вперёд\n    val anchor = uiState.anchor\n    val mode = uiState.mode\n    val zoneId = remember { ZoneId.systemDefault() }\n\n    LessonCardSheet(\n        state = lessonCardState,\n        onDismissRequest = lessonCardViewModel::dismiss,\n        onStudentSelect = lessonCardViewModel::onStudentSelected,\n        onDateSelect = lessonCardViewModel::onDateSelected,\n        onTimeSelect = lessonCardViewModel::onTimeSelected,\n        onDurationSelect = lessonCardViewModel::onDurationSelected,\n        onPriceChange = lessonCardViewModel::onPriceChanged,\n        onStatusSelect = lessonCardViewModel::onPaymentStatusSelected,\n        onNoteChange = lessonCardViewModel::onNoteChanged,\n        onSnackbarConsumed = lessonCardViewModel::consumeSnackbar\n    )\n\n    LaunchedEffect(viewModel) {\n        viewModel.events.collect { event ->\n            when (event) {\n                is CalendarEvent.CreateLesson -> creationViewModel.start(\n                    LessonCreationConfig(\r\n                        start = event.start,\r\n                        duration = event.duration,\r\n                        studentId = event.studentId,\r\n                        zoneId = event.start.zone,\r\n                        origin = LessonCreationOrigin.CALENDAR\r\n                    )\r\n                )\r\n                is CalendarEvent.OpenLesson -> lessonCardViewModel.open(event.lessonId)\n            }\n        }\n    }\n\r\n    LaunchedEffect(creationState.snackbarMessage) {\r\n        creationState.snackbarMessage?.let { message ->\r\n            snackbarHostState.showSnackbar(message)\r\n            creationViewModel.consumeSnackbar()\r\n        }\r\n    }\r\n\r\n    LessonCreationSheet(\r\n        state = creationState,\r\n        onDismiss = { creationViewModel.dismiss() },\r\n        onStudentQueryChange = creationViewModel::onStudentQueryChange,\r\n        onStudentSelect = creationViewModel::onStudentSelected,\r\n        onAddStudent = {\r\n            creationViewModel.prepareForStudentCreation()\r\n            creationViewModel.dismiss()\r\n            onAddStudent()\r\n        },\r\n        onSubjectSelect = creationViewModel::onSubjectSelected,\r\n        onDateSelect = creationViewModel::onDateSelected,\r\n        onTimeSelect = creationViewModel::onTimeSelected,\r\n        onDurationChange = creationViewModel::onDurationChanged,\r\n        onPriceChange = creationViewModel::onPriceChanged,\r\n        onNoteChange = creationViewModel::onNoteChanged,\r\n        onSubmit = creationViewModel::submit,\r\n        onConfirmConflict = creationViewModel::confirmConflict,\r\n        onDismissConflict = creationViewModel::dismissConflict\r\n    )\r\n\r\n    val prevPeriod = {\r\n        direction = -1\r\n        viewModel.goToPreviousPeriod()\r\n    }\r\n    val nextPeriod = {\r\n        direction = +1\r\n        viewModel.goToNextPeriod()\r\n    }\r\n\r\n    val swipeModifier = Modifier.pointerInput(mode) {\r\n        val threshold = 48.dp.toPx()\r\n        var totalDrag = 0f\r\n        var handled = false\r\n        detectHorizontalDragGestures(\r\n            onDragStart = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onDragEnd = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onDragCancel = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onHorizontalDrag = { change, dragAmount ->\r\n                if (handled) return@detectHorizontalDragGestures\r\n\r\n                totalDrag += dragAmount\r\n                if (abs(totalDrag) > threshold) {\r\n                    if (totalDrag < 0) nextPeriod() else prevPeriod()\r\n                    handled = true\r\n                    change.consume()\r\n                }\r\n            }\r\n        )\r\n    }\r\n\r\n    Scaffold(\n        modifier = modifier,\n        topBar = {\n            AppTopBar(title = stringResource(id = R.string.calendar_title))\n        },\n        snackbarHost = { SnackbarHost(snackbarHostState) },\n        floatingActionButton = {\n            FloatingActionButton(onClick = {\n                val start = uiState.currentDateTime\n                creationViewModel.start(\n                    LessonCreationConfig(\n                        start = start,\n                        zoneId = uiState.zoneId,\n                        origin = LessonCreationOrigin.CALENDAR\n                    )\n                )\n            }) {\n                Icon(Icons.Filled.Add, contentDescription = null)\n            }\n        }\n    ) { padding ->\n        Column(\n            Modifier\n                .fillMaxSize()\n                .padding(padding)\n        ) {\n        // Хедер: тут же свайп (чтобы не конфликтовал со скроллом списка)\r\n        PlanScreenHeader(\n            anchor = anchor,\n            mode = mode,\n            onModeChange = {\n                direction = 0\n                viewModel.setMode(it)\n            },\n            onPrevPeriod = prevPeriod,\n            onNextPeriod = nextPeriod,\n            onSelectDate = { selected ->\n                direction = when {\n                    selected.isAfter(anchor) -> 1\n                    selected.isBefore(anchor) -> -1\r\n                    else -> 0\r\n                }\r\n                viewModel.selectDate(selected)\r\n            },\r\n            onSwipeLeft = nextPeriod,\r\n            onSwipeRight = prevPeriod\r\n        )\r\n\r\n        // Контент занимает остаток экрана и скроллится внутри\r\n        Box(\r\n            Modifier\r\n                .weight(1f)\r\n                .fillMaxWidth()\r\n                .clipToBounds()\r\n                .then(swipeModifier)   // \uD83D\uDC48 свайп теперь работает по всему экрану\r\n        ) {\r\n            AnimatedContent(\r\n                targetState = anchor,\r\n                modifier = Modifier.fillMaxSize(),\r\n                transitionSpec = {\r\n                    if (direction > 0) {\r\n                        // вперёд (влево)\r\n                        (slideInHorizontally(\r\n                            initialOffsetX = { fullWidth -> fullWidth },\r\n                            animationSpec = tween(durationMillis = 250)\r\n                        ) + fadeIn(animationSpec = tween(250))) togetherWith\r\n                                (slideOutHorizontally(\r\n                                    targetOffsetX = { fullWidth -> -fullWidth / 2 },\r\n                                    animationSpec = tween(durationMillis = 250)\r\n                                ) + fadeOut(animationSpec = tween(250)))\r\n                    } else {\r\n                        // назад (вправо)\r\n                        (slideInHorizontally(\r\n                            initialOffsetX = { fullWidth -> -fullWidth },\r\n                            animationSpec = tween(durationMillis = 250)\r\n                        ) + fadeIn(animationSpec = tween(250))) togetherWith\r\n                                (slideOutHorizontally(\r\n                                    targetOffsetX = { fullWidth -> fullWidth / 2 },\r\n                                    animationSpec = tween(durationMillis = 250)\r\n                                ) + fadeOut(animationSpec = tween(250)))\r\n                    }\r\n                }\r\n                ,\r\n                label = \"day-switch\"\r\n            ) { currentDate ->\r\n                val lessonsForCurrent = remember(currentDate, uiState.lessonsByDate) {\r\n                    uiState.lessonsByDate[currentDate].orEmpty()\r\n                }\r\n                when (mode) {\r\n                    CalendarMode.DAY -> DayTimeline(\r\n                        date = currentDate,\r\n                        lessons = lessonsForCurrent,\r\n                        currentDateTime = uiState.currentDateTime,\r\n                        onLessonClick = { lesson ->\r\n                            lessonCardViewModel.open(lesson.id)\r\n                        },\r\n                        onEmptySlot = { startTime ->\r\n                            viewModel.onEmptySlotSelected(currentDate, startTime, DefaultSlotDuration)\r\n                        }\r\n                    )\r\n                    CalendarMode.WEEK -> WeekMosaic(\n                        anchor = currentDate,\n                        onOpenDay = { selected ->\n                            direction = when {\n                                selected.isAfter(anchor) -> 1\n                                selected.isBefore(anchor) -> -1\n                                else -> 0\n                            }\n                            viewModel.setMode(CalendarMode.DAY)\n                            viewModel.selectDate(selected)\n                        },\n                        dayDataProvider = { date ->\n                            uiState.lessonsByDate[date].orEmpty().map { it.toLessonBrief() }\n                        },\n                        currentDateTime = uiState.currentDateTime,\n                        onLessonClick = { brief -> lessonCardViewModel.open(brief.id) }\n                    )\n                    CalendarMode.MONTH -> MonthCalendar(\n                        anchor = currentDate,\n                        lessonsByDate = uiState.lessonsByDate,\n                        currentDateTime = uiState.currentDateTime,\n                        onDaySelected = { selected ->\n                            direction = when {\n                                selected.isAfter(anchor) -> 1\n                                selected.isBefore(anchor) -> -1\n                                else -> 0\n                            }\n                            viewModel.setMode(CalendarMode.DAY)\n                            viewModel.selectDate(selected)\n                        }\n                    )\n                }\n            }\n        }\n    }\n    }\r\n}\r\n\r\nprivate fun CalendarLesson.toLessonBrief(): LessonBrief {\n    return LessonBrief(\n        id = id,\n        start = start.toLocalTime(),\n        end = end.toLocalTime(),\n        student = studentName,\n        grade = studentGrade,\n        subjectName = subjectName,\n        subjectColorArgb = subjectColorArgb\n    )\n}\n\r\n\n/* ----------------------------- HEADER ----------------------------------- */\n\r\n@Composable\r\nfun PlanScreenHeader(\n    anchor: LocalDate,\n    mode: CalendarMode,\n    onModeChange: (CalendarMode) -> Unit,\n    onPrevPeriod: () -> Unit,\n    onNextPeriod: () -> Unit,\n    onSelectDate: (LocalDate) -> Unit,\n    onSwipeLeft: () -> Unit,\n    onSwipeRight: () -> Unit\n) {\n    Column(\r\n        Modifier\r\n            .fillMaxWidth()\r\n            .padding(horizontal = 16.dp, vertical = 8.dp)\r\n            // свайп только на хедере — не мешает вертикальному скроллу списка\r\n            .pointerInput(mode) {\r\n                val threshold = 48.dp.toPx()\r\n                var totalDrag = 0f\r\n                var handled = false\r\n                detectHorizontalDragGestures(\r\n                    onDragStart = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onDragEnd = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onDragCancel = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onHorizontalDrag = { change, dragAmount ->\r\n                        if (handled) return@detectHorizontalDragGestures\r\n\r\n                        totalDrag += dragAmount\r\n                        if (abs(totalDrag) > threshold) {\r\n                            if (totalDrag < 0) onSwipeLeft() else onSwipeRight()\r\n                            handled = true\r\n                            change.consume()\r\n                        }\r\n                    }\r\n                )\r\n            }\r\n    ) {\r\n        Text(\n            text = anchor.format(DateTimeFormatter.ofPattern(\"LLLL yyyy\", Locale(\"ru\")))\n                .replaceFirstChar { it.titlecase(Locale(\"ru\")) },\n            style = MaterialTheme.typography.titleLarge\n        )\n        TabRow(\r\n            selectedTabIndex = mode.ordinal,\r\n            containerColor = Color.Transparent,\r\n            contentColor = MaterialTheme.colorScheme.primary,\r\n            divider = {}\r\n        ) {\r\n            listOf(\"День\", \"Неделя\", \"Месяц\").forEachIndexed { i, label ->\r\n                Tab(\r\n                    selected = i == mode.ordinal,\r\n                    onClick = { onModeChange(CalendarMode.values()[i]) },\r\n                    text = { Text(label) }\r\n                )\r\n            }\r\n        }\r\n        if (mode == CalendarMode.DAY) {\r\n            DayWeekStrip(\r\n                anchor = anchor,\r\n                onSelect = onSelectDate,\r\n                modifier = Modifier.padding(top = 8.dp)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n/* --------------------------- DAY TIMELINE -------------------------------- */\r\n\r\nprivate val GridColor = Color(0xFFE9F0FF)\r\nprivate val SpineColor = Color(0xFF2D7FF9).copy(alpha = 0.6f)\r\nprivate val LabelWidth = 64.dp\r\nprivate val HourHeight = 64.dp\r\nprivate val DefaultSlotDuration: Duration = Duration.ofMinutes(60)\r\nprivate const val MinutesPerHour: Int = 60\r\nprivate const val LAST_TIMELINE_MINUTE: Int = 23 * MinutesPerHour + 30\r\nprivate const val SlotIncrementMinutes: Int = 30\r\n\r\n@Composable\r\nprivate fun DayTimeline(\r\n    date: LocalDate,\r\n    lessons: List<CalendarLesson>,\r\n    currentDateTime: ZonedDateTime,\r\n    onLessonClick: (CalendarLesson) -> Unit,\r\n    onEmptySlot: (LocalTime) -> Unit\r\n) {\r\n    val dayLessons = remember(date, lessons) { lessons }\r\n    val isToday = remember(date, currentDateTime) { currentDateTime.toLocalDate() == date }\r\n    val (startHour, endHourExclusive) = remember(dayLessons) {\r\n        computeTimelineBounds(dayLessons)\r\n    }\r\n    val hours = remember(startHour, endHourExclusive) {\r\n        (startHour until endHourExclusive).map { \"%02d:00\".format(it) }\r\n    }\r\n    val totalHeight: Dp = HourHeight * hours.size\r\n    val totalMinutes = remember(startHour, endHourExclusive) {\r\n        (endHourExclusive - startHour) * MinutesPerHour\r\n    }\r\n\r\n    val scroll = rememberScrollState()\r\n    val density = LocalDensity.current\r\n    val hourHeightPx = remember(density) { with(density) { HourHeight.toPx() } }\r\n    val labelWidthPx = remember(density) { with(density) { LabelWidth.toPx() } }\r\n    val cardInsetPx = remember(density) { with(density) { 8.dp.toPx() } }\r\n    val totalHeightPx = remember(totalHeight, density) { with(density) { totalHeight.toPx() } }\r\n    val minuteHeight = remember { HourHeight / MinutesPerHour }\r\n    val nowMinutesFromStart = remember(isToday, currentDateTime, startHour) {\r\n        if (!isToday) null else {\r\n            val currentMinutes = currentDateTime.hour * MinutesPerHour + currentDateTime.minute\r\n            currentMinutes - startHour * MinutesPerHour\r\n        }\r\n    }\r\n    val nowBadgeOffset = remember(nowMinutesFromStart, totalMinutes) {\r\n        nowMinutesFromStart?.takeIf { it in 0..totalMinutes }?.let { minutes ->\r\n            minuteHeight * minutes.toFloat()\r\n        }\r\n    }\r\n\r\n    val lessonRegions = remember(dayLessons, startHour, hourHeightPx, labelWidthPx, cardInsetPx) {\r\n        val baseMin = startHour * MinutesPerHour\r\n        dayLessons.map { lesson ->\r\n            val startTime = lesson.start.toLocalTime()\r\n            val startMin = startTime.hour * MinutesPerHour + startTime.minute\r\n            val durationMinutes = lesson.duration.toMinutes().coerceAtLeast(SlotIncrementMinutes.toLong())\r\n            val topPx = ((startMin - baseMin).coerceAtLeast(0)) * hourHeightPx / MinutesPerHour\r\n            val heightPx = durationMinutes.toFloat() * hourHeightPx / MinutesPerHour\r\n            TimelineLessonRegion(\r\n                topPx = topPx,\r\n                bottomPx = topPx + heightPx,\r\n                leftPx = labelWidthPx + cardInsetPx\r\n            )\r\n        }\r\n    }\r\n\r\n    // ВЕСЬ день = одна большая \"простыня\" высотой totalHeight; она вертикально скроллится\r\n    Box(\r\n        Modifier\r\n            .fillMaxSize()\r\n            .verticalScroll(scroll)\r\n    ) {\r\n        // Внутренний контейнер фиксированной высоты = весь день\r\n        Box(\r\n            Modifier\r\n                .fillMaxWidth()\r\n                .height(totalHeight)\r\n                .padding(horizontal = 8.dp)\r\n                .pointerInput(dayLessons, startHour, endHourExclusive, lessonRegions) {\r\n                    detectTapGestures { offset ->\r\n                        if (offset.x < labelWidthPx) return@detectTapGestures\r\n                        if (lessonRegions.any { region -> offset.x >= region.leftPx && offset.y in region.topPx..region.bottomPx }) {\r\n                            return@detectTapGestures\r\n                        }\r\n\r\n                        val clampedY = offset.y.coerceIn(0f, totalHeightPx)\r\n                        val minutesWithin = (clampedY / hourHeightPx) * MinutesPerHour\r\n                        val candidate = (startHour * MinutesPerHour) + minutesWithin.roundToInt()\r\n                        val normalized = candidate.coerceIn(0, LAST_TIMELINE_MINUTE)\r\n                        val rounded = (normalized / SlotIncrementMinutes) * SlotIncrementMinutes\r\n                        val hour = rounded / MinutesPerHour\r\n                        val minute = rounded % MinutesPerHour\r\n                        onEmptySlot(LocalTime.of(hour, minute))\r\n                    }\r\n                }\r\n        ) {\r\n            // 1) Сетка фоном\r\n            Canvas(Modifier.matchParentSize()) {\r\n                val rowH = HourHeight.toPx()\r\n                val leftPad = LabelWidth.toPx()\r\n                val spineW = 2.dp.toPx()\r\n\r\n                repeat(hours.size + 1) { i ->\r\n                    val y = i * rowH\r\n                    drawLine(\r\n                        color = GridColor,\r\n                        start = androidx.compose.ui.geometry.Offset(0f, y),\r\n                        end = androidx.compose.ui.geometry.Offset(size.width, y),\r\n                        strokeWidth = 1.dp.toPx()\r\n                    )\r\n                }\r\n                drawRect(\r\n                    color = SpineColor,\r\n                    topLeft = androidx.compose.ui.geometry.Offset(leftPad, 0f),\r\n                    size = androidx.compose.ui.geometry.Size(spineW, size.height)\r\n                )\r\n                nowMinutesFromStart?.takeIf { it in 0..totalMinutes }?.let { minutes ->\r\n                    val y = minutes * rowH / MinutesPerHour\r\n                    drawLine(\r\n                        color = NowRed,\r\n                        start = androidx.compose.ui.geometry.Offset(0f, y),\r\n                        end = androidx.compose.ui.geometry.Offset(size.width, y),\r\n                        strokeWidth = 2.dp.toPx()\r\n                    )\r\n                }\r\n            }\r\n\r\n            // 2) Уроки — точное позиционирование по времени, до правого края\r\n            dayLessons.forEach { lesson ->\n                LessonBlock(\n                    lesson = lesson,\n                    baseHour = startHour,\n                    hourHeight = HourHeight,\n                    now = currentDateTime,\n                    onLessonClick = onLessonClick\n                )\n            }\n\r\n            // 3) Метки времени слева\r\n            Column(\r\n                Modifier\r\n                    .fillMaxHeight()\r\n                    .width(LabelWidth)\r\n            ) {\r\n                hours.forEach {\r\n                    Box(\r\n                        Modifier\r\n                            .height(HourHeight),\r\n                        contentAlignment = Alignment.TopStart\r\n                    ) {\r\n                        Text(it, style = MaterialTheme.typography.labelLarge)\r\n                    }\r\n                }\r\n            }\r\n\r\n            nowBadgeOffset?.let { offset ->\r\n                val centered = offset - 12.dp\r\n                val badgeOffset = if (centered < 0.dp) 0.dp else centered\r\n                Box(\r\n                    Modifier\r\n                        .fillMaxWidth()\r\n                        .offset(y = badgeOffset)\r\n                ) {\r\n                    NowBadge(\n                        modifier = Modifier\n                            .align(Alignment.CenterStart)\n                            .padding(start = 8.dp)\n                    )\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nprivate data class TimelineLessonRegion(\r\n    val topPx: Float,\r\n    val bottomPx: Float,\r\n    val leftPx: Float\r\n)\r\n\r\n@Composable\r\nprivate fun LessonBlock(\n    lesson: CalendarLesson,\n    baseHour: Int,\n    hourHeight: Dp,\n    now: ZonedDateTime,\n    onLessonClick: (CalendarLesson) -> Unit\n) {\n    val startTime = lesson.start.toLocalTime()\r\n    val endTime = lesson.end.toLocalTime()\r\n    val startMin = startTime.hour * 60 + startTime.minute\r\n    val baseMin = baseHour * 60\r\n    val durationMinutes = lesson.duration.toMinutes().coerceAtLeast(SlotIncrementMinutes.toLong())\r\n\r\n    // Переводим минуты в dp (1 мин = hourHeight/60)\r\n    val minuteDp = hourHeight / 60f\r\n    val top = minuteDp * (startMin - baseMin)\r\n    val height = minuteDp * durationMinutes.toInt()\r\n\r\n    val subject = lesson.subjectName?.takeIf { it.isNotBlank() }?.trim()\n    val grade = lesson.studentGrade?.takeIf { it.isNotBlank() }?.trim()\n    val firstLine = remember(lesson.studentName, subject, grade) {\n        buildString {\n            append(lesson.studentName)\n            val extras = listOfNotNull(subject, grade)\n            if (extras.isNotEmpty()) {\n                append(\" • \")\n                append(extras.joinToString(\" • \"))\n            }\n        }\n    }\n    val statusInfo = lesson.statusPresentation(now)\n    val containerColor = lesson.subjectColorArgb?.let { Color(it).copy(alpha = 0.12f) }\n        ?: MaterialTheme.colorScheme.primary.copy(alpha = 0.08f)\n\n    Box(\n        Modifier\n            .fillMaxWidth()\r\n            .offset(y = top)\r\n            .height(height)\r\n            .padding(start = LabelWidth + 8.dp, end = 8.dp) // от оси до правого края\r\n    ) {\r\n        Card(\n            onClick = { onLessonClick(lesson) },\n            shape = MaterialTheme.shapes.medium,\n            colors = CardDefaults.cardColors(\n                containerColor = containerColor\n            ),\n            modifier = Modifier.fillMaxSize()\n        ) {\n            Column(\n                Modifier\n                    .fillMaxSize()\n                    .padding(12.dp),\n                verticalArrangement = Arrangement.spacedBy(6.dp)\n            ) {\n                Text(\n                    text = firstLine,\n                    style = MaterialTheme.typography.bodyLarge,\n                    maxLines = 2,\n                    overflow = TextOverflow.Ellipsis\n                )\n                Text(\n                    text = statusInfo.text,\n                    style = MaterialTheme.typography.labelLarge,\n                    color = statusInfo.color\n                )\n            }\n        }\n    }\n}\n\r\nprivate data class LessonStatusPresentation(val text: String, val color: Color)\n\n@Composable\nprivate fun CalendarLesson.statusPresentation(now: ZonedDateTime): LessonStatusPresentation {\n    val todayColor = MaterialTheme.colorScheme.primary\n    val paidColor = MaterialTheme.colorScheme.tertiary\n    val dueColor = MaterialTheme.colorScheme.error\n    val cancelledColor = MaterialTheme.colorScheme.outline\n\n    val status = paymentStatus\n    val text: String\n    val color: Color\n\n    if (status == PaymentStatus.CANCELLED) {\n        text = stringResource(R.string.lesson_status_cancelled)\n        color = cancelledColor\n    } else if (now.isBefore(start)) {\n        if (status == PaymentStatus.PAID) {\n            text = stringResource(R.string.calendar_status_prepaid)\n            color = paidColor\n        } else {\n            text = stringResource(R.string.calendar_status_planned)\n            color = todayColor\n        }\n    } else if (now.isAfter(end)) {\n        if (status == PaymentStatus.PAID) {\n            text = stringResource(R.string.lesson_status_paid)\n            color = paidColor\n        } else {\n            text = stringResource(R.string.lesson_status_due)\n            color = dueColor\n        }\n    } else {\n        text = stringResource(R.string.calendar_status_in_progress)\n        color = todayColor\n    }\n\n    return LessonStatusPresentation(text = text, color = color)\n}\n\r\n@Composable\r\nprivate fun NowBadge(modifier: Modifier = Modifier) {\r\n    Surface(\r\n        color = NowRed,\r\n        contentColor = Color.White,\r\n        shape = MaterialTheme.shapes.small,\r\n        modifier = modifier\r\n    ) {\r\n        Text(\r\n            text = stringResource(R.string.calendar_now_badge),\r\n            style = MaterialTheme.typography.labelSmall,\r\n            modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)\r\n        )\r\n    }\r\n}\r\n\r\nprivate fun computeTimelineBounds(lessons: List<CalendarLesson>): Pair<Int, Int> {\r\n    val defaultStart = 9\r\n    val defaultEnd = 21\r\n    if (lessons.isEmpty()) return defaultStart to defaultEnd\r\n\r\n    val earliestMinutes = lessons.minOf { it.start.hour * 60 + it.start.minute }\r\n    val latestMinutes = lessons.maxOf { it.end.hour * 60 + it.end.minute }\r\n    val startHour = min(defaultStart, earliestMinutes / 60)\r\n    val endHourExclusive = max(defaultEnd, ((latestMinutes + 59) / 60))\r\n    return startHour to max(endHourExclusive, startHour + 1)\r\n}\r\n\r\n/* ----------------------------- MONTH GRID -------------------------------- */\n\n@Composable\nprivate fun MonthCalendar(\n    anchor: LocalDate,\n    lessonsByDate: Map<LocalDate, List<CalendarLesson>>,\n    currentDateTime: ZonedDateTime,\n    onDaySelected: (LocalDate) -> Unit\n) {\n    val month = remember(anchor) { YearMonth.from(anchor) }\n    val firstDay = remember(month) { month.atDay(1) }\n    val lastDay = remember(month) { month.atEndOfMonth() }\n    val rangeStart = remember(firstDay) { firstDay.with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY)) }\n    val rangeEnd = remember(lastDay) { lastDay.with(TemporalAdjusters.nextOrSame(DayOfWeek.SUNDAY)) }\n    val days = remember(rangeStart, rangeEnd) {\n        generateSequence(rangeStart) { it.plusDays(1) }\n            .takeWhile { !it.isAfter(rangeEnd) }\n            .toList()\n    }\n    val today = remember(currentDateTime) { currentDateTime.toLocalDate() }\n    val weekDays = remember {\n        listOf(\n            DayOfWeek.MONDAY,\n            DayOfWeek.TUESDAY,\n            DayOfWeek.WEDNESDAY,\n            DayOfWeek.THURSDAY,\n            DayOfWeek.FRIDAY,\n            DayOfWeek.SATURDAY,\n            DayOfWeek.SUNDAY\n        )\n    }\n\n    Column(Modifier.fillMaxSize()) {\n        Row(\n            modifier = Modifier\n                .fillMaxWidth()\n                .padding(horizontal = 12.dp, vertical = 4.dp),\n            horizontalArrangement = Arrangement.SpaceBetween\n        ) {\n            weekDays.forEach { dayOfWeek ->\n                val label = dayOfWeek.getDisplayName(TextStyle.NARROW_STANDALONE, Locale(\"ru\"))\n                    .uppercase(Locale(\"ru\"))\n                Text(\n                    text = label,\n                    style = MaterialTheme.typography.labelSmall,\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\n                    modifier = Modifier.weight(1f),\n                    textAlign = TextAlign.Center\n                )\n            }\n        }\n\n        LazyVerticalGrid(\n            columns = GridCells.Fixed(7),\n            modifier = Modifier.fillMaxSize(),\n            contentPadding = PaddingValues(horizontal = 8.dp, vertical = 8.dp),\n            verticalArrangement = Arrangement.spacedBy(8.dp),\n            horizontalArrangement = Arrangement.spacedBy(8.dp)\n        ) {\n            items(days) { date ->\n                val lessons = lessonsByDate[date].orEmpty()\n                MonthDayCell(\n                    date = date,\n                    inCurrentMonth = date.month == month.month,\n                    isToday = date == today,\n                    lessons = lessons,\n                    onClick = { onDaySelected(date) }\n                )\n            }\n        }\n    }\n}\n\n@Composable\nprivate fun MonthDayCell(\n    date: LocalDate,\n    inCurrentMonth: Boolean,\n    isToday: Boolean,\n    lessons: List<CalendarLesson>,\n    onClick: () -> Unit\n) {\n    val containerColor = when {\n        isToday -> MaterialTheme.colorScheme.primary.copy(alpha = 0.12f)\n        lessons.isNotEmpty() -> MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.35f)\n        else -> Color.Transparent\n    }\n    val border = if (isToday) BorderStroke(1.dp, MaterialTheme.colorScheme.primary) else null\n    val contentColor = if (inCurrentMonth) {\n        MaterialTheme.colorScheme.onSurface\n    } else {\n        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f)\n    }\n\n    Surface(\n        color = containerColor,\n        shape = MaterialTheme.shapes.medium,\n        border = border,\n        modifier = Modifier\n            .aspectRatio(1f)\n            .clip(MaterialTheme.shapes.medium)\n            .clickable(onClick = onClick)\n    ) {\n        Column(\n            modifier = Modifier\n                .fillMaxSize()\n                .padding(8.dp),\n            verticalArrangement = Arrangement.SpaceBetween\n        ) {\n            Text(\n                text = date.dayOfMonth.toString(),\n                style = MaterialTheme.typography.bodyMedium,\n                color = contentColor\n            )\n            if (lessons.isNotEmpty()) {\n                Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {\n                    lessons.take(2).forEach { lesson ->\n                        Text(\n                            text = lesson.studentName,\n                            style = MaterialTheme.typography.labelSmall,\n                            color = contentColor,\n                            maxLines = 1,\n                            overflow = TextOverflow.Ellipsis\n                        )\n                    }\n                    val remaining = lessons.size - min(lessons.size, 2)\n                    if (remaining > 0) {\n                        Text(\n                            text = \"+$remaining\",\n                            style = MaterialTheme.typography.labelSmall,\n                            color = contentColor.copy(alpha = 0.8f)\n                        )\n                    }\n                }\n            }\n        }\n    }\n}\n\r\n/* --------------------------- DAY/WEEK STRIP ------------------------------ */\r\n\r\n@Composable\r\nfun DayWeekStrip(\r\n    anchor: LocalDate,\r\n    onSelect: (LocalDate) -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val monday = anchor.with(DayOfWeek.MONDAY)\r\n    val days = remember(monday) { (0..6).map { monday.plusDays(it.toLong()) } }\r\n\r\n    Row(modifier.padding(top = 8.dp)) {\r\n        days.forEachIndexed { idx, d ->\r\n            val selected = d == anchor\r\n            DayTwoLineChip(\r\n                date = d,\r\n                selected = selected,\r\n                onClick = { onSelect(d) },\r\n                modifier = Modifier\r\n                    .weight(1f)\r\n                    .height(48.dp)\r\n                    .then(if (idx < days.lastIndex) Modifier.padding(end = 8.dp) else Modifier)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun DayTwoLineChip(\r\n    date: LocalDate,\r\n    selected: Boolean,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val bg = if (selected) Color(0x1A2D7FF9) else Color(0xFFF2F3F7)\r\n    val fg = if (selected) Color(0xFF2D7FF9) else MaterialTheme.colorScheme.onSurface.copy(alpha = 0.8f)\r\n    Surface(\r\n        color = bg,\r\n        shape = MaterialTheme.shapes.medium,\r\n        onClick = onClick,\r\n        modifier = modifier\r\n    ) {\r\n        Column(\r\n            Modifier\r\n                .fillMaxSize()\r\n                .padding(horizontal = 8.dp),\r\n            horizontalAlignment = Alignment.CenterHorizontally,\r\n            verticalArrangement = Arrangement.Center\r\n        ) {\r\n            Text(\r\n                date.dayOfWeek.getDisplayName(TextStyle.SHORT, Locale(\"ru\"))\r\n                    .replaceFirstChar { it.titlecase(Locale(\"ru\")) },\r\n                style = MaterialTheme.typography.labelSmall,\r\n                color = fg\r\n            )\r\n            Text(\r\n                \"${date.dayOfMonth}\",\r\n                style = MaterialTheme.typography.labelLarge,\r\n                color = fg\r\n            )\r\n        }\r\n    }\r\n}\r\n
-Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
-<+>UTF-8
-===================================================================
-diff --git a/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt b/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt
---- a/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt	(revision c4c1b979c040baf0a45ebe7efb2089e930ba38fb)
-+++ b/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt	(date 1760137159324)
-@@ -10,6 +10,7 @@
- import androidx.compose.animation.togetherWith
- import androidx.compose.foundation.BorderStroke
- import androidx.compose.foundation.Canvas
-+import androidx.compose.foundation.clickable
- import androidx.compose.foundation.gestures.detectHorizontalDragGestures
- import androidx.compose.foundation.gestures.detectTapGestures
- import androidx.compose.foundation.layout.*
-@@ -25,6 +26,7 @@
- import androidx.compose.runtime.collectAsState
- import androidx.compose.ui.Alignment
- import androidx.compose.ui.Modifier
-+import androidx.compose.ui.draw.clip
- import androidx.compose.ui.draw.clipToBounds
- import androidx.compose.ui.graphics.Color
- import androidx.compose.ui.input.pointer.pointerInput
-Index: app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt
-IDEA additional info:
-Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
-<+>package com.tutorly.ui.screens\r\n\r\nimport androidx.compose.foundation.BorderStroke\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.horizontalScroll\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.Column\r\nimport androidx.compose.foundation.layout.PaddingValues\r\nimport androidx.compose.foundation.layout.Row\r\nimport androidx.compose.foundation.layout.Spacer\r\nimport androidx.compose.foundation.layout.fillMaxSize\r\nimport androidx.compose.foundation.layout.fillMaxWidth\r\nimport androidx.compose.foundation.layout.height\r\nimport androidx.compose.foundation.layout.navigationBarsPadding\r\nimport androidx.compose.foundation.layout.imePadding\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.layout.size\r\nimport androidx.compose.foundation.layout.width\r\nimport androidx.compose.foundation.lazy.LazyColumn\r\nimport androidx.compose.foundation.lazy.items\r\nimport androidx.compose.foundation.lazy.rememberLazyListState\r\nimport androidx.compose.foundation.shape.CircleShape\r\nimport androidx.compose.material.icons.Icons\r\nimport androidx.compose.material.icons.filled.Add\r\nimport androidx.compose.material.icons.filled.Edit\r\nimport androidx.compose.material.icons.filled.Search\r\nimport androidx.compose.material.icons.outlined.Email\r\nimport androidx.compose.material.icons.outlined.Phone\r\nimport androidx.compose.material3.Button\r\nimport androidx.compose.material3.Card\r\nimport androidx.compose.material3.CardDefaults\r\nimport androidx.compose.material3.CircularProgressIndicator\r\nimport androidx.compose.material3.ExtendedFloatingActionButton\r\nimport androidx.compose.material3.ExperimentalMaterial3Api\r\nimport androidx.compose.material3.FloatingActionButton\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.ModalBottomSheet\r\nimport androidx.compose.material3.OutlinedButton\r\nimport androidx.compose.material3.OutlinedTextField\r\nimport androidx.compose.material3.Scaffold\r\nimport androidx.compose.material3.SnackbarHost\r\nimport androidx.compose.material3.SnackbarHostState\r\nimport androidx.compose.material3.Surface\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.material3.IconButton\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.foundation.rememberScrollState\r\nimport androidx.compose.runtime.rememberCoroutineScope\r\nimport androidx.compose.runtime.saveable.rememberSaveable\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.draw.clip\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.style.TextAlign\r\nimport androidx.compose.ui.text.style.TextOverflow\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.compose.ui.unit.Dp\r\nimport androidx.hilt.navigation.compose.hiltViewModel\r\nimport androidx.compose.material3.BottomSheetDefaults\r\nimport androidx.compose.material3.rememberModalBottomSheetState\r\nimport androidx.compose.runtime.LaunchedEffect\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.setValue\r\nimport com.tutorly.R\r\nimport com.tutorly.domain.model.StudentProfile\r\nimport com.tutorly.domain.model.StudentProfileLesson\r\nimport com.tutorly.models.PaymentStatus\r\nimport com.tutorly.ui.lessoncard.LessonCardSheet\r\nimport com.tutorly.ui.lessoncard.LessonCardViewModel\r\nimport com.tutorly.ui.components.PaymentBadge\r\nimport kotlinx.coroutines.launch\r\nimport java.text.NumberFormat\r\nimport java.time.ZoneId\r\nimport java.time.YearMonth\r\nimport java.time.format.DateTimeFormatter\r\nimport java.util.Currency\r\nimport java.util.Locale\r\n\r\n@OptIn(ExperimentalMaterial3Api::class)\r\n@Composable\r\nfun StudentsScreen(\r\n    onStudentEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onStudentCreatedFromLesson: (Long) -> Unit = {},\r\n    initialEditorOrigin: StudentEditorOrigin = StudentEditorOrigin.NONE,\r\n    modifier: Modifier = Modifier,\r\n    vm: StudentsViewModel = hiltViewModel(),\r\n) {\r\n    val query by vm.query.collectAsState()\r\n    val students by vm.students.collectAsState()\r\n    val formState by vm.editorFormState.collectAsState()\r\n    val profileUiState by vm.profileUiState.collectAsState()\r\n    val lessonCardViewModel: LessonCardViewModel = hiltViewModel()\r\n    val lessonCardState by lessonCardViewModel.uiState.collectAsState()\r\n    LessonCardSheet(\r\n        state = lessonCardState,\r\n        onDismissRequest = lessonCardViewModel::dismiss,\r\n        onStudentSelect = lessonCardViewModel::onStudentSelected,\r\n        onDateSelect = lessonCardViewModel::onDateSelected,\r\n        onTimeSelect = lessonCardViewModel::onTimeSelected,\r\n        onDurationSelect = lessonCardViewModel::onDurationSelected,\r\n        onPriceChange = lessonCardViewModel::onPriceChanged,\r\n        onStatusSelect = lessonCardViewModel::onPaymentStatusSelected,\r\n        onNoteChange = lessonCardViewModel::onNoteChanged,\r\n        onSnackbarConsumed = lessonCardViewModel::consumeSnackbar\r\n    )\r\n\r\n    val snackbarHostState = remember { SnackbarHostState() }\r\n    val coroutineScope = rememberCoroutineScope()\r\n    val context = LocalContext.current\r\n    val editorSheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)\r\n    val profileSheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)\r\n    var showEditor by rememberSaveable { mutableStateOf(false) }\r\n    var editorOrigin by rememberSaveable { mutableStateOf(StudentEditorOrigin.NONE) }\r\n    var pendingProfileId by remember { mutableStateOf<Long?>(null) }\r\n\r\n    val openCreationEditor: (StudentEditorOrigin) -> Unit = { origin ->\r\n        editorOrigin = origin\r\n        pendingProfileId = null\r\n        vm.startStudentCreation()\r\n        showEditor = true\r\n    }\r\n\r\n    LaunchedEffect(initialEditorOrigin) {\r\n        if (initialEditorOrigin != StudentEditorOrigin.NONE) {\r\n            editorOrigin = initialEditorOrigin\r\n            pendingProfileId = null\r\n            vm.startStudentCreation()\r\n            showEditor = true\r\n        }\r\n    }\r\n\r\n    val closeEditor = {\r\n        showEditor = false\r\n        vm.resetStudentForm()\r\n        editorOrigin = StudentEditorOrigin.NONE\r\n    }\r\n\r\n    val handleSave = {\r\n        if (!formState.isSaving) {\r\n            vm.submitStudent(\r\n                onSuccess = { id, name, isNew ->\r\n                    closeEditor()\r\n                    val message = if (isNew) {\r\n                        context.getString(R.string.student_added_message, name)\r\n                    } else {\r\n                        context.getString(R.string.student_updated_message, name)\r\n                    }\r\n                    coroutineScope.launch { snackbarHostState.showSnackbar(message) }\r\n                    if (isNew) {\r\n                        if (editorOrigin == StudentEditorOrigin.LESSON_CREATION) {\r\n                            onStudentCreatedFromLesson(id)\r\n                        }\r\n                    } else {\r\n                        pendingProfileId?.let { vm.openStudentProfile(it) }\r\n                    }\r\n                    pendingProfileId = null\r\n                },\r\n                onError = { error ->\r\n                    val message = if (error.isNotBlank()) {\r\n                        error\r\n                    } else {\r\n                        context.getString(R.string.student_editor_save_error)\r\n                    }\r\n                    coroutineScope.launch { snackbarHostState.showSnackbar(message) }\r\n                }\r\n            )\r\n        }\r\n    }\r\n\r\n    Scaffold(\r\n        modifier = modifier,\r\n        snackbarHost = { SnackbarHost(hostState = snackbarHostState) },\r\n        containerColor = MaterialTheme.colorScheme.surface,\r\n        floatingActionButton = {\r\n            FloatingActionButton(\r\n                onClick = { openCreationEditor(StudentEditorOrigin.STUDENTS) },\r\n                containerColor = MaterialTheme.colorScheme.primary,\r\n                contentColor = MaterialTheme.colorScheme.onPrimary\r\n            ) {\r\n                Icon(\r\n                    imageVector = Icons.Default.Add,\r\n                    contentDescription = stringResource(id = R.string.add_student)\r\n                )\r\n            }\r\n        }\r\n    ) { innerPadding ->\r\n        Column(\r\n            modifier\r\n                .fillMaxSize()\r\n                .padding(innerPadding)\r\n                .padding(horizontal = 16.dp, vertical = 12.dp)\r\n        ) {\r\n            OutlinedTextField(\r\n                value = query,\r\n                onValueChange = vm::onQueryChange,\r\n                modifier = Modifier.fillMaxWidth(),\r\n                singleLine = true,\r\n                leadingIcon = { Icon(Icons.Default.Search, contentDescription = null) },\r\n                placeholder = { Text(text = stringResource(id = R.string.search_students_hint)) },\r\n                shape = MaterialTheme.shapes.large\r\n            )\r\n\r\n            Spacer(Modifier.height(16.dp))\r\n\r\n            if (students.isEmpty()) {\r\n                EmptyStudentsState(Modifier.fillMaxSize())\r\n            } else {\r\n                LazyColumn(\r\n                    modifier = Modifier.fillMaxSize(),\r\n                    verticalArrangement = Arrangement.spacedBy(12.dp),\r\n                    contentPadding = PaddingValues(bottom = 16.dp)\r\n                ) {\r\n                    items(\r\n                        items = students,\r\n                        key = { it.student.id }\r\n                    ) { item ->\r\n                        StudentCard(\r\n                            item = item,\r\n                            onClick = { vm.openStudentProfile(item.student.id) }\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if (showEditor) {\r\n        ModalBottomSheet(\r\n            onDismissRequest = {\r\n                if (!formState.isSaving) {\r\n                    pendingProfileId = null\r\n                    closeEditor()\r\n                }\r\n            },\r\n            sheetState = editorSheetState,\r\n            dragHandle = { BottomSheetDefaults.DragHandle() }\r\n        ) {\r\n            StudentEditorSheet(\r\n                state = formState,\r\n                onNameChange = vm::onEditorNameChange,\r\n                onPhoneChange = vm::onEditorPhoneChange,\r\n                onMessengerChange = vm::onEditorMessengerChange,\r\n                onRateChange = vm::onEditorRateChange,\r\n                onSubjectChange = vm::onEditorSubjectChange,\r\n                onGradeChange = vm::onEditorGradeChange,\r\n                onNoteChange = vm::onEditorNoteChange,\r\n                onArchivedChange = vm::onEditorArchivedChange,\r\n                onActiveChange = vm::onEditorActiveChange,\r\n                onCancel = {\r\n                    if (!formState.isSaving) {\r\n                        pendingProfileId = null\r\n                        closeEditor()\r\n                    }\r\n                },\r\n                onSave = handleSave\r\n            )\r\n        }\r\n    }\r\n\r\n    if (profileUiState !is StudentProfileUiState.Hidden) {\r\n        ModalBottomSheet(\r\n            onDismissRequest = vm::clearSelectedStudent,\r\n            sheetState = profileSheetState,\r\n            dragHandle = { BottomSheetDefaults.DragHandle() }\r\n        ) {\r\n            StudentProfileSheet(\r\n                state = profileUiState,\r\n                onClose = vm::clearSelectedStudent,\r\n                onEdit = { studentId ->\r\n                    val profileStudent = (profileUiState as? StudentProfileUiState.Content)?.profile?.student\r\n                    if (profileStudent != null && profileStudent.id == studentId) {\r\n                        vm.clearSelectedStudent()\r\n                        editorOrigin = StudentEditorOrigin.STUDENTS\r\n                        pendingProfileId = studentId\r\n                        vm.startStudentEdit(profileStudent)\r\n                        showEditor = true\r\n                    } else {\r\n                        vm.clearSelectedStudent()\r\n                        onStudentEdit(studentId)\r\n                    }\r\n                },\r\n                onAddLesson = { studentId ->\r\n                    vm.clearSelectedStudent()\r\n                    onAddLesson(studentId)\r\n                },\r\n                onLessonClick = { lessonId ->\r\n                    vm.clearSelectedStudent()\r\n                    lessonCardViewModel.open(lessonId)\r\n                }\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentEditorSheet(\r\n    state: StudentEditorFormState,\r\n    onNameChange: (String) -> Unit,\r\n    onPhoneChange: (String) -> Unit,\r\n    onMessengerChange: (String) -> Unit,\r\n    onRateChange: (String) -> Unit,\r\n    onSubjectChange: (String) -> Unit,\r\n    onGradeChange: (String) -> Unit,\r\n    onNoteChange: (String) -> Unit,\r\n    onArchivedChange: (Boolean) -> Unit,\r\n    onActiveChange: (Boolean) -> Unit,\r\n    onCancel: () -> Unit,\r\n    onSave: () -> Unit,\r\n) {\r\n    val isEditing = state.studentId != null\r\n    Column(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .navigationBarsPadding()\r\n            .imePadding()\r\n            .padding(horizontal = 24.dp, vertical = 16.dp),\r\n        verticalArrangement = Arrangement.spacedBy(20.dp)\r\n    ) {\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.SpaceBetween,\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            Text(\r\n                text = stringResource(\r\n                    id = if (isEditing) R.string.student_editor_edit_title else R.string.add_student\r\n                ),\r\n                style = MaterialTheme.typography.titleLarge\r\n            )\r\n            IconButton(onClick = onCancel, enabled = !state.isSaving) {\r\n                Icon(\r\n                    imageVector = Icons.Default.Close,\r\n                    contentDescription = stringResource(id = R.string.student_editor_close)\r\n                )\r\n            }\r\n        }\r\n\r\n        StudentEditorForm(\r\n            state = state,\r\n            onNameChange = onNameChange,\r\n            onPhoneChange = onPhoneChange,\r\n            onMessengerChange = onMessengerChange,\r\n            onRateChange = onRateChange,\r\n            onSubjectChange = onSubjectChange,\r\n            onGradeChange = onGradeChange,\r\n            onNoteChange = onNoteChange,\r\n            onArchivedChange = onArchivedChange,\r\n            onActiveChange = onActiveChange,\r\n            modifier = Modifier\r\n                .weight(1f, fill = false)\r\n                .fillMaxWidth(),\r\n            focusOnStart = true,\r\n            enabled = !state.isSaving,\r\n            onSubmit = onSave\r\n        )\r\n\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            OutlinedButton(\r\n                onClick = onCancel,\r\n                modifier = Modifier.weight(1f),\r\n                enabled = !state.isSaving\r\n            ) {\r\n                Text(text = stringResource(id = R.string.student_editor_cancel))\r\n            }\r\n\r\n            Button(\r\n                onClick = onSave,\r\n                modifier = Modifier.weight(1f),\r\n                enabled = !state.isSaving && state.name.isNotBlank()\r\n            ) {\r\n                if (state.isSaving) {\r\n                    CircularProgressIndicator(\r\n                        modifier = Modifier.size(20.dp),\r\n                        strokeWidth = 2.dp\r\n                    )\r\n                } else {\r\n                    Text(\r\n                        text = stringResource(id = R.string.student_editor_save)\r\n                    )\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun EmptyStudentsState(modifier: Modifier = Modifier) {\r\n    Box(modifier, contentAlignment = Alignment.Center) {\r\n        Text(\r\n            text = stringResource(id = R.string.students_empty_state),\r\n            style = MaterialTheme.typography.bodyMedium\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentCard(\r\n    item: StudentsViewModel.StudentListItem,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier,\r\n) {\r\n    val currencyFormatter = remember {\r\n        NumberFormat.getCurrencyInstance(Locale(\"ru\", \"RU\")).apply {\r\n            currency = Currency.getInstance(\"RUB\")\r\n        }\r\n    }\r\n    val subject = item.profile.subject?.takeIf { it.isNotBlank() }?.trim()\r\n    val grade = item.profile.grade?.takeIf { it.isNotBlank() }?.trim()\r\n    val rate = item.profile.rate?.let { formatCurrency(it.priceCents.toLong(), currencyFormatter) }\r\n    val subtitle = listOfNotNull(subject, grade, rate)\r\n        .joinToString(separator = \" • \")\r\n        .takeIf { it.isNotBlank() }\r\n\r\n    val phone = item.student.phone?.takeIf { it.isNotBlank() }?.trim()\r\n    val email = item.student.messenger?.takeIf { it.isNotBlank() }?.trim()\r\n    val showTrailingRow = phone != null || email != null || item.hasDebt\r\n\r\n    Card(\r\n        onClick = onClick,\r\n        modifier = modifier.fillMaxWidth(),\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),\r\n        border = BorderStroke(1.dp, MaterialTheme.colorScheme.outlineVariant),\r\n        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)\r\n    ) {\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 16.dp, vertical = 12.dp),\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            StudentAvatar(name = item.student.name, size = 48.dp)\r\n            Spacer(Modifier.width(12.dp))\r\n            Column(\r\n                modifier = Modifier.weight(1f),\r\n                verticalArrangement = Arrangement.spacedBy(4.dp)\r\n            ) {\r\n                Text(\r\n                    text = item.student.name,\r\n                    style = MaterialTheme.typography.titleMedium,\r\n                    fontWeight = FontWeight.Medium,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n                subtitle?.let {\r\n                    Text(\r\n                        text = it,\r\n                        style = MaterialTheme.typography.bodySmall,\r\n                        color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                        maxLines = 1,\r\n                        overflow = TextOverflow.Ellipsis\r\n                    )\r\n                }\r\n                if (showTrailingRow) {\r\n                    Row(\r\n                        modifier = Modifier\r\n                            .fillMaxWidth()\r\n                            .padding(top = 4.dp),\r\n                        horizontalArrangement = Arrangement.End,\r\n                        verticalAlignment = Alignment.CenterVertically\r\n                    ) {\r\n                        if (phone != null) {\r\n                            Icon(\r\n                                imageVector = Icons.Outlined.Phone,\r\n                                contentDescription = phone,\r\n                                tint = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                                modifier = Modifier.size(18.dp)\r\n                            )\r\n                        }\r\n                        if (email != null) {\r\n                            if (phone != null) {\r\n                                Spacer(Modifier.width(12.dp))\r\n                            }\r\n                            Icon(\r\n                                imageVector = Icons.Outlined.Email,\r\n                                contentDescription = email,\r\n                                tint = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                                modifier = Modifier.size(18.dp)\r\n                            )\r\n                        }\r\n                        if (item.hasDebt) {\r\n                            if (phone != null || email != null) {\r\n                                Spacer(Modifier.width(12.dp))\r\n                            }\r\n                            PaymentBadge(paid = false)\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nfun StudentProfileSheet(\r\n    state: StudentProfileUiState,\r\n    onClose: () -> Unit,\r\n    onEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onLessonClick: (Long) -> Unit,\r\n    onCall: ((String) -> Unit)? = null,\r\n    onMessage: ((String) -> Unit)? = null,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    when (state) {\r\n        StudentProfileUiState.Hidden -> Unit\r\n        StudentProfileUiState.Loading -> {\r\n            Box(\r\n                modifier = modifier\r\n                    .fillMaxWidth()\r\n                    .padding(vertical = 48.dp),\r\n                contentAlignment = Alignment.Center\r\n            ) {\r\n                CircularProgressIndicator()\r\n            }\r\n        }\r\n\r\n        StudentProfileUiState.Error -> {\r\n            Column(\r\n                modifier = modifier\r\n                    .fillMaxWidth()\r\n                    .padding(horizontal = 24.dp, vertical = 32.dp),\r\n                verticalArrangement = Arrangement.spacedBy(16.dp),\r\n                horizontalAlignment = Alignment.CenterHorizontally\r\n            ) {\r\n                Text(\r\n                    text = stringResource(id = R.string.student_profile_error),\r\n                    style = MaterialTheme.typography.bodyLarge,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    textAlign = TextAlign.Center\r\n                )\r\n                Button(onClick = onClose) {\r\n                    Text(text = stringResource(id = R.string.student_editor_close))\r\n                }\r\n            }\r\n        }\r\n\r\n        is StudentProfileUiState.Content -> {\r\n            StudentProfileContent(\r\n                profile = state.profile,\r\n                onEdit = onEdit,\r\n                onAddLesson = onAddLesson,\r\n                onLessonClick = onLessonClick,\r\n                onCall = onCall,\r\n                onMessage = onMessage,\r\n                modifier = modifier\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileContent(\r\n    profile: StudentProfile,\r\n    onEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onLessonClick: (Long) -> Unit,\r\n    onCall: ((String) -> Unit)?,\r\n    onMessage: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val listState = rememberLazyListState()\r\n    val locale = remember { Locale(\"ru\", \"RU\") }\r\n    val currencyFormatter = remember(locale) {\r\n        NumberFormat.getCurrencyInstance(locale).apply {\r\n            currency = Currency.getInstance(\"RUB\")\r\n        }\r\n    }\r\n    val zoneId = remember { ZoneId.systemDefault() }\r\n    val dateFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"d MMMM yyyy\", locale) }\r\n    val timeFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"HH:mm\", locale) }\r\n    val monthFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"LLLL yyyy\", locale) }\r\n\r\n    val groupedLessons = remember(profile.recentLessons, zoneId) {\r\n        val sorted = profile.recentLessons.sortedByDescending { it.startAt }\r\n        val groups = linkedMapOf<YearMonth, MutableList<StudentProfileLesson>>()\r\n        sorted.forEach { lesson ->\r\n            val key = YearMonth.from(lesson.startAt.atZone(zoneId))\r\n            groups.getOrPut(key) { mutableListOf() }.add(lesson)\r\n        }\r\n        groups.map { it.key to it.value.toList() }\r\n    }\r\n\r\n    Box(modifier = modifier.fillMaxWidth()) {\r\n        LazyColumn(\r\n            state = listState,\r\n            modifier = Modifier.fillMaxWidth(),\r\n            contentPadding = PaddingValues(start = 20.dp, end = 20.dp, top = 16.dp, bottom = 140.dp),\r\n            verticalArrangement = Arrangement.spacedBy(20.dp)\r\n        ) {\r\n            item {\r\n                StudentProfileHeader(\r\n                    profile = profile,\r\n                    onEdit = onEdit,\r\n                    currencyFormatter = currencyFormatter\r\n                )\r\n            }\r\n            item {\r\n                StudentProfileContacts(\r\n                    profile = profile,\r\n                    onCall = onCall,\r\n                    onMessage = onMessage\r\n                )\r\n            }\r\n            item {\r\n                StudentProfileMetricsSection(\r\n                    profile = profile,\r\n                    currencyFormatter = currencyFormatter\r\n                )\r\n            }\r\n            item {\r\n                Text(\r\n                    text = stringResource(id = R.string.student_details_history_title),\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n            if (profile.recentLessons.isEmpty()) {\r\n                item {\r\n                    StudentProfileEmptyHistory(\r\n                        onAddLesson = { onAddLesson(profile.student.id) }\r\n                    )\r\n                }\r\n            } else {\r\n                groupedLessons.forEach { (month, lessons) ->\r\n                    item(key = \"month-$month\") {\r\n                        val monthTitle = remember(month) {\r\n                            month.format(monthFormatter).replaceFirstChar { char ->\r\n                                if (char.isLowerCase()) char.titlecase(locale) else char.toString()\r\n                            }\r\n                        }\r\n                        Text(\r\n                            text = monthTitle,\r\n                            style = MaterialTheme.typography.titleSmall,\r\n                            color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                            modifier = Modifier.padding(top = 4.dp, bottom = 8.dp)\r\n                        )\r\n                    }\r\n                    items(lessons, key = { it.id }) { lesson ->\r\n                        StudentProfileLessonCard(\r\n                            lesson = lesson,\r\n                            fallbackSubject = profile.subject,\r\n                            currencyFormatter = currencyFormatter,\r\n                            zoneId = zoneId,\r\n                            dateFormatter = dateFormatter,\r\n                            timeFormatter = timeFormatter,\r\n                            onClick = { onLessonClick(lesson.id) }\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        ExtendedFloatingActionButton(\r\n            onClick = { onAddLesson(profile.student.id) },\r\n            icon = { Icon(imageVector = Icons.Filled.Add, contentDescription = null) },\r\n            text = { Text(text = stringResource(id = R.string.student_details_create_lesson)) },\r\n            modifier = Modifier\r\n                .align(Alignment.BottomEnd)\r\n                .padding(horizontal = 20.dp, vertical = 16.dp)\r\n                .navigationBarsPadding()\r\n        )\r\n    }\r\n}\r\n\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileHeader(\r\n    profile: StudentProfile,\r\n    onEdit: (Long) -> Unit,\r\n    currencyFormatter: NumberFormat,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Row(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalAlignment = Alignment.CenterVertically,\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        StudentAvatar(name = profile.student.name, size = 64.dp)\r\n        Column(\r\n            modifier = Modifier.weight(1f),\r\n            verticalArrangement = Arrangement.spacedBy(6.dp)\r\n        ) {\r\n            Text(\r\n                text = profile.student.name,\r\n                style = MaterialTheme.typography.headlineSmall,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            val subject = profile.subject?.takeIf { it.isNotBlank() }?.trim()\r\n            val grade = profile.grade?.takeIf { it.isNotBlank() }?.trim()\r\n            val details = listOfNotNull(subject, grade).joinToString(separator = \" \")\r\n            if (details.isNotEmpty()) {\r\n                Text(\r\n                    text = details,\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    maxLines = 2,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n            }\r\n            val rateText = profile.rate?.let { rate ->\r\n                val price = formatCurrency(rate.priceCents.toLong(), currencyFormatter)\r\n                if (rate.durationMinutes > 0) {\r\n                    \"$price • ${rate.durationMinutes} мин\"\r\n                } else {\r\n                    price\r\n                }\r\n            } ?: profile.student.rateCents?.takeIf { it > 0 }?.let { cents ->\r\n                formatCurrency(cents.toLong(), currencyFormatter)\r\n            }\r\n            if (!rateText.isNullOrBlank()) {\r\n                Text(\r\n                    text = rateText,\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            }\r\n        }\r\n        IconButton(onClick = { onEdit(profile.student.id) }) {\r\n            Icon(\r\n                imageVector = Icons.Filled.Edit,\r\n                contentDescription = stringResource(id = R.string.student_details_edit)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileContacts(\r\n    profile: StudentProfile,\r\n    onCall: ((String) -> Unit)?,\r\n    onMessage: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Column(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        Text(\r\n            text = stringResource(id = R.string.student_details_contact_title),\r\n            style = MaterialTheme.typography.titleMedium\r\n        )\r\n        ProfileContactRow(\r\n            icon = Icons.Outlined.Phone,\r\n            label = stringResource(id = R.string.student_profile_contact_call),\r\n            value = profile.student.phone,\r\n            onClick = onCall\r\n        )\r\n        ProfileContactRow(\r\n            icon = Icons.Outlined.Email,\r\n            label = stringResource(id = R.string.student_profile_contact_message),\r\n            value = profile.student.messenger,\r\n            onClick = onMessage\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun ProfileContactRow(\r\n    icon: androidx.compose.ui.graphics.vector.ImageVector,\r\n    label: String,\r\n    value: String?,\r\n    onClick: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val hasValue = !value.isNullOrBlank()\r\n    val displayValue = value?.takeIf { it.isNotBlank() }\r\n        ?: stringResource(id = R.string.student_profile_contact_placeholder)\r\n    val background = if (hasValue) {\r\n        MaterialTheme.colorScheme.surfaceVariant\r\n    } else {\r\n        MaterialTheme.colorScheme.surfaceContainerHighest\r\n    }\r\n    val contentColor = if (hasValue) {\r\n        MaterialTheme.colorScheme.onSurface\r\n    } else {\r\n        MaterialTheme.colorScheme.onSurfaceVariant\r\n    }\r\n\r\n    Row(\r\n        modifier = modifier\r\n            .fillMaxWidth()\r\n            .clip(MaterialTheme.shapes.large)\r\n            .background(background)\r\n            .clickable(enabled = hasValue && onClick != null) {\r\n                value?.let { onClick?.invoke(it) }\r\n            }\r\n            .padding(horizontal = 16.dp, vertical = 14.dp),\r\n        verticalAlignment = Alignment.CenterVertically,\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        Icon(\r\n            imageVector = icon,\r\n            contentDescription = null,\r\n            tint = if (hasValue) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n        Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {\r\n            Text(\r\n                text = label,\r\n                style = MaterialTheme.typography.bodySmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Text(\r\n                text = displayValue,\r\n                style = MaterialTheme.typography.bodyMedium,\r\n                color = contentColor,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileMetricsSection(\r\n    profile: StudentProfile,\r\n    currencyFormatter: NumberFormat,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val scrollState = rememberScrollState()\r\n    val metrics = profile.metrics\r\n    val totalLessons = metrics.totalLessons.toString()\r\n    val totalPaid = formatCurrency(metrics.totalPaidCents, currencyFormatter)\r\n    val paidLessons = metrics.paidLessons.toString()\r\n    val debtText = if (metrics.outstandingCents > 0) {\r\n        formatCurrency(metrics.outstandingCents, currencyFormatter)\r\n    } else {\r\n        stringResource(id = R.string.student_details_no_debt)\r\n    }\r\n\r\n    Column(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        Text(\r\n            text = stringResource(id = R.string.student_profile_metrics_title),\r\n            style = MaterialTheme.typography.titleMedium\r\n        )\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .horizontalScroll(scrollState),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_lessons),\r\n                value = totalLessons\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_paid),\r\n                value = totalPaid\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_paid_lessons),\r\n                value = paidLessons\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_debt),\r\n                value = debtText,\r\n                badge = if (profile.hasDebt) {\r\n                    {\r\n                        PaymentBadge(paid = false)\r\n                    }\r\n                } else {\r\n                    null\r\n                }\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun ProfileMetricCard(\r\n    label: String,\r\n    value: String,\r\n    modifier: Modifier = Modifier,\r\n    badge: (@Composable () -> Unit)? = null\r\n) {\r\n    Surface(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 2.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 16.dp, vertical = 12.dp),\r\n            verticalArrangement = Arrangement.spacedBy(6.dp)\r\n        ) {\r\n            Text(\r\n                text = label,\r\n                style = MaterialTheme.typography.labelMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            if (badge != null) {\r\n                Row(\r\n                    verticalAlignment = Alignment.CenterVertically,\r\n                    horizontalArrangement = Arrangement.spacedBy(8.dp)\r\n                ) {\r\n                    badge()\r\n                    Text(\r\n                        text = value,\r\n                        style = MaterialTheme.typography.bodyMedium\r\n                    )\r\n                }\r\n            } else {\r\n                Text(\r\n                    text = value,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentProfileEmptyHistory(\r\n    onAddLesson: () -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Surface(\r\n        modifier = modifier.fillMaxWidth(),\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceContainerHigh\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 20.dp, vertical = 24.dp),\r\n            horizontalAlignment = Alignment.CenterHorizontally,\r\n            verticalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(id = R.string.student_details_history_empty),\r\n                style = MaterialTheme.typography.bodyMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                textAlign = TextAlign.Center\r\n            )\r\n            Button(onClick = onAddLesson) {\r\n                Text(text = stringResource(id = R.string.student_details_create_lesson))\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileLessonCard(\r\n    lesson: StudentProfileLesson,\r\n    fallbackSubject: String?,\r\n    currencyFormatter: NumberFormat,\r\n    zoneId: ZoneId,\r\n    dateFormatter: DateTimeFormatter,\r\n    timeFormatter: DateTimeFormatter,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val start = remember(lesson.startAt, zoneId) { lesson.startAt.atZone(zoneId) }\r\n    val end = remember(lesson.endAt, zoneId) { lesson.endAt.atZone(zoneId) }\r\n    val dateText = remember(start) { dateFormatter.format(start) }\r\n    val timeText = stringResource(\r\n        id = R.string.student_details_history_time_range,\r\n        timeFormatter.format(start),\r\n        timeFormatter.format(end),\r\n        lesson.durationMinutes\r\n    )\r\n    val fallbackSubjectText = fallbackSubject?.takeIf { it.isNotBlank() }?.trim()\r\n    val title = lesson.title?.takeIf { it.isNotBlank() }?.trim()\r\n        ?: lesson.subjectName?.takeIf { it.isNotBlank() }?.trim()\r\n        ?: fallbackSubjectText\r\n        ?: stringResource(id = R.string.lesson_card_subject_placeholder)\r\n    val amount = formatCurrency(lesson.priceCents.toLong(), currencyFormatter)\r\n    val isPaid = lesson.paymentStatus == PaymentStatus.PAID\r\n\r\n    Surface(\r\n        modifier = modifier\r\n            .fillMaxWidth()\r\n            .clickable { onClick() },\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceContainerLow\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 20.dp, vertical = 18.dp),\r\n            verticalArrangement = Arrangement.spacedBy(8.dp)\r\n        ) {\r\n            Text(\r\n                text = dateText,\r\n                style = MaterialTheme.typography.labelSmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Text(\r\n                text = title,\r\n                style = MaterialTheme.typography.titleMedium,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            Text(\r\n                text = timeText,\r\n                style = MaterialTheme.typography.bodySmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Row(\r\n                modifier = Modifier.fillMaxWidth(),\r\n                horizontalArrangement = Arrangement.SpaceBetween,\r\n                verticalAlignment = Alignment.CenterVertically\r\n            ) {\r\n                Text(\r\n                    text = amount,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n                PaymentBadge(paid = isPaid)\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\nprivate fun formatCurrency(amountCents: Long, formatter: NumberFormat): String {\r\n    return formatter.format(amountCents / 100.0)\r\n}\r\n\r\n@Composable\r\nprivate fun StudentAvatar(\r\n    name: String,\r\n    size: Dp = 48.dp,\r\n) {\r\n    val initials = remember(name) {\r\n        name\r\n            .split(\" \")\r\n            .filter { it.isNotBlank() }\r\n            .take(2)\r\n            .joinToString(separator = \"\") { it.first().uppercaseChar().toString() }\r\n            .ifEmpty { \"?\" }\r\n    }\r\n\r\n    Box(\r\n        modifier = Modifier\r\n            .size(size)\r\n            .clip(CircleShape)\r\n            .background(MaterialTheme.colorScheme.surfaceVariant),\r\n        contentAlignment = Alignment.Center\r\n    ) {\r\n        Text(\r\n            text = initials,\r\n            style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold),\r\n            color = MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n    }\r\n}\r\n
-Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
-<+>UTF-8
-===================================================================
-diff --git a/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt b/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt
---- a/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt	(revision c4c1b979c040baf0a45ebe7efb2089e930ba38fb)
-+++ b/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt	(date 1760137159342)
-@@ -51,6 +51,7 @@
- import androidx.compose.runtime.getValue
- import androidx.compose.runtime.mutableStateOf
- import androidx.compose.foundation.rememberScrollState
-+import androidx.compose.material.icons.filled.Close
- import androidx.compose.runtime.rememberCoroutineScope
- import androidx.compose.runtime.saveable.rememberSaveable
- import androidx.compose.ui.Alignment
-Index: app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt
-IDEA additional info:
-Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
-<+>package com.tutorly.ui.lessoncard\r\n\r\nimport android.app.DatePickerDialog\r\nimport android.app.TimePickerDialog\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.Column\r\nimport androidx.compose.foundation.layout.Row\r\nimport androidx.compose.foundation.layout.Spacer\r\nimport androidx.compose.foundation.layout.fillMaxWidth\r\nimport androidx.compose.foundation.layout.height\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.layout.size\r\nimport androidx.compose.foundation.layout.weight\r\nimport androidx.compose.foundation.lazy.LazyColumn\r\nimport androidx.compose.foundation.lazy.items\r\nimport androidx.compose.foundation.rememberScrollState\r\nimport androidx.compose.foundation.shape.CircleShape\r\nimport androidx.compose.foundation.shape.RoundedCornerShape\r\nimport androidx.compose.foundation.text.KeyboardOptions\r\nimport androidx.compose.foundation.verticalScroll\r\nimport androidx.compose.material.icons.Icons\r\nimport androidx.compose.material.icons.filled.KeyboardArrowDown\r\nimport androidx.compose.material.icons.outlined.CalendarMonth\r\nimport androidx.compose.material.icons.outlined.Schedule\r\nimport androidx.compose.material.icons.outlined.Timelapse\r\nimport androidx.compose.material3.AlertDialog\r\nimport androidx.compose.material3.CircularProgressIndicator\r\nimport androidx.compose.material3.DropdownMenu\r\nimport androidx.compose.material3.DropdownMenuItem\r\nimport androidx.compose.material3.ExperimentalMaterial3Api\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.LinearProgressIndicator\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.ModalBottomSheet\r\nimport androidx.compose.material3.OutlinedTextField\r\nimport androidx.compose.material3.SnackbarHost\r\nimport androidx.compose.material3.SnackbarHostState\r\nimport androidx.compose.material3.SuggestionChip\r\nimport androidx.compose.material3.SuggestionChipDefaults\r\nimport androidx.compose.material3.Surface\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.material3.TextButton\r\nimport androidx.compose.material3.rememberModalBottomSheetState\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.LaunchedEffect\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.rememberCoroutineScope\r\nimport androidx.compose.runtime.setValue\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.graphics.vector.ImageVector\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.input.KeyboardType\r\nimport androidx.compose.ui.text.style.TextOverflow\r\nimport androidx.compose.ui.unit.dp\r\nimport com.tutorly.R\r\nimport com.tutorly.models.PaymentStatus\r\nimport java.text.NumberFormat\r\nimport java.time.LocalDate\r\nimport java.time.LocalTime\r\nimport java.time.ZonedDateTime\r\nimport java.time.format.DateTimeFormatter\r\nimport java.util.Locale\r\nimport kotlinx.coroutines.launch\r\n\r\n@OptIn(ExperimentalMaterial3Api::class)\r\n@Composable\r\ninternal fun LessonCardSheet(\r\n    state: LessonCardUiState,\r\n    onDismissRequest: () -> Unit,\r\n    onStudentSelect: (Long) -> Unit,\r\n    onDateSelect: (LocalDate) -> Unit,\r\n    onTimeSelect: (LocalTime) -> Unit,\r\n    onDurationSelect: (Int) -> Unit,\r\n    onPriceChange: (Int) -> Unit,\r\n    onStatusSelect: (PaymentStatus) -> Unit,\r\n    onNoteChange: (String) -> Unit,\r\n    onSnackbarConsumed: () -> Unit,\r\n) {\r\n    if (!state.isVisible) return\r\n\r\n    val sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)\r\n    val snackbarHostState = remember { SnackbarHostState() }\r\n    val scope = rememberCoroutineScope()\r\n\r\n    var showStudentPicker by remember { mutableStateOf(false) }\r\n    var showDurationDialog by remember { mutableStateOf(false) }\r\n    var showPriceDialog by remember { mutableStateOf(false) }\r\n    var showNoteDialog by remember { mutableStateOf(false) }\r\n    var statusMenuExpanded by remember { mutableStateOf(false) }\r\n\r\n    val locale = state.locale\r\n    val dateFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"EEEE, d MMMM\", locale) }\r\n    val timeFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"HH:mm\", locale) }\r\n    val currencyFormatter = remember(locale, state.currencyCode) {\r\n        runCatching {\r\n            NumberFormat.getCurrencyInstance(locale).apply {\r\n                currency = java.util.Currency.getInstance(state.currencyCode)\r\n            }\r\n        }.getOrElse { NumberFormat.getCurrencyInstance(locale) }\r\n    }\r\n    val priceText = remember(state.priceCents, currencyFormatter) {\r\n        currencyFormatter.format(state.priceCents / 100.0)\r\n    }\r\n    val formattedDate = remember(state.date, locale) {\r\n        dateFormatter.format(state.date).replaceFirstChar { char ->\r\n            if (char.isLowerCase()) char.titlecase(locale) else char.toString()\r\n        }\r\n    }\r\n    val startDateTime = remember(state.date, state.time, state.zoneId) {\r\n        ZonedDateTime.of(state.date, state.time, state.zoneId)\r\n    }\r\n    val statusDisplay = remember(state.paymentStatus, startDateTime) {\r\n        paymentStatusDisplay(state.paymentStatus, startDateTime)\r\n    }\r\n\r\n    val snackbarText = when (val message = state.snackbarMessage) {\r\n        is LessonCardMessage.Error -> message.message ?: stringResource(R.string.lesson_card_snackbar_error)\r\n        null -> null\r\n    }\r\n\r\n    LaunchedEffect(snackbarText) {\r\n        if (snackbarText != null) {\r\n            snackbarHostState.showSnackbar(snackbarText)\r\n            onSnackbarConsumed()\r\n        }\r\n    }\r\n\r\n    ModalBottomSheet(\r\n        onDismissRequest = {\r\n            scope.launch { sheetState.hide() }.invokeOnCompletion { onDismissRequest() }\r\n        },\r\n        sheetState = sheetState,\r\n        containerColor = Color.White,\r\n    ) {\r\n        Box(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp)\r\n        ) {\r\n            if (state.isLoading) {\r\n                Box(\r\n                    modifier = Modifier\r\n                        .fillMaxWidth()\r\n                        .height(200.dp),\r\n                    contentAlignment = Alignment.Center\r\n                ) {\r\n                    CircularProgressIndicator()\r\n                }\r\n            } else {\r\n                Column(\r\n                    modifier = Modifier\r\n                        .fillMaxWidth()\r\n                        .verticalScroll(rememberScrollState()),\r\n                    verticalArrangement = Arrangement.spacedBy(20.dp)\r\n                ) {\r\n                    if (state.isSaving) {\r\n                        LinearProgressIndicator(modifier = Modifier.fillMaxWidth())\r\n                    }\r\n\r\n                    LessonHeader(\r\n                        name = state.studentName,\r\n                        grade = state.studentGrade,\r\n                        subject = state.subjectName,\r\n                        onClick = { if (state.studentOptions.isNotEmpty()) showStudentPicker = true }\r\n                    )\r\n\r\n                    DateRow(\r\n                        dateText = formattedDate,\r\n                        onClick = {\r\n                            val context = LocalContext.current\r\n                            DatePickerDialog(\r\n                                context,\r\n                                { _, year, month, day -> onDateSelect(LocalDate.of(year, month + 1, day)) },\r\n                                state.date.year,\r\n                                state.date.monthValue - 1,\r\n                                state.date.dayOfMonth\r\n                            ).show()\r\n                        }\r\n                    )\r\n\r\n                    TimeDurationRow(\r\n                        timeLabel = stringResource(id = R.string.lesson_details_time_label),\r\n                        timeText = state.time.format(timeFormatter),\r\n                        durationLabel = stringResource(id = R.string.lesson_details_duration_label),\r\n                        durationText = stringResource(id = R.string.lesson_card_duration_value, state.durationMinutes),\r\n                        onTimeClick = {\r\n                            val context = LocalContext.current\r\n                            TimePickerDialog(\r\n                                context,\r\n                                { _, hour, minute -> onTimeSelect(LocalTime.of(hour, minute)) },\r\n                                state.time.hour,\r\n                                state.time.minute,\r\n                                true\r\n                            ).show()\r\n                        },\r\n                        onDurationClick = { showDurationDialog = true }\r\n                    )\r\n\r\n                    PriceRow(\r\n                        price = priceText,\r\n                        statusLabel = stringResource(id = statusDisplay.labelRes),\r\n                        statusSymbol = statusDisplay.symbol,\r\n                        startDateTime = startDateTime,\r\n                        statusMenuExpanded = statusMenuExpanded,\r\n                        onPriceClick = { showPriceDialog = true },\r\n                        onStatusClick = { if (!state.isPaymentActionRunning) statusMenuExpanded = true },\r\n                        onStatusDismiss = { statusMenuExpanded = false },\r\n                        onStatusSelect = onStatusSelect,\r\n                        isStatusBusy = state.isPaymentActionRunning\r\n                    )\r\n\r\n                    NoteRow(\r\n                        note = state.note,\r\n                        onClick = { showNoteDialog = true }\r\n                    )\r\n\r\n                    Spacer(modifier = Modifier.height(8.dp))\r\n                }\r\n            }\r\n\r\n            SnackbarHost(\r\n                hostState = snackbarHostState,\r\n                modifier = Modifier\r\n                    .align(Alignment.BottomCenter)\r\n                    .padding(bottom = 8.dp)\r\n            )\r\n        }\r\n    }\r\n\r\n    if (showStudentPicker) {\r\n        StudentPickerDialog(\r\n            options = state.studentOptions,\r\n            onSelect = {\r\n                onStudentSelect(it)\r\n                showStudentPicker = false\r\n            },\r\n            onDismiss = { showStudentPicker = false }\r\n        )\r\n    }\r\n\r\n    if (showDurationDialog) {\r\n        DurationDialog(\r\n            currentMinutes = state.durationMinutes,\r\n            onDismiss = { showDurationDialog = false },\r\n            onConfirm = {\r\n                onDurationSelect(it)\r\n                showDurationDialog = false\r\n            }\r\n        )\r\n    }\r\n\r\n    if (showPriceDialog) {\r\n        PriceDialog(\r\n            currentPriceCents = state.priceCents,\r\n            currencySymbol = state.currencySymbol,\r\n            onDismiss = { showPriceDialog = false },\r\n            onConfirm = {\r\n                onPriceChange(it)\r\n                showPriceDialog = false\r\n            }\r\n        )\r\n    }\r\n\r\n    if (showNoteDialog) {\r\n        NoteDialog(\r\n            currentNote = state.note.orEmpty(),\r\n            onDismiss = { showNoteDialog = false },\r\n            onConfirm = {\r\n                onNoteChange(it)\r\n                showNoteDialog = false\r\n            }\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun LessonHeader(\r\n    name: String,\r\n    grade: String?,\r\n    subject: String?,\r\n    onClick: () -> Unit,\r\n) {\r\n    val initials = remember(name) {\r\n        name.split(\" \").filter { it.isNotBlank() }.take(2).map { it.first().uppercase() }.joinToString(\"\")\r\n    }\r\n    Row(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .clickable(onClick = onClick),\r\n        verticalAlignment = Alignment.CenterVertically,\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        Surface(\r\n            modifier = Modifier.size(48.dp),\r\n            shape = CircleShape,\r\n            color = MaterialTheme.colorScheme.primary.copy(alpha = 0.1f)\r\n        ) {\r\n            Box(contentAlignment = Alignment.Center) {\r\n                Text(\r\n                    text = initials.ifBlank { \"?\" },\r\n                    style = MaterialTheme.typography.titleMedium,\r\n                    fontWeight = FontWeight.SemiBold,\r\n                    color = MaterialTheme.colorScheme.primary\r\n                )\r\n            }\r\n        }\r\n        Column(modifier = Modifier.weight(1f)) {\r\n            Text(\r\n                text = name.ifBlank { stringResource(id = R.string.lesson_card_student_placeholder) },\r\n                style = MaterialTheme.typography.titleLarge,\r\n                maxLines = 1,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            val subtitle = listOfNotNull(grade, subject).filter { it.isNotBlank() }.joinToString(\" • \")\r\n            if (subtitle.isNotBlank()) {\r\n                Text(\r\n                    text = subtitle,\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n            }\r\n        }\r\n        Icon(\r\n            imageVector = Icons.Filled.KeyboardArrowDown,\r\n            contentDescription = null,\r\n            tint = MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun DateRow(\r\n    dateText: String,\r\n    onClick: () -> Unit,\r\n) {\r\n    Surface(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .clickable(onClick = onClick),\r\n        shape = RoundedCornerShape(20.dp),\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp),\r\n            verticalAlignment = Alignment.CenterVertically,\r\n            horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Icon(\r\n                imageVector = Icons.Outlined.CalendarMonth,\r\n                contentDescription = null,\r\n                tint = MaterialTheme.colorScheme.primary\r\n            )\r\n            Column {\r\n                Text(\r\n                    text = stringResource(id = R.string.lesson_card_date_label),\r\n                    style = MaterialTheme.typography.labelMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n                Text(\r\n                    text = dateText,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun TimeDurationRow(\r\n    timeLabel: String,\r\n    timeText: String,\r\n    durationLabel: String,\r\n    durationText: String,\r\n    onTimeClick: () -> Unit,\r\n    onDurationClick: () -> Unit,\r\n) {\r\n    Row(\r\n        modifier = Modifier.fillMaxWidth(),\r\n        horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        TimeCard(\r\n            label = timeLabel,\r\n            value = timeText,\r\n            icon = Icons.Outlined.Schedule,\r\n            onClick = onTimeClick,\r\n            modifier = Modifier.weight(1f)\r\n        )\r\n        TimeCard(\r\n            label = durationLabel,\r\n            value = durationText,\r\n            icon = Icons.Outlined.Timelapse,\r\n            onClick = onDurationClick,\r\n            modifier = Modifier.weight(1f)\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun TimeCard(\r\n    label: String,\r\n    value: String,\r\n    icon: ImageVector,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier,\r\n) {\r\n    Surface(\r\n        modifier = modifier.clickable(onClick = onClick),\r\n        shape = RoundedCornerShape(20.dp),\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp),\r\n            verticalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            Icon(\r\n                imageVector = icon,\r\n                contentDescription = null,\r\n                tint = MaterialTheme.colorScheme.primary,\r\n                modifier = Modifier.size(24.dp)\r\n            )\r\n            Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {\r\n                Text(\r\n                    text = label,\r\n                    style = MaterialTheme.typography.labelMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n                Text(\r\n                    text = value,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun PriceRow(\r\n    price: String,\r\n    statusLabel: String,\r\n    statusSymbol: String,\r\n    startDateTime: ZonedDateTime,\r\n    statusMenuExpanded: Boolean,\r\n    onPriceClick: () -> Unit,\r\n    onStatusClick: () -> Unit,\r\n    onStatusDismiss: () -> Unit,\r\n    onStatusSelect: (PaymentStatus) -> Unit,\r\n    isStatusBusy: Boolean,\r\n) {\r\n    Row(\r\n        modifier = Modifier.fillMaxWidth(),\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp),\r\n        verticalAlignment = Alignment.CenterVertically\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .weight(1f)\r\n                .clickable(onClick = onPriceClick)\r\n        ) {\r\n            Text(\r\n                text = stringResource(id = R.string.lesson_card_price_label),\r\n                style = MaterialTheme.typography.labelMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Text(\r\n                text = price,\r\n                style = MaterialTheme.typography.titleLarge\r\n            )\r\n        }\r\n        Box {\r\n            Surface(\r\n                shape = RoundedCornerShape(20.dp),\r\n                color = MaterialTheme.colorScheme.surfaceVariant,\r\n                modifier = Modifier\r\n                    .clickable(onClick = onStatusClick)\r\n                    .padding(vertical = 4.dp)\r\n            ) {\r\n                Row(\r\n                    modifier = Modifier\r\n                        .padding(horizontal = 14.dp, vertical = 8.dp),\r\n                    horizontalArrangement = Arrangement.spacedBy(8.dp),\r\n                    verticalAlignment = Alignment.CenterVertically\r\n                ) {\r\n                    if (isStatusBusy) {\r\n                        CircularProgressIndicator(\r\n                            modifier = Modifier.size(16.dp),\r\n                            strokeWidth = 2.dp\r\n                        )\r\n                    } else {\r\n                        Text(text = statusSymbol, style = MaterialTheme.typography.titleMedium)\r\n                    }\r\n                    Text(\r\n                        text = statusLabel,\r\n                        style = MaterialTheme.typography.labelLarge\r\n                    )\r\n                }\r\n            }\r\n            DropdownMenu(\r\n                expanded = statusMenuExpanded,\r\n                onDismissRequest = onStatusDismiss\r\n            ) {\r\n                listOf(PaymentStatus.UNPAID, PaymentStatus.PAID, PaymentStatus.DUE).forEach { status ->\r\n                    val display = paymentStatusDisplay(status, startDateTime)\r\n                    DropdownMenuItem(\r\n                        text = { Text(\"${display.symbol} ${stringResource(id = display.labelRes)}\") },\r\n                        onClick = {\r\n                            onStatusSelect(status)\r\n                            onStatusDismiss()\r\n                        }\r\n                    )\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun NoteRow(\r\n    note: String?,\r\n    onClick: () -> Unit,\r\n) {\r\n    Surface(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .clickable(onClick = onClick),\r\n        shape = RoundedCornerShape(20.dp),\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp),\r\n            verticalArrangement = Arrangement.spacedBy(8.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(id = R.string.lesson_card_note_label),\r\n                style = MaterialTheme.typography.labelMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            val content = note?.takeIf { it.isNotBlank() }\r\n            if (content == null) {\r\n                Text(\r\n                    text = stringResource(id = R.string.lesson_card_note_placeholder),\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            } else {\r\n                Text(\r\n                    text = content,\r\n                    style = MaterialTheme.typography.bodyMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentPickerDialog(\r\n    options: List<LessonStudentOption>,\r\n    onSelect: (Long) -> Unit,\r\n    onDismiss: () -> Unit,\r\n) {\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        title = { Text(text = stringResource(id = R.string.lesson_card_student_picker_title)) },\r\n        text = {\r\n            if (options.isEmpty()) {\r\n                Text(text = stringResource(id = R.string.lesson_card_student_picker_empty))\r\n            } else {\r\n                LazyColumn(verticalArrangement = Arrangement.spacedBy(12.dp)) {\r\n                    items(options, key = { it.id }) { option ->\r\n                        Column(\r\n                            modifier = Modifier\r\n                                .fillMaxWidth()\r\n                                .clickable { onSelect(option.id) }\r\n                                .padding(vertical = 4.dp)\r\n                        ) {\r\n                            Text(\r\n                                text = option.name,\r\n                                style = MaterialTheme.typography.titleMedium\r\n                            )\r\n                            val subtitle = listOfNotNull(option.grade, option.subject)\r\n                                .filter { it.isNotBlank() }\r\n                                .joinToString(\" • \")\r\n                            if (subtitle.isNotBlank()) {\r\n                                Text(\r\n                                    text = subtitle,\r\n                                    style = MaterialTheme.typography.bodySmall,\r\n                                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                                )\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        confirmButton = {},\r\n        dismissButton = {\r\n            TextButton(onClick = onDismiss) {\r\n                Text(text = stringResource(id = R.string.lesson_create_cancel))\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\n@Composable\r\nprivate fun DurationDialog(\r\n    currentMinutes: Int,\r\n    onDismiss: () -> Unit,\r\n    onConfirm: (Int) -> Unit,\r\n) {\r\n    var customInput by remember(currentMinutes) {\r\n        mutableStateOf(currentMinutes.takeIf { it > 0 }?.toString().orEmpty())\r\n    }\r\n    val presets = listOf(25, 60, 90, 120)\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        title = { Text(text = stringResource(id = R.string.lesson_card_duration_title)) },\r\n        text = {\r\n            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {\r\n                Row(\r\n                    modifier = Modifier.fillMaxWidth(),\r\n                    horizontalArrangement = Arrangement.spacedBy(8.dp)\r\n                ) {\r\n                    presets.forEach { preset ->\r\n                        SuggestionChip(\r\n                            onClick = {\r\n                                customInput = preset.toString()\r\n                            },\r\n                            label = { Text(text = preset.toString()) },\r\n                            colors = SuggestionChipDefaults.suggestionChipColors()\r\n                        )\r\n                    }\r\n                }\r\n                OutlinedTextField(\r\n                    value = customInput,\r\n                    onValueChange = { value ->\r\n                        customInput = value.filter { it.isDigit() }\r\n                    },\r\n                    label = { Text(text = stringResource(id = R.string.lesson_card_duration_hint)) },\r\n                    suffix = { Text(text = stringResource(id = R.string.lesson_create_minutes_suffix)) },\r\n                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),\r\n                    singleLine = true\r\n                )\r\n            }\r\n        },\r\n        confirmButton = {\r\n            TextButton(onClick = {\r\n                customInput.toIntOrNull()?.takeIf { it > 0 }?.let(onConfirm)\r\n            }) {\r\n                Text(text = stringResource(id = R.string.lesson_details_save))\r\n            }\r\n        },\r\n        dismissButton = {\r\n            TextButton(onClick = onDismiss) {\r\n                Text(text = stringResource(id = R.string.lesson_create_cancel))\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\n@Composable\r\nprivate fun PriceDialog(\r\n    currentPriceCents: Int,\r\n    currencySymbol: String,\r\n    onDismiss: () -> Unit,\r\n    onConfirm: (Int) -> Unit,\r\n) {\r\n    var input by remember(currentPriceCents) {\r\n        mutableStateOf(currentPriceCents.takeIf { it >= 0 }?.let { (it / 100).toString() } ?: \"\")\r\n    }\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        title = { Text(text = stringResource(id = R.string.lesson_card_price_title)) },\r\n        text = {\r\n            OutlinedTextField(\r\n                value = input,\r\n                onValueChange = { value ->\r\n                    input = value.filter { it.isDigit() }\r\n                },\r\n                label = { Text(text = stringResource(id = R.string.lesson_card_price_hint, currencySymbol)) },\r\n                keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),\r\n                singleLine = true\r\n            )\r\n        },\r\n        confirmButton = {\r\n            TextButton(onClick = {\r\n                input.toIntOrNull()?.let { onConfirm(it * 100) }\r\n            }) {\r\n                Text(text = stringResource(id = R.string.lesson_details_save))\r\n            }\r\n        },\r\n        dismissButton = {\r\n            TextButton(onClick = onDismiss) {\r\n                Text(text = stringResource(id = R.string.lesson_create_cancel))\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\n@Composable\r\nprivate fun NoteDialog(\r\n    currentNote: String,\r\n    onDismiss: () -> Unit,\r\n    onConfirm: (String) -> Unit,\r\n) {\r\n    var noteInput by remember(currentNote) { mutableStateOf(currentNote) }\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        title = { Text(text = stringResource(id = R.string.lesson_card_note_title)) },\r\n        text = {\r\n            OutlinedTextField(\r\n                value = noteInput,\r\n                onValueChange = { value ->\r\n                    noteInput = value.take(LESSON_CARD_NOTE_LIMIT)\r\n                },\r\n                label = { Text(text = stringResource(id = R.string.lesson_card_note_hint)) },\r\n                modifier = Modifier.height(120.dp)\r\n            )\r\n        },\r\n        confirmButton = {\r\n            TextButton(onClick = { onConfirm(noteInput) }) {\r\n                Text(text = stringResource(id = R.string.lesson_details_save))\r\n            }\r\n        },\r\n        dismissButton = {\r\n            TextButton(onClick = onDismiss) {\r\n                Text(text = stringResource(id = R.string.lesson_create_cancel))\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\nprivate data class PaymentStatusDisplay(val symbol: String, val labelRes: Int)\r\n\r\nprivate fun paymentStatusDisplay(status: PaymentStatus, start: ZonedDateTime): PaymentStatusDisplay {\r\n    val isFuture = start.isAfter(ZonedDateTime.now(start.zone))\r\n    val labelRes = when (status) {\r\n        PaymentStatus.UNPAID -> R.string.lesson_card_status_planned\r\n        PaymentStatus.PAID -> if (isFuture) R.string.lesson_card_status_prepaid else R.string.lesson_status_paid\r\n        PaymentStatus.DUE -> R.string.lesson_status_due\r\n        PaymentStatus.CANCELLED -> R.string.lesson_status_cancelled\r\n    }\r\n    val symbol = when (status) {\r\n        PaymentStatus.UNPAID -> \"•\"\r\n        PaymentStatus.PAID -> if (isFuture) \"◎\" else \"✓\"\r\n        PaymentStatus.DUE -> \"–\"\r\n        PaymentStatus.CANCELLED -> \"×\"\r\n    }\r\n    return PaymentStatusDisplay(symbol, labelRes)\r\n}\r\n
-Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
-<+>UTF-8
-===================================================================
-diff --git a/app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt b/app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt
---- a/app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt	(revision c4c1b979c040baf0a45ebe7efb2089e930ba38fb)
-+++ b/app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt	(date 1760177411789)
-@@ -341,7 +341,7 @@
- @Composable
- private fun DateRow(
-     dateText: String,
--    onClick: () -> Unit,
-+    onClick: @Composable () -> Unit,
- ) {
-     Surface(
-         modifier = Modifier
Index: .idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49__Changes_.xml
===================================================================
diff --git a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49__Changes_.xml b/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49__Changes_.xml
deleted file mode 100644
--- a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49__Changes_.xml	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ /dev/null	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
@@ -1,4 +0,0 @@
-<changelist name="Uncommitted_changes_before_Update_at_11_10_2025_13_49_[Changes]" date="1760179796571" recycled="true" deleted="true">
-  <option name="PATH" value="$PROJECT_DIR$/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49_[Changes]/shelved.patch" />
-  <option name="DESCRIPTION" value="Uncommitted changes before Update at 11.10.2025 13:49 [Changes]" />
-</changelist>
\ No newline at end of file
Index: .idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59__Changes_1.xml
===================================================================
diff --git a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59__Changes_1.xml b/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59__Changes_1.xml
deleted file mode 100644
--- a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59__Changes_1.xml	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ /dev/null	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
@@ -1,4 +0,0 @@
-<changelist name="Uncommitted_changes_before_Update_at_11_10_2025_1_59_[Changes]1" date="1760137162443" recycled="true" deleted="true">
-  <option name="PATH" value="$PROJECT_DIR$/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59_[Changes]1/shelved.patch" />
-  <option name="DESCRIPTION" value="Uncommitted changes before Update at 11.10.2025 1:59 [Changes]" />
-</changelist>
\ No newline at end of file
Index: .idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59_[Changes]1/shelved.patch
===================================================================
diff --git a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59_[Changes]1/shelved.patch b/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59_[Changes]1/shelved.patch
deleted file mode 100644
--- a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_1_59_[Changes]1/shelved.patch	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ /dev/null	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
@@ -1,44 +0,0 @@
-Index: app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt
-IDEA additional info:
-Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
-<+>package com.tutorly.ui\r\n\r\nimport androidx.compose.animation.AnimatedContent\r\nimport androidx.compose.animation.ExperimentalAnimationApi\r\nimport androidx.compose.animation.core.tween\r\nimport androidx.compose.animation.fadeIn\r\nimport androidx.compose.animation.fadeOut\r\nimport androidx.compose.animation.slideInHorizontally\r\nimport androidx.compose.animation.slideOutHorizontally\r\nimport androidx.compose.animation.togetherWith\r\nimport androidx.compose.foundation.BorderStroke\nimport androidx.compose.foundation.Canvas\nimport androidx.compose.foundation.gestures.detectHorizontalDragGestures\nimport androidx.compose.foundation.gestures.detectTapGestures\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.lazy.grid.GridCells\nimport androidx.compose.foundation.lazy.grid.LazyVerticalGrid\nimport androidx.compose.foundation.lazy.grid.items\nimport androidx.compose.foundation.rememberScrollState\nimport androidx.compose.foundation.verticalScroll\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.Add\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.clipToBounds\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.input.pointer.pointerInput\nimport androidx.compose.ui.platform.LocalDensity\nimport androidx.compose.ui.res.stringResource\nimport androidx.compose.ui.text.style.TextAlign\nimport androidx.compose.ui.text.style.TextOverflow\nimport androidx.compose.ui.unit.Dp\nimport androidx.compose.ui.unit.dp\nimport androidx.hilt.navigation.compose.hiltViewModel\nimport com.tutorly.R\nimport com.tutorly.ui.CalendarEvent\nimport com.tutorly.domain.model.PaymentStatusIcon\nimport com.tutorly.models.PaymentStatus\nimport com.tutorly.ui.components.AppTopBar\nimport com.tutorly.ui.components.LessonBrief\nimport com.tutorly.ui.components.WeekMosaic\nimport com.tutorly.ui.theme.NowRed\r\nimport com.tutorly.ui.lessoncreation.LessonCreationConfig\r\nimport com.tutorly.ui.lessoncreation.LessonCreationOrigin\r\nimport com.tutorly.ui.lessoncreation.LessonCreationSheet\r\nimport com.tutorly.ui.lessoncreation.LessonCreationViewModel\r\nimport com.tutorly.ui.lessoncard.LessonCardExitAction\r\nimport com.tutorly.ui.lessoncard.LessonCardSheet\nimport com.tutorly.ui.lessoncard.LessonCardViewModel\nimport java.time.DayOfWeek\nimport java.time.Duration\nimport java.time.LocalDate\nimport java.time.LocalTime\nimport java.time.ZonedDateTime\nimport java.time.ZoneId\nimport java.time.YearMonth\nimport java.time.format.DateTimeFormatter\nimport java.time.format.TextStyle\nimport java.time.temporal.TemporalAdjusters\nimport java.util.*\nimport kotlin.math.abs\r\nimport kotlin.math.max\r\nimport kotlin.math.min\r\nimport kotlin.math.roundToInt\r\n\r\nenum class CalendarMode { DAY, WEEK, MONTH }\r\n\r\n@OptIn(ExperimentalAnimationApi::class)\r\n@Composable\r\nfun CalendarScreen(\r\n    modifier: Modifier = Modifier,\r\n    onLessonDetails: (Long, Long, ZonedDateTime) -> Unit = { _, _, _ -> },\r\n    onAddStudent: () -> Unit = {},\r\n    creationViewModel: LessonCreationViewModel,\r\n    viewModel: CalendarViewModel = hiltViewModel()\r\n) {\r\n    val uiState by viewModel.uiState.collectAsState()\r\n    val creationState by creationViewModel.uiState.collectAsState()\r\n    val lessonCardViewModel: LessonCardViewModel = hiltViewModel()\n    val lessonCardState by lessonCardViewModel.uiState.collectAsState()\n    val snackbarHostState = remember { SnackbarHostState() }\n    var direction by remember { mutableStateOf(0) } // -1 назад, +1 вперёд\n    val anchor = uiState.anchor\n    val mode = uiState.mode\n    val zoneId = remember { ZoneId.systemDefault() }\n\n    LessonCardSheet(\n        state = lessonCardState,\n        zoneId = zoneId,\n        onDismissRequest = lessonCardViewModel::requestDismiss,\n        onCancelDismiss = lessonCardViewModel::cancelDismiss,\n        onConfirmDismiss = lessonCardViewModel::confirmDismiss,\n        onNoteChange = lessonCardViewModel::onNoteChange,\n        onSaveNote = lessonCardViewModel::saveNote,\n        onMarkPaid = lessonCardViewModel::markPaid,\n        onRequestMarkDue = lessonCardViewModel::requestMarkDue,\n        onDismissMarkDue = lessonCardViewModel::dismissMarkDueDialog,\n        onConfirmMarkDue = lessonCardViewModel::confirmMarkDue,\n        onRequestEdit = lessonCardViewModel::requestEdit,\n        onSnackbarConsumed = lessonCardViewModel::consumeSnackbar\n    )\n\n    val pendingExit = lessonCardState.pendingExitAction\n    LaunchedEffect(pendingExit) {\n        when (pendingExit) {\n            is LessonCardExitAction.NavigateToEdit -> {\n                val details = pendingExit.details\n                onLessonDetails(details.id, details.studentId, details.startAt.atZone(zoneId))\n                lessonCardViewModel.consumeExitAction()\n            }\n            LessonCardExitAction.Close -> {\n                lessonCardViewModel.consumeExitAction()\n            }\n            null -> Unit\n        }\n    }\n\n    LaunchedEffect(viewModel) {\n        viewModel.events.collect { event ->\n            when (event) {\n                is CalendarEvent.CreateLesson -> creationViewModel.start(\n                    LessonCreationConfig(\r\n                        start = event.start,\r\n                        duration = event.duration,\r\n                        studentId = event.studentId,\r\n                        zoneId = event.start.zone,\r\n                        origin = LessonCreationOrigin.CALENDAR\r\n                    )\r\n                )\r\n                is CalendarEvent.OpenLesson -> lessonCardViewModel.open(event.lessonId)\n            }\n        }\n    }\n\r\n    LaunchedEffect(creationState.snackbarMessage) {\r\n        creationState.snackbarMessage?.let { message ->\r\n            snackbarHostState.showSnackbar(message)\r\n            creationViewModel.consumeSnackbar()\r\n        }\r\n    }\r\n\r\n    LessonCreationSheet(\r\n        state = creationState,\r\n        onDismiss = { creationViewModel.dismiss() },\r\n        onStudentQueryChange = creationViewModel::onStudentQueryChange,\r\n        onStudentSelect = creationViewModel::onStudentSelected,\r\n        onAddStudent = {\r\n            creationViewModel.prepareForStudentCreation()\r\n            creationViewModel.dismiss()\r\n            onAddStudent()\r\n        },\r\n        onSubjectSelect = creationViewModel::onSubjectSelected,\r\n        onDateSelect = creationViewModel::onDateSelected,\r\n        onTimeSelect = creationViewModel::onTimeSelected,\r\n        onDurationChange = creationViewModel::onDurationChanged,\r\n        onPriceChange = creationViewModel::onPriceChanged,\r\n        onNoteChange = creationViewModel::onNoteChanged,\r\n        onSubmit = creationViewModel::submit,\r\n        onConfirmConflict = creationViewModel::confirmConflict,\r\n        onDismissConflict = creationViewModel::dismissConflict\r\n    )\r\n\r\n    val prevPeriod = {\r\n        direction = -1\r\n        viewModel.goToPreviousPeriod()\r\n    }\r\n    val nextPeriod = {\r\n        direction = +1\r\n        viewModel.goToNextPeriod()\r\n    }\r\n\r\n    val swipeModifier = Modifier.pointerInput(mode) {\r\n        val threshold = 48.dp.toPx()\r\n        var totalDrag = 0f\r\n        var handled = false\r\n        detectHorizontalDragGestures(\r\n            onDragStart = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onDragEnd = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onDragCancel = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onHorizontalDrag = { change, dragAmount ->\r\n                if (handled) return@detectHorizontalDragGestures\r\n\r\n                totalDrag += dragAmount\r\n                if (abs(totalDrag) > threshold) {\r\n                    if (totalDrag < 0) nextPeriod() else prevPeriod()\r\n                    handled = true\r\n                    change.consume()\r\n                }\r\n            }\r\n        )\r\n    }\r\n\r\n    Scaffold(\n        modifier = modifier,\n        topBar = {\n            AppTopBar(title = stringResource(id = R.string.calendar_title))\n        },\n        snackbarHost = { SnackbarHost(snackbarHostState) },\n        floatingActionButton = {\n            FloatingActionButton(onClick = {\n                val start = uiState.currentDateTime\n                creationViewModel.start(\n                    LessonCreationConfig(\n                        start = start,\n                        zoneId = uiState.zoneId,\n                        origin = LessonCreationOrigin.CALENDAR\n                    )\n                )\n            }) {\n                Icon(Icons.Filled.Add, contentDescription = null)\n            }\n        }\n    ) { padding ->\n        Column(\n            Modifier\n                .fillMaxSize()\n                .padding(padding)\n        ) {\n        // Хедер: тут же свайп (чтобы не конфликтовал со скроллом списка)\r\n        PlanScreenHeader(\n            anchor = anchor,\n            mode = mode,\n            onModeChange = {\n                direction = 0\n                viewModel.setMode(it)\n            },\n            onPrevPeriod = prevPeriod,\n            onNextPeriod = nextPeriod,\n            onSelectDate = { selected ->\n                direction = when {\n                    selected.isAfter(anchor) -> 1\n                    selected.isBefore(anchor) -> -1\r\n                    else -> 0\r\n                }\r\n                viewModel.selectDate(selected)\r\n            },\r\n            onSwipeLeft = nextPeriod,\r\n            onSwipeRight = prevPeriod\r\n        )\r\n\r\n        // Контент занимает остаток экрана и скроллится внутри\r\n        Box(\r\n            Modifier\r\n                .weight(1f)\r\n                .fillMaxWidth()\r\n                .clipToBounds()\r\n                .then(swipeModifier)   // \uD83D\uDC48 свайп теперь работает по всему экрану\r\n        ) {\r\n            AnimatedContent(\r\n                targetState = anchor,\r\n                modifier = Modifier.fillMaxSize(),\r\n                transitionSpec = {\r\n                    if (direction > 0) {\r\n                        // вперёд (влево)\r\n                        (slideInHorizontally(\r\n                            initialOffsetX = { fullWidth -> fullWidth },\r\n                            animationSpec = tween(durationMillis = 250)\r\n                        ) + fadeIn(animationSpec = tween(250))) togetherWith\r\n                                (slideOutHorizontally(\r\n                                    targetOffsetX = { fullWidth -> -fullWidth / 2 },\r\n                                    animationSpec = tween(durationMillis = 250)\r\n                                ) + fadeOut(animationSpec = tween(250)))\r\n                    } else {\r\n                        // назад (вправо)\r\n                        (slideInHorizontally(\r\n                            initialOffsetX = { fullWidth -> -fullWidth },\r\n                            animationSpec = tween(durationMillis = 250)\r\n                        ) + fadeIn(animationSpec = tween(250))) togetherWith\r\n                                (slideOutHorizontally(\r\n                                    targetOffsetX = { fullWidth -> fullWidth / 2 },\r\n                                    animationSpec = tween(durationMillis = 250)\r\n                                ) + fadeOut(animationSpec = tween(250)))\r\n                    }\r\n                }\r\n                ,\r\n                label = \"day-switch\"\r\n            ) { currentDate ->\r\n                val lessonsForCurrent = remember(currentDate, uiState.lessonsByDate) {\r\n                    uiState.lessonsByDate[currentDate].orEmpty()\r\n                }\r\n                when (mode) {\r\n                    CalendarMode.DAY -> DayTimeline(\r\n                        date = currentDate,\r\n                        lessons = lessonsForCurrent,\r\n                        currentDateTime = uiState.currentDateTime,\r\n                        onLessonClick = { lesson ->\r\n                            lessonCardViewModel.open(lesson.id)\r\n                        },\r\n                        onEmptySlot = { startTime ->\r\n                            viewModel.onEmptySlotSelected(currentDate, startTime, DefaultSlotDuration)\r\n                        }\r\n                    )\r\n                    CalendarMode.WEEK -> WeekMosaic(\n                        anchor = currentDate,\n                        onOpenDay = { selected ->\n                            direction = when {\n                                selected.isAfter(anchor) -> 1\n                                selected.isBefore(anchor) -> -1\n                                else -> 0\n                            }\n                            viewModel.setMode(CalendarMode.DAY)\n                            viewModel.selectDate(selected)\n                        },\n                        dayDataProvider = { date ->\n                            uiState.lessonsByDate[date].orEmpty().map { it.toLessonBrief() }\n                        },\n                        currentDateTime = uiState.currentDateTime,\n                        onLessonClick = { brief -> lessonCardViewModel.open(brief.id) }\n                    )\n                    CalendarMode.MONTH -> MonthCalendar(\n                        anchor = currentDate,\n                        lessonsByDate = uiState.lessonsByDate,\n                        currentDateTime = uiState.currentDateTime,\n                        onDaySelected = { selected ->\n                            direction = when {\n                                selected.isAfter(anchor) -> 1\n                                selected.isBefore(anchor) -> -1\n                                else -> 0\n                            }\n                            viewModel.setMode(CalendarMode.DAY)\n                            viewModel.selectDate(selected)\n                        }\n                    )\n                }\n            }\n        }\n    }\n    }\r\n}\r\n\r\nprivate fun CalendarLesson.toLessonBrief(): LessonBrief {\n    return LessonBrief(\n        id = id,\n        start = start.toLocalTime(),\n        end = end.toLocalTime(),\n        student = studentName,\n        grade = studentGrade,\n        subjectName = subjectName,\n        subjectColorArgb = subjectColorArgb\n    )\n}\n\r\n\n/* ----------------------------- HEADER ----------------------------------- */\n\r\n@Composable\r\nfun PlanScreenHeader(\n    anchor: LocalDate,\n    mode: CalendarMode,\n    onModeChange: (CalendarMode) -> Unit,\n    onPrevPeriod: () -> Unit,\n    onNextPeriod: () -> Unit,\n    onSelectDate: (LocalDate) -> Unit,\n    onSwipeLeft: () -> Unit,\n    onSwipeRight: () -> Unit\n) {\n    Column(\r\n        Modifier\r\n            .fillMaxWidth()\r\n            .padding(horizontal = 16.dp, vertical = 8.dp)\r\n            // свайп только на хедере — не мешает вертикальному скроллу списка\r\n            .pointerInput(mode) {\r\n                val threshold = 48.dp.toPx()\r\n                var totalDrag = 0f\r\n                var handled = false\r\n                detectHorizontalDragGestures(\r\n                    onDragStart = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onDragEnd = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onDragCancel = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onHorizontalDrag = { change, dragAmount ->\r\n                        if (handled) return@detectHorizontalDragGestures\r\n\r\n                        totalDrag += dragAmount\r\n                        if (abs(totalDrag) > threshold) {\r\n                            if (totalDrag < 0) onSwipeLeft() else onSwipeRight()\r\n                            handled = true\r\n                            change.consume()\r\n                        }\r\n                    }\r\n                )\r\n            }\r\n    ) {\r\n        Text(\n            text = anchor.format(DateTimeFormatter.ofPattern(\"LLLL yyyy\", Locale(\"ru\")))\n                .replaceFirstChar { it.titlecase(Locale(\"ru\")) },\n            style = MaterialTheme.typography.titleLarge\n        )\n        TabRow(\r\n            selectedTabIndex = mode.ordinal,\r\n            containerColor = Color.Transparent,\r\n            contentColor = MaterialTheme.colorScheme.primary,\r\n            divider = {}\r\n        ) {\r\n            listOf(\"День\", \"Неделя\", \"Месяц\").forEachIndexed { i, label ->\r\n                Tab(\r\n                    selected = i == mode.ordinal,\r\n                    onClick = { onModeChange(CalendarMode.values()[i]) },\r\n                    text = { Text(label) }\r\n                )\r\n            }\r\n        }\r\n        if (mode == CalendarMode.DAY) {\r\n            DayWeekStrip(\r\n                anchor = anchor,\r\n                onSelect = onSelectDate,\r\n                modifier = Modifier.padding(top = 8.dp)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n/* --------------------------- DAY TIMELINE -------------------------------- */\r\n\r\nprivate val GridColor = Color(0xFFE9F0FF)\r\nprivate val SpineColor = Color(0xFF2D7FF9).copy(alpha = 0.6f)\r\nprivate val LabelWidth = 64.dp\r\nprivate val HourHeight = 64.dp\r\nprivate val DefaultSlotDuration: Duration = Duration.ofMinutes(60)\r\nprivate const val MinutesPerHour: Int = 60\r\nprivate const val LAST_TIMELINE_MINUTE: Int = 23 * MinutesPerHour + 30\r\nprivate const val SlotIncrementMinutes: Int = 30\r\n\r\n@Composable\r\nprivate fun DayTimeline(\r\n    date: LocalDate,\r\n    lessons: List<CalendarLesson>,\r\n    currentDateTime: ZonedDateTime,\r\n    onLessonClick: (CalendarLesson) -> Unit,\r\n    onEmptySlot: (LocalTime) -> Unit\r\n) {\r\n    val dayLessons = remember(date, lessons) { lessons }\r\n    val isToday = remember(date, currentDateTime) { currentDateTime.toLocalDate() == date }\r\n    val (startHour, endHourExclusive) = remember(dayLessons) {\r\n        computeTimelineBounds(dayLessons)\r\n    }\r\n    val hours = remember(startHour, endHourExclusive) {\r\n        (startHour until endHourExclusive).map { \"%02d:00\".format(it) }\r\n    }\r\n    val totalHeight: Dp = HourHeight * hours.size\r\n    val totalMinutes = remember(startHour, endHourExclusive) {\r\n        (endHourExclusive - startHour) * MinutesPerHour\r\n    }\r\n\r\n    val scroll = rememberScrollState()\r\n    val density = LocalDensity.current\r\n    val hourHeightPx = remember(density) { with(density) { HourHeight.toPx() } }\r\n    val labelWidthPx = remember(density) { with(density) { LabelWidth.toPx() } }\r\n    val cardInsetPx = remember(density) { with(density) { 8.dp.toPx() } }\r\n    val totalHeightPx = remember(totalHeight, density) { with(density) { totalHeight.toPx() } }\r\n    val minuteHeight = remember { HourHeight / MinutesPerHour }\r\n    val nowMinutesFromStart = remember(isToday, currentDateTime, startHour) {\r\n        if (!isToday) null else {\r\n            val currentMinutes = currentDateTime.hour * MinutesPerHour + currentDateTime.minute\r\n            currentMinutes - startHour * MinutesPerHour\r\n        }\r\n    }\r\n    val nowBadgeOffset = remember(nowMinutesFromStart, totalMinutes) {\r\n        nowMinutesFromStart?.takeIf { it in 0..totalMinutes }?.let { minutes ->\r\n            minuteHeight * minutes.toFloat()\r\n        }\r\n    }\r\n\r\n    val lessonRegions = remember(dayLessons, startHour, hourHeightPx, labelWidthPx, cardInsetPx) {\r\n        val baseMin = startHour * MinutesPerHour\r\n        dayLessons.map { lesson ->\r\n            val startTime = lesson.start.toLocalTime()\r\n            val startMin = startTime.hour * MinutesPerHour + startTime.minute\r\n            val durationMinutes = lesson.duration.toMinutes().coerceAtLeast(SlotIncrementMinutes.toLong())\r\n            val topPx = ((startMin - baseMin).coerceAtLeast(0)) * hourHeightPx / MinutesPerHour\r\n            val heightPx = durationMinutes.toFloat() * hourHeightPx / MinutesPerHour\r\n            TimelineLessonRegion(\r\n                topPx = topPx,\r\n                bottomPx = topPx + heightPx,\r\n                leftPx = labelWidthPx + cardInsetPx\r\n            )\r\n        }\r\n    }\r\n\r\n    // ВЕСЬ день = одна большая \"простыня\" высотой totalHeight; она вертикально скроллится\r\n    Box(\r\n        Modifier\r\n            .fillMaxSize()\r\n            .verticalScroll(scroll)\r\n    ) {\r\n        // Внутренний контейнер фиксированной высоты = весь день\r\n        Box(\r\n            Modifier\r\n                .fillMaxWidth()\r\n                .height(totalHeight)\r\n                .padding(horizontal = 8.dp)\r\n                .pointerInput(dayLessons, startHour, endHourExclusive, lessonRegions) {\r\n                    detectTapGestures { offset ->\r\n                        if (offset.x < labelWidthPx) return@detectTapGestures\r\n                        if (lessonRegions.any { region -> offset.x >= region.leftPx && offset.y in region.topPx..region.bottomPx }) {\r\n                            return@detectTapGestures\r\n                        }\r\n\r\n                        val clampedY = offset.y.coerceIn(0f, totalHeightPx)\r\n                        val minutesWithin = (clampedY / hourHeightPx) * MinutesPerHour\r\n                        val candidate = (startHour * MinutesPerHour) + minutesWithin.roundToInt()\r\n                        val normalized = candidate.coerceIn(0, LAST_TIMELINE_MINUTE)\r\n                        val rounded = (normalized / SlotIncrementMinutes) * SlotIncrementMinutes\r\n                        val hour = rounded / MinutesPerHour\r\n                        val minute = rounded % MinutesPerHour\r\n                        onEmptySlot(LocalTime.of(hour, minute))\r\n                    }\r\n                }\r\n        ) {\r\n            // 1) Сетка фоном\r\n            Canvas(Modifier.matchParentSize()) {\r\n                val rowH = HourHeight.toPx()\r\n                val leftPad = LabelWidth.toPx()\r\n                val spineW = 2.dp.toPx()\r\n\r\n                repeat(hours.size + 1) { i ->\r\n                    val y = i * rowH\r\n                    drawLine(\r\n                        color = GridColor,\r\n                        start = androidx.compose.ui.geometry.Offset(0f, y),\r\n                        end = androidx.compose.ui.geometry.Offset(size.width, y),\r\n                        strokeWidth = 1.dp.toPx()\r\n                    )\r\n                }\r\n                drawRect(\r\n                    color = SpineColor,\r\n                    topLeft = androidx.compose.ui.geometry.Offset(leftPad, 0f),\r\n                    size = androidx.compose.ui.geometry.Size(spineW, size.height)\r\n                )\r\n                nowMinutesFromStart?.takeIf { it in 0..totalMinutes }?.let { minutes ->\r\n                    val y = minutes * rowH / MinutesPerHour\r\n                    drawLine(\r\n                        color = NowRed,\r\n                        start = androidx.compose.ui.geometry.Offset(0f, y),\r\n                        end = androidx.compose.ui.geometry.Offset(size.width, y),\r\n                        strokeWidth = 2.dp.toPx()\r\n                    )\r\n                }\r\n            }\r\n\r\n            // 2) Уроки — точное позиционирование по времени, до правого края\r\n            dayLessons.forEach { lesson ->\n                LessonBlock(\n                    lesson = lesson,\n                    baseHour = startHour,\n                    hourHeight = HourHeight,\n                    now = currentDateTime,\n                    onLessonClick = onLessonClick\n                )\n            }\n\r\n            // 3) Метки времени слева\r\n            Column(\r\n                Modifier\r\n                    .fillMaxHeight()\r\n                    .width(LabelWidth)\r\n            ) {\r\n                hours.forEach {\r\n                    Box(\r\n                        Modifier\r\n                            .height(HourHeight),\r\n                        contentAlignment = Alignment.TopStart\r\n                    ) {\r\n                        Text(it, style = MaterialTheme.typography.labelLarge)\r\n                    }\r\n                }\r\n            }\r\n\r\n            nowBadgeOffset?.let { offset ->\r\n                val centered = offset - 12.dp\r\n                val badgeOffset = if (centered < 0.dp) 0.dp else centered\r\n                Box(\r\n                    Modifier\r\n                        .fillMaxWidth()\r\n                        .offset(y = badgeOffset)\r\n                ) {\r\n                    NowBadge(\n                        modifier = Modifier\n                            .align(Alignment.CenterStart)\n                            .padding(start = 8.dp)\n                    )\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nprivate data class TimelineLessonRegion(\r\n    val topPx: Float,\r\n    val bottomPx: Float,\r\n    val leftPx: Float\r\n)\r\n\r\n@Composable\r\nprivate fun LessonBlock(\n    lesson: CalendarLesson,\n    baseHour: Int,\n    hourHeight: Dp,\n    now: ZonedDateTime,\n    onLessonClick: (CalendarLesson) -> Unit\n) {\n    val startTime = lesson.start.toLocalTime()\r\n    val endTime = lesson.end.toLocalTime()\r\n    val startMin = startTime.hour * 60 + startTime.minute\r\n    val baseMin = baseHour * 60\r\n    val durationMinutes = lesson.duration.toMinutes().coerceAtLeast(SlotIncrementMinutes.toLong())\r\n\r\n    // Переводим минуты в dp (1 мин = hourHeight/60)\r\n    val minuteDp = hourHeight / 60f\r\n    val top = minuteDp * (startMin - baseMin)\r\n    val height = minuteDp * durationMinutes.toInt()\r\n\r\n    val subject = lesson.subjectName?.takeIf { it.isNotBlank() }?.trim()\n    val grade = lesson.studentGrade?.takeIf { it.isNotBlank() }?.trim()\n    val firstLine = remember(lesson.studentName, subject, grade) {\n        buildString {\n            append(lesson.studentName)\n            val extras = listOfNotNull(subject, grade)\n            if (extras.isNotEmpty()) {\n                append(\" • \")\n                append(extras.joinToString(\" • \"))\n            }\n        }\n    }\n    val statusInfo = lesson.statusPresentation(now)\n    val containerColor = lesson.subjectColorArgb?.let { Color(it).copy(alpha = 0.12f) }\n        ?: MaterialTheme.colorScheme.primary.copy(alpha = 0.08f)\n\n    Box(\n        Modifier\n            .fillMaxWidth()\r\n            .offset(y = top)\r\n            .height(height)\r\n            .padding(start = LabelWidth + 8.dp, end = 8.dp) // от оси до правого края\r\n    ) {\r\n        Card(\n            onClick = { onLessonClick(lesson) },\n            shape = MaterialTheme.shapes.medium,\n            colors = CardDefaults.cardColors(\n                containerColor = containerColor\n            ),\n            modifier = Modifier.fillMaxSize()\n        ) {\n            Column(\n                Modifier\n                    .fillMaxSize()\n                    .padding(12.dp),\n                verticalArrangement = Arrangement.spacedBy(6.dp)\n            ) {\n                Text(\n                    text = firstLine,\n                    style = MaterialTheme.typography.bodyLarge,\n                    maxLines = 2,\n                    overflow = TextOverflow.Ellipsis\n                )\n                Text(\n                    text = statusInfo.text,\n                    style = MaterialTheme.typography.labelLarge,\n                    color = statusInfo.color\n                )\n            }\n        }\n    }\n}\n\r\nprivate data class LessonStatusPresentation(val text: String, val color: Color)\n\n@Composable\nprivate fun CalendarLesson.statusPresentation(now: ZonedDateTime): LessonStatusPresentation {\n    val todayColor = MaterialTheme.colorScheme.primary\n    val paidColor = MaterialTheme.colorScheme.tertiary\n    val dueColor = MaterialTheme.colorScheme.error\n    val cancelledColor = MaterialTheme.colorScheme.outline\n\n    val status = paymentStatus\n    val text: String\n    val color: Color\n\n    if (status == PaymentStatus.CANCELLED) {\n        text = stringResource(R.string.lesson_status_cancelled)\n        color = cancelledColor\n    } else if (now.isBefore(start)) {\n        if (status == PaymentStatus.PAID) {\n            text = stringResource(R.string.calendar_status_prepaid)\n            color = paidColor\n        } else {\n            text = stringResource(R.string.calendar_status_planned)\n            color = todayColor\n        }\n    } else if (now.isAfter(end)) {\n        if (status == PaymentStatus.PAID) {\n            text = stringResource(R.string.lesson_status_paid)\n            color = paidColor\n        } else {\n            text = stringResource(R.string.lesson_status_due)\n            color = dueColor\n        }\n    } else {\n        text = stringResource(R.string.calendar_status_in_progress)\n        color = todayColor\n    }\n\n    return LessonStatusPresentation(text = text, color = color)\n}\n\r\n@Composable\r\nprivate fun NowBadge(modifier: Modifier = Modifier) {\r\n    Surface(\r\n        color = NowRed,\r\n        contentColor = Color.White,\r\n        shape = MaterialTheme.shapes.small,\r\n        modifier = modifier\r\n    ) {\r\n        Text(\r\n            text = stringResource(R.string.calendar_now_badge),\r\n            style = MaterialTheme.typography.labelSmall,\r\n            modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)\r\n        )\r\n    }\r\n}\r\n\r\nprivate fun computeTimelineBounds(lessons: List<CalendarLesson>): Pair<Int, Int> {\r\n    val defaultStart = 9\r\n    val defaultEnd = 21\r\n    if (lessons.isEmpty()) return defaultStart to defaultEnd\r\n\r\n    val earliestMinutes = lessons.minOf { it.start.hour * 60 + it.start.minute }\r\n    val latestMinutes = lessons.maxOf { it.end.hour * 60 + it.end.minute }\r\n    val startHour = min(defaultStart, earliestMinutes / 60)\r\n    val endHourExclusive = max(defaultEnd, ((latestMinutes + 59) / 60))\r\n    return startHour to max(endHourExclusive, startHour + 1)\r\n}\r\n\r\n/* ----------------------------- MONTH GRID -------------------------------- */\n\n@Composable\nprivate fun MonthCalendar(\n    anchor: LocalDate,\n    lessonsByDate: Map<LocalDate, List<CalendarLesson>>,\n    currentDateTime: ZonedDateTime,\n    onDaySelected: (LocalDate) -> Unit\n) {\n    val month = remember(anchor) { YearMonth.from(anchor) }\n    val firstDay = remember(month) { month.atDay(1) }\n    val lastDay = remember(month) { month.atEndOfMonth() }\n    val rangeStart = remember(firstDay) { firstDay.with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY)) }\n    val rangeEnd = remember(lastDay) { lastDay.with(TemporalAdjusters.nextOrSame(DayOfWeek.SUNDAY)) }\n    val days = remember(rangeStart, rangeEnd) {\n        generateSequence(rangeStart) { it.plusDays(1) }\n            .takeWhile { !it.isAfter(rangeEnd) }\n            .toList()\n    }\n    val today = remember(currentDateTime) { currentDateTime.toLocalDate() }\n    val weekDays = remember {\n        listOf(\n            DayOfWeek.MONDAY,\n            DayOfWeek.TUESDAY,\n            DayOfWeek.WEDNESDAY,\n            DayOfWeek.THURSDAY,\n            DayOfWeek.FRIDAY,\n            DayOfWeek.SATURDAY,\n            DayOfWeek.SUNDAY\n        )\n    }\n\n    Column(Modifier.fillMaxSize()) {\n        Row(\n            modifier = Modifier\n                .fillMaxWidth()\n                .padding(horizontal = 12.dp, vertical = 4.dp),\n            horizontalArrangement = Arrangement.SpaceBetween\n        ) {\n            weekDays.forEach { dayOfWeek ->\n                val label = dayOfWeek.getDisplayName(TextStyle.NARROW_STANDALONE, Locale(\"ru\"))\n                    .uppercase(Locale(\"ru\"))\n                Text(\n                    text = label,\n                    style = MaterialTheme.typography.labelSmall,\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\n                    modifier = Modifier.weight(1f),\n                    textAlign = TextAlign.Center\n                )\n            }\n        }\n\n        LazyVerticalGrid(\n            columns = GridCells.Fixed(7),\n            modifier = Modifier.fillMaxSize(),\n            contentPadding = PaddingValues(horizontal = 8.dp, vertical = 8.dp),\n            verticalArrangement = Arrangement.spacedBy(8.dp),\n            horizontalArrangement = Arrangement.spacedBy(8.dp)\n        ) {\n            items(days) { date ->\n                val lessons = lessonsByDate[date].orEmpty()\n                MonthDayCell(\n                    date = date,\n                    inCurrentMonth = date.month == month.month,\n                    isToday = date == today,\n                    lessons = lessons,\n                    onClick = { onDaySelected(date) }\n                )\n            }\n        }\n    }\n}\n\n@Composable\nprivate fun MonthDayCell(\n    date: LocalDate,\n    inCurrentMonth: Boolean,\n    isToday: Boolean,\n    lessons: List<CalendarLesson>,\n    onClick: () -> Unit\n) {\n    val containerColor = when {\n        isToday -> MaterialTheme.colorScheme.primary.copy(alpha = 0.12f)\n        lessons.isNotEmpty() -> MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.35f)\n        else -> Color.Transparent\n    }\n    val border = if (isToday) BorderStroke(1.dp, MaterialTheme.colorScheme.primary) else null\n    val contentColor = if (inCurrentMonth) {\n        MaterialTheme.colorScheme.onSurface\n    } else {\n        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f)\n    }\n\n    Surface(\n        color = containerColor,\n        shape = MaterialTheme.shapes.medium,\n        border = border,\n        modifier = Modifier\n            .aspectRatio(1f)\n            .clip(MaterialTheme.shapes.medium)\n            .clickable(onClick = onClick)\n    ) {\n        Column(\n            modifier = Modifier\n                .fillMaxSize()\n                .padding(8.dp),\n            verticalArrangement = Arrangement.SpaceBetween\n        ) {\n            Text(\n                text = date.dayOfMonth.toString(),\n                style = MaterialTheme.typography.bodyMedium,\n                color = contentColor\n            )\n            if (lessons.isNotEmpty()) {\n                Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {\n                    lessons.take(2).forEach { lesson ->\n                        Text(\n                            text = lesson.studentName,\n                            style = MaterialTheme.typography.labelSmall,\n                            color = contentColor,\n                            maxLines = 1,\n                            overflow = TextOverflow.Ellipsis\n                        )\n                    }\n                    val remaining = lessons.size - min(lessons.size, 2)\n                    if (remaining > 0) {\n                        Text(\n                            text = \"+$remaining\",\n                            style = MaterialTheme.typography.labelSmall,\n                            color = contentColor.copy(alpha = 0.8f)\n                        )\n                    }\n                }\n            }\n        }\n    }\n}\n\r\n/* --------------------------- DAY/WEEK STRIP ------------------------------ */\r\n\r\n@Composable\r\nfun DayWeekStrip(\r\n    anchor: LocalDate,\r\n    onSelect: (LocalDate) -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val monday = anchor.with(DayOfWeek.MONDAY)\r\n    val days = remember(monday) { (0..6).map { monday.plusDays(it.toLong()) } }\r\n\r\n    Row(modifier.padding(top = 8.dp)) {\r\n        days.forEachIndexed { idx, d ->\r\n            val selected = d == anchor\r\n            DayTwoLineChip(\r\n                date = d,\r\n                selected = selected,\r\n                onClick = { onSelect(d) },\r\n                modifier = Modifier\r\n                    .weight(1f)\r\n                    .height(48.dp)\r\n                    .then(if (idx < days.lastIndex) Modifier.padding(end = 8.dp) else Modifier)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun DayTwoLineChip(\r\n    date: LocalDate,\r\n    selected: Boolean,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val bg = if (selected) Color(0x1A2D7FF9) else Color(0xFFF2F3F7)\r\n    val fg = if (selected) Color(0xFF2D7FF9) else MaterialTheme.colorScheme.onSurface.copy(alpha = 0.8f)\r\n    Surface(\r\n        color = bg,\r\n        shape = MaterialTheme.shapes.medium,\r\n        onClick = onClick,\r\n        modifier = modifier\r\n    ) {\r\n        Column(\r\n            Modifier\r\n                .fillMaxSize()\r\n                .padding(horizontal = 8.dp),\r\n            horizontalAlignment = Alignment.CenterHorizontally,\r\n            verticalArrangement = Arrangement.Center\r\n        ) {\r\n            Text(\r\n                date.dayOfWeek.getDisplayName(TextStyle.SHORT, Locale(\"ru\"))\r\n                    .replaceFirstChar { it.titlecase(Locale(\"ru\")) },\r\n                style = MaterialTheme.typography.labelSmall,\r\n                color = fg\r\n            )\r\n            Text(\r\n                \"${date.dayOfMonth}\",\r\n                style = MaterialTheme.typography.labelLarge,\r\n                color = fg\r\n            )\r\n        }\r\n    }\r\n}\r\n//    LessonCardSheet(\r\n//        state = lessonCardState,\r\n//        zoneId = uiState.zoneId,\r\n//        onDismissRequest = lessonCardViewModel::requestDismiss,\r\n//        onCancelDismiss = lessonCardViewModel::cancelDismiss,\r\n//        onConfirmDismiss = lessonCardViewModel::confirmDismiss,\r\n//        onNoteChange = lessonCardViewModel::onNoteChange,\r\n//        onSaveNote = lessonCardViewModel::saveNote,\r\n//        onMarkPaid = lessonCardViewModel::markPaid,\r\n//        onRequestMarkDue = lessonCardViewModel::requestMarkDue,\r\n//        onDismissMarkDue = lessonCardViewModel::dismissMarkDueDialog,\r\n//        onConfirmMarkDue = lessonCardViewModel::confirmMarkDue,\r\n//        onRequestEdit = lessonCardViewModel::requestEdit,\r\n//        onSnackbarConsumed = lessonCardViewModel::consumeSnackbar\r\n//    )\r\n//\r\n//    val pendingExit = lessonCardState.pendingExitAction\r\n//    LaunchedEffect(pendingExit) {\r\n//        when (pendingExit) {\r\n//            is LessonCardExitAction.NavigateToEdit -> {\r\n//                val details = pendingExit.details\r\n//                onLessonDetails(\r\n//                    details.id,\r\n//                    details.studentId,\r\n//                    details.startAt.atZone(uiState.zoneId)\r\n//                )\r\n//                lessonCardViewModel.consumeExitAction()\r\n//            }\r\n//            LessonCardExitAction.Close -> {\r\n//                lessonCardViewModel.consumeExitAction()\r\n//            }\r\n//            null -> Unit\r\n//        }\r\n//    }\r\n
-Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
-<+>UTF-8
-===================================================================
-diff --git a/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt b/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt
---- a/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt	(revision 54f423004fd990cdd5fec46b320232a9dfe77a35)
-+++ b/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt	(date 1760130384661)
-@@ -10,6 +10,7 @@
- import androidx.compose.animation.togetherWith
- import androidx.compose.foundation.BorderStroke
- import androidx.compose.foundation.Canvas
-+import androidx.compose.foundation.clickable
- import androidx.compose.foundation.gestures.detectHorizontalDragGestures
- import androidx.compose.foundation.gestures.detectTapGestures
- import androidx.compose.foundation.layout.*
-@@ -25,6 +26,7 @@
- import androidx.compose.runtime.collectAsState
- import androidx.compose.ui.Alignment
- import androidx.compose.ui.Modifier
-+import androidx.compose.ui.draw.clip
- import androidx.compose.ui.draw.clipToBounds
- import androidx.compose.ui.graphics.Color
- import androidx.compose.ui.input.pointer.pointerInput
-Index: app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt
-IDEA additional info:
-Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
-<+>package com.tutorly.ui.screens\r\n\r\nimport androidx.compose.foundation.BorderStroke\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.horizontalScroll\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.Column\r\nimport androidx.compose.foundation.layout.PaddingValues\r\nimport androidx.compose.foundation.layout.Row\r\nimport androidx.compose.foundation.layout.Spacer\r\nimport androidx.compose.foundation.layout.fillMaxSize\r\nimport androidx.compose.foundation.layout.fillMaxWidth\r\nimport androidx.compose.foundation.layout.height\r\nimport androidx.compose.foundation.layout.navigationBarsPadding\r\nimport androidx.compose.foundation.layout.imePadding\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.layout.size\r\nimport androidx.compose.foundation.layout.width\r\nimport androidx.compose.foundation.lazy.LazyColumn\r\nimport androidx.compose.foundation.lazy.items\r\nimport androidx.compose.foundation.lazy.rememberLazyListState\r\nimport androidx.compose.foundation.shape.CircleShape\r\nimport androidx.compose.material.icons.Icons\r\nimport androidx.compose.material.icons.filled.Add\r\nimport androidx.compose.material.icons.filled.Edit\r\nimport androidx.compose.material.icons.filled.Search\r\nimport androidx.compose.material.icons.outlined.Email\r\nimport androidx.compose.material.icons.outlined.Phone\r\nimport androidx.compose.material3.Button\r\nimport androidx.compose.material3.Card\r\nimport androidx.compose.material3.CardDefaults\r\nimport androidx.compose.material3.CircularProgressIndicator\r\nimport androidx.compose.material3.ExtendedFloatingActionButton\r\nimport androidx.compose.material3.ExperimentalMaterial3Api\r\nimport androidx.compose.material3.FloatingActionButton\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.ModalBottomSheet\r\nimport androidx.compose.material3.OutlinedButton\r\nimport androidx.compose.material3.OutlinedTextField\r\nimport androidx.compose.material3.Scaffold\r\nimport androidx.compose.material3.SnackbarHost\r\nimport androidx.compose.material3.SnackbarHostState\r\nimport androidx.compose.material3.Surface\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.material3.IconButton\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.foundation.rememberScrollState\r\nimport androidx.compose.runtime.rememberCoroutineScope\r\nimport androidx.compose.runtime.saveable.rememberSaveable\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.draw.clip\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.style.TextAlign\r\nimport androidx.compose.ui.text.style.TextOverflow\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.compose.ui.unit.Dp\r\nimport androidx.hilt.navigation.compose.hiltViewModel\r\nimport androidx.compose.material3.BottomSheetDefaults\r\nimport androidx.compose.material3.rememberModalBottomSheetState\r\nimport androidx.compose.runtime.LaunchedEffect\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.setValue\r\nimport com.tutorly.R\r\nimport com.tutorly.domain.model.StudentProfile\r\nimport com.tutorly.domain.model.StudentProfileLesson\r\nimport com.tutorly.models.PaymentStatus\r\nimport com.tutorly.ui.components.PaymentBadge\r\nimport kotlinx.coroutines.launch\r\nimport java.text.NumberFormat\r\nimport java.time.ZoneId\r\nimport java.time.ZonedDateTime\r\nimport java.time.YearMonth\r\nimport java.time.format.DateTimeFormatter\r\nimport java.util.Currency\r\nimport java.util.Locale\r\n\r\n@OptIn(ExperimentalMaterial3Api::class)\r\n@Composable\r\nfun StudentsScreen(\r\n    onStudentEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onLessonDetails: (Long, Long, ZonedDateTime) -> Unit,\r\n    onStudentCreatedFromLesson: (Long) -> Unit = {},\r\n    initialEditorOrigin: StudentEditorOrigin = StudentEditorOrigin.NONE,\r\n    modifier: Modifier = Modifier,\r\n    vm: StudentsViewModel = hiltViewModel(),\r\n) {\r\n    val query by vm.query.collectAsState()\r\n    val students by vm.students.collectAsState()\r\n    val formState by vm.editorFormState.collectAsState()\r\n    val profileUiState by vm.profileUiState.collectAsState()\r\n    val snackbarHostState = remember { SnackbarHostState() }\r\n    val coroutineScope = rememberCoroutineScope()\r\n    val context = LocalContext.current\r\n    val editorSheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)\r\n    val profileSheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)\r\n    var showEditor by rememberSaveable { mutableStateOf(false) }\r\n    var editorOrigin by rememberSaveable { mutableStateOf(StudentEditorOrigin.NONE) }\r\n    var pendingProfileId by remember { mutableStateOf<Long?>(null) }\r\n\r\n    val openCreationEditor: (StudentEditorOrigin) -> Unit = { origin ->\r\n        editorOrigin = origin\r\n        pendingProfileId = null\r\n        vm.startStudentCreation()\r\n        showEditor = true\r\n    }\r\n\r\n    LaunchedEffect(initialEditorOrigin) {\r\n        if (initialEditorOrigin != StudentEditorOrigin.NONE) {\r\n            editorOrigin = initialEditorOrigin\r\n            pendingProfileId = null\r\n            vm.startStudentCreation()\r\n            showEditor = true\r\n        }\r\n    }\r\n\r\n    val closeEditor = {\r\n        showEditor = false\r\n        vm.resetStudentForm()\r\n        editorOrigin = StudentEditorOrigin.NONE\r\n    }\r\n\r\n    val handleSave = {\r\n        if (!formState.isSaving) {\r\n            vm.submitStudent(\r\n                onSuccess = { id, name, isNew ->\r\n                    closeEditor()\r\n                    val message = if (isNew) {\r\n                        context.getString(R.string.student_added_message, name)\r\n                    } else {\r\n                        context.getString(R.string.student_updated_message, name)\r\n                    }\r\n                    coroutineScope.launch { snackbarHostState.showSnackbar(message) }\r\n                    if (isNew) {\r\n                        if (editorOrigin == StudentEditorOrigin.LESSON_CREATION) {\r\n                            onStudentCreatedFromLesson(id)\r\n                        }\r\n                    } else {\r\n                        pendingProfileId?.let { vm.openStudentProfile(it) }\r\n                    }\r\n                    pendingProfileId = null\r\n                },\r\n                onError = { error ->\r\n                    val message = if (error.isNotBlank()) {\r\n                        error\r\n                    } else {\r\n                        context.getString(R.string.student_editor_save_error)\r\n                    }\r\n                    coroutineScope.launch { snackbarHostState.showSnackbar(message) }\r\n                }\r\n            )\r\n        }\r\n    }\r\n\r\n    Scaffold(\r\n        modifier = modifier,\r\n        snackbarHost = { SnackbarHost(hostState = snackbarHostState) },\r\n        containerColor = MaterialTheme.colorScheme.surface,\r\n        floatingActionButton = {\r\n            FloatingActionButton(\r\n                onClick = { openCreationEditor(StudentEditorOrigin.STUDENTS) },\r\n                containerColor = MaterialTheme.colorScheme.primary,\r\n                contentColor = MaterialTheme.colorScheme.onPrimary\r\n            ) {\r\n                Icon(\r\n                    imageVector = Icons.Default.Add,\r\n                    contentDescription = stringResource(id = R.string.add_student)\r\n                )\r\n            }\r\n        }\r\n    ) { innerPadding ->\r\n        Column(\r\n            modifier\r\n                .fillMaxSize()\r\n                .padding(innerPadding)\r\n                .padding(horizontal = 16.dp, vertical = 12.dp)\r\n        ) {\r\n            OutlinedTextField(\r\n                value = query,\r\n                onValueChange = vm::onQueryChange,\r\n                modifier = Modifier.fillMaxWidth(),\r\n                singleLine = true,\r\n                leadingIcon = { Icon(Icons.Default.Search, contentDescription = null) },\r\n                placeholder = { Text(text = stringResource(id = R.string.search_students_hint)) },\r\n                shape = MaterialTheme.shapes.large\r\n            )\r\n\r\n            Spacer(Modifier.height(16.dp))\r\n\r\n            if (students.isEmpty()) {\r\n                EmptyStudentsState(Modifier.fillMaxSize())\r\n            } else {\r\n                LazyColumn(\r\n                    modifier = Modifier.fillMaxSize(),\r\n                    verticalArrangement = Arrangement.spacedBy(12.dp),\r\n                    contentPadding = PaddingValues(bottom = 16.dp)\r\n                ) {\r\n                    items(\r\n                        items = students,\r\n                        key = { it.student.id }\r\n                    ) { item ->\r\n                        StudentCard(\r\n                            item = item,\r\n                            onClick = { vm.openStudentProfile(item.student.id) }\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if (showEditor) {\r\n        ModalBottomSheet(\r\n            onDismissRequest = {\r\n                if (!formState.isSaving) {\r\n                    pendingProfileId = null\r\n                    closeEditor()\r\n                }\r\n            },\r\n            sheetState = editorSheetState,\r\n            dragHandle = { BottomSheetDefaults.DragHandle() }\r\n        ) {\r\n            StudentEditorSheet(\r\n                state = formState,\r\n                onNameChange = vm::onEditorNameChange,\r\n                onPhoneChange = vm::onEditorPhoneChange,\r\n                onMessengerChange = vm::onEditorMessengerChange,\r\n                onRateChange = vm::onEditorRateChange,\r\n                onSubjectChange = vm::onEditorSubjectChange,\r\n                onGradeChange = vm::onEditorGradeChange,\r\n                onNoteChange = vm::onEditorNoteChange,\r\n                onArchivedChange = vm::onEditorArchivedChange,\r\n                onActiveChange = vm::onEditorActiveChange,\r\n                onCancel = {\r\n                    if (!formState.isSaving) {\r\n                        pendingProfileId = null\r\n                        closeEditor()\r\n                    }\r\n                },\r\n                onSave = handleSave\r\n            )\r\n        }\r\n    }\r\n\r\n    if (profileUiState !is StudentProfileUiState.Hidden) {\r\n        ModalBottomSheet(\r\n            onDismissRequest = vm::clearSelectedStudent,\r\n            sheetState = profileSheetState,\r\n            dragHandle = { BottomSheetDefaults.DragHandle() }\r\n        ) {\r\n            StudentProfileSheet(\r\n                state = profileUiState,\r\n                onClose = vm::clearSelectedStudent,\r\n                onEdit = { studentId ->\r\n                    val profileStudent = (profileUiState as? StudentProfileUiState.Content)?.profile?.student\r\n                    if (profileStudent != null && profileStudent.id == studentId) {\r\n                        vm.clearSelectedStudent()\r\n                        editorOrigin = StudentEditorOrigin.STUDENTS\r\n                        pendingProfileId = studentId\r\n                        vm.startStudentEdit(profileStudent)\r\n                        showEditor = true\r\n                    } else {\r\n                        vm.clearSelectedStudent()\r\n                        onStudentEdit(studentId)\r\n                    }\r\n                },\r\n                onAddLesson = { studentId ->\r\n                    vm.clearSelectedStudent()\r\n                    onAddLesson(studentId)\r\n                },\r\n                onLessonDetails = { lessonId, studentId, start ->\r\n                    vm.clearSelectedStudent()\r\n                    onLessonDetails(lessonId, studentId, start)\r\n                }\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentEditorSheet(\r\n    state: StudentEditorFormState,\r\n    onNameChange: (String) -> Unit,\r\n    onPhoneChange: (String) -> Unit,\r\n    onMessengerChange: (String) -> Unit,\r\n    onRateChange: (String) -> Unit,\r\n    onSubjectChange: (String) -> Unit,\r\n    onGradeChange: (String) -> Unit,\r\n    onNoteChange: (String) -> Unit,\r\n    onArchivedChange: (Boolean) -> Unit,\r\n    onActiveChange: (Boolean) -> Unit,\r\n    onCancel: () -> Unit,\r\n    onSave: () -> Unit,\r\n) {\r\n    val isEditing = state.studentId != null\r\n    Column(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .navigationBarsPadding()\r\n            .imePadding()\r\n            .padding(horizontal = 24.dp, vertical = 16.dp),\r\n        verticalArrangement = Arrangement.spacedBy(20.dp)\r\n    ) {\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.SpaceBetween,\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            Text(\r\n                text = stringResource(\r\n                    id = if (isEditing) R.string.student_editor_edit_title else R.string.add_student\r\n                ),\r\n                style = MaterialTheme.typography.titleLarge\r\n            )\r\n            IconButton(onClick = onCancel, enabled = !state.isSaving) {\r\n                Icon(\r\n                    imageVector = Icons.Default.Close,\r\n                    contentDescription = stringResource(id = R.string.student_editor_close)\r\n                )\r\n            }\r\n        }\r\n\r\n        StudentEditorForm(\r\n            state = state,\r\n            onNameChange = onNameChange,\r\n            onPhoneChange = onPhoneChange,\r\n            onMessengerChange = onMessengerChange,\r\n            onRateChange = onRateChange,\r\n            onSubjectChange = onSubjectChange,\r\n            onGradeChange = onGradeChange,\r\n            onNoteChange = onNoteChange,\r\n            onArchivedChange = onArchivedChange,\r\n            onActiveChange = onActiveChange,\r\n            modifier = Modifier\r\n                .weight(1f, fill = false)\r\n                .fillMaxWidth(),\r\n            focusOnStart = true,\r\n            enabled = !state.isSaving,\r\n            onSubmit = onSave\r\n        )\r\n\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            OutlinedButton(\r\n                onClick = onCancel,\r\n                modifier = Modifier.weight(1f),\r\n                enabled = !state.isSaving\r\n            ) {\r\n                Text(text = stringResource(id = R.string.student_editor_cancel))\r\n            }\r\n\r\n            Button(\r\n                onClick = onSave,\r\n                modifier = Modifier.weight(1f),\r\n                enabled = !state.isSaving && state.name.isNotBlank()\r\n            ) {\r\n                if (state.isSaving) {\r\n                    CircularProgressIndicator(\r\n                        modifier = Modifier.size(20.dp),\r\n                        strokeWidth = 2.dp\r\n                    )\r\n                } else {\r\n                    Text(\r\n                        text = stringResource(id = R.string.student_editor_save)\r\n                    )\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun EmptyStudentsState(modifier: Modifier = Modifier) {\r\n    Box(modifier, contentAlignment = Alignment.Center) {\r\n        Text(\r\n            text = stringResource(id = R.string.students_empty_state),\r\n            style = MaterialTheme.typography.bodyMedium\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentCard(\r\n    item: StudentsViewModel.StudentListItem,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier,\r\n) {\r\n    val currencyFormatter = remember {\r\n        NumberFormat.getCurrencyInstance(Locale(\"ru\", \"RU\")).apply {\r\n            currency = Currency.getInstance(\"RUB\")\r\n        }\r\n    }\r\n    val subject = item.profile.subject?.takeIf { it.isNotBlank() }?.trim()\r\n    val grade = item.profile.grade?.takeIf { it.isNotBlank() }?.trim()\r\n    val rate = item.profile.rate?.let { formatCurrency(it.priceCents.toLong(), currencyFormatter) }\r\n    val subtitle = listOfNotNull(subject, grade, rate)\r\n        .joinToString(separator = \" • \")\r\n        .takeIf { it.isNotBlank() }\r\n\r\n    val phone = item.student.phone?.takeIf { it.isNotBlank() }?.trim()\r\n    val email = item.student.messenger?.takeIf { it.isNotBlank() }?.trim()\r\n    val showTrailingRow = phone != null || email != null || item.hasDebt\r\n\r\n    Card(\r\n        onClick = onClick,\r\n        modifier = modifier.fillMaxWidth(),\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),\r\n        border = BorderStroke(1.dp, MaterialTheme.colorScheme.outlineVariant),\r\n        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)\r\n    ) {\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 16.dp, vertical = 12.dp),\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            StudentAvatar(name = item.student.name, size = 48.dp)\r\n            Spacer(Modifier.width(12.dp))\r\n            Column(\r\n                modifier = Modifier.weight(1f),\r\n                verticalArrangement = Arrangement.spacedBy(4.dp)\r\n            ) {\r\n                Text(\r\n                    text = item.student.name,\r\n                    style = MaterialTheme.typography.titleMedium,\r\n                    fontWeight = FontWeight.Medium,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n                subtitle?.let {\r\n                    Text(\r\n                        text = it,\r\n                        style = MaterialTheme.typography.bodySmall,\r\n                        color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                        maxLines = 1,\r\n                        overflow = TextOverflow.Ellipsis\r\n                    )\r\n                }\r\n                if (showTrailingRow) {\r\n                    Row(\r\n                        modifier = Modifier\r\n                            .fillMaxWidth()\r\n                            .padding(top = 4.dp),\r\n                        horizontalArrangement = Arrangement.End,\r\n                        verticalAlignment = Alignment.CenterVertically\r\n                    ) {\r\n                        if (phone != null) {\r\n                            Icon(\r\n                                imageVector = Icons.Outlined.Phone,\r\n                                contentDescription = phone,\r\n                                tint = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                                modifier = Modifier.size(18.dp)\r\n                            )\r\n                        }\r\n                        if (email != null) {\r\n                            if (phone != null) {\r\n                                Spacer(Modifier.width(12.dp))\r\n                            }\r\n                            Icon(\r\n                                imageVector = Icons.Outlined.Email,\r\n                                contentDescription = email,\r\n                                tint = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                                modifier = Modifier.size(18.dp)\r\n                            )\r\n                        }\r\n                        if (item.hasDebt) {\r\n                            if (phone != null || email != null) {\r\n                                Spacer(Modifier.width(12.dp))\r\n                            }\r\n                            PaymentBadge(paid = false)\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nfun StudentProfileSheet(\r\n    state: StudentProfileUiState,\r\n    onClose: () -> Unit,\r\n    onEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onLessonDetails: (Long, Long, ZonedDateTime) -> Unit,\r\n    onCall: ((String) -> Unit)? = null,\r\n    onMessage: ((String) -> Unit)? = null,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    when (state) {\r\n        StudentProfileUiState.Hidden -> Unit\r\n        StudentProfileUiState.Loading -> {\r\n            Box(\r\n                modifier = modifier\r\n                    .fillMaxWidth()\r\n                    .padding(vertical = 48.dp),\r\n                contentAlignment = Alignment.Center\r\n            ) {\r\n                CircularProgressIndicator()\r\n            }\r\n        }\r\n\r\n        StudentProfileUiState.Error -> {\r\n            Column(\r\n                modifier = modifier\r\n                    .fillMaxWidth()\r\n                    .padding(horizontal = 24.dp, vertical = 32.dp),\r\n                verticalArrangement = Arrangement.spacedBy(16.dp),\r\n                horizontalAlignment = Alignment.CenterHorizontally\r\n            ) {\r\n                Text(\r\n                    text = stringResource(id = R.string.student_profile_error),\r\n                    style = MaterialTheme.typography.bodyLarge,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    textAlign = TextAlign.Center\r\n                )\r\n                Button(onClick = onClose) {\r\n                    Text(text = stringResource(id = R.string.student_editor_close))\r\n                }\r\n            }\r\n        }\r\n\r\n        is StudentProfileUiState.Content -> {\r\n            StudentProfileContent(\r\n                profile = state.profile,\r\n                onEdit = onEdit,\r\n                onAddLesson = onAddLesson,\r\n                onLessonDetails = onLessonDetails,\r\n                onCall = onCall,\r\n                onMessage = onMessage,\r\n                modifier = modifier\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileContent(\r\n    profile: StudentProfile,\r\n    onEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onLessonDetails: (Long, Long, ZonedDateTime) -> Unit,\r\n    onCall: ((String) -> Unit)?,\r\n    onMessage: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val listState = rememberLazyListState()\r\n    val locale = remember { Locale(\"ru\", \"RU\") }\r\n    val currencyFormatter = remember(locale) {\r\n        NumberFormat.getCurrencyInstance(locale).apply {\r\n            currency = Currency.getInstance(\"RUB\")\r\n        }\r\n    }\r\n    val zoneId = remember { ZoneId.systemDefault() }\r\n    val dateFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"d MMMM yyyy\", locale) }\r\n    val timeFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"HH:mm\", locale) }\r\n    val monthFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"LLLL yyyy\", locale) }\r\n\r\n    val groupedLessons = remember(profile.recentLessons, zoneId) {\r\n        val sorted = profile.recentLessons.sortedByDescending { it.startAt }\r\n        val groups = linkedMapOf<YearMonth, MutableList<StudentProfileLesson>>()\r\n        sorted.forEach { lesson ->\r\n            val key = YearMonth.from(lesson.startAt.atZone(zoneId))\r\n            groups.getOrPut(key) { mutableListOf() }.add(lesson)\r\n        }\r\n        groups.map { it.key to it.value.toList() }\r\n    }\r\n\r\n    Box(modifier = modifier.fillMaxWidth()) {\r\n        LazyColumn(\r\n            state = listState,\r\n            modifier = Modifier.fillMaxWidth(),\r\n            contentPadding = PaddingValues(start = 20.dp, end = 20.dp, top = 16.dp, bottom = 140.dp),\r\n            verticalArrangement = Arrangement.spacedBy(20.dp)\r\n        ) {\r\n            item {\r\n                StudentProfileHeader(\r\n                    profile = profile,\r\n                    onEdit = onEdit,\r\n                    currencyFormatter = currencyFormatter\r\n                )\r\n            }\r\n            item {\r\n                StudentProfileContacts(\r\n                    profile = profile,\r\n                    onCall = onCall,\r\n                    onMessage = onMessage\r\n                )\r\n            }\r\n            item {\r\n                StudentProfileMetricsSection(\r\n                    profile = profile,\r\n                    currencyFormatter = currencyFormatter\r\n                )\r\n            }\r\n            item {\r\n                Text(\r\n                    text = stringResource(id = R.string.student_details_history_title),\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n            if (profile.recentLessons.isEmpty()) {\r\n                item {\r\n                    StudentProfileEmptyHistory(\r\n                        onAddLesson = { onAddLesson(profile.student.id) }\r\n                    )\r\n                }\r\n            } else {\r\n                groupedLessons.forEach { (month, lessons) ->\r\n                    item(key = \"month-$month\") {\r\n                        val monthTitle = remember(month) {\r\n                            month.format(monthFormatter).replaceFirstChar { char ->\r\n                                if (char.isLowerCase()) char.titlecase(locale) else char.toString()\r\n                            }\r\n                        }\r\n                        Text(\r\n                            text = monthTitle,\r\n                            style = MaterialTheme.typography.titleSmall,\r\n                            color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                            modifier = Modifier.padding(top = 4.dp, bottom = 8.dp)\r\n                        )\r\n                    }\r\n                    items(lessons, key = { it.id }) { lesson ->\r\n                        StudentProfileLessonCard(\r\n                            lesson = lesson,\r\n                            fallbackSubject = profile.subject,\r\n                            currencyFormatter = currencyFormatter,\r\n                            zoneId = zoneId,\r\n                            dateFormatter = dateFormatter,\r\n                            timeFormatter = timeFormatter,\r\n                            onClick = { selected ->\r\n                                val start = selected.startAt.atZone(zoneId)\r\n                                onLessonDetails(selected.id, profile.student.id, start)\r\n                            }\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        ExtendedFloatingActionButton(\r\n            onClick = { onAddLesson(profile.student.id) },\r\n            icon = { Icon(imageVector = Icons.Filled.Add, contentDescription = null) },\r\n            text = { Text(text = stringResource(id = R.string.student_details_create_lesson)) },\r\n            modifier = Modifier\r\n                .align(Alignment.BottomEnd)\r\n                .padding(horizontal = 20.dp, vertical = 16.dp)\r\n                .navigationBarsPadding()\r\n        )\r\n    }\r\n}\r\n\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileHeader(\r\n    profile: StudentProfile,\r\n    onEdit: (Long) -> Unit,\r\n    currencyFormatter: NumberFormat,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Row(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalAlignment = Alignment.CenterVertically,\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        StudentAvatar(name = profile.student.name, size = 64.dp)\r\n        Column(\r\n            modifier = Modifier.weight(1f),\r\n            verticalArrangement = Arrangement.spacedBy(6.dp)\r\n        ) {\r\n            Text(\r\n                text = profile.student.name,\r\n                style = MaterialTheme.typography.headlineSmall,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            val subject = profile.subject?.takeIf { it.isNotBlank() }?.trim()\r\n            val grade = profile.grade?.takeIf { it.isNotBlank() }?.trim()\r\n            val details = listOfNotNull(subject, grade).joinToString(separator = \" \")\r\n            if (details.isNotEmpty()) {\r\n                Text(\r\n                    text = details,\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    maxLines = 2,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n            }\r\n            val rateText = profile.rate?.let { rate ->\r\n                val price = formatCurrency(rate.priceCents.toLong(), currencyFormatter)\r\n                if (rate.durationMinutes > 0) {\r\n                    \"$price • ${rate.durationMinutes} мин\"\r\n                } else {\r\n                    price\r\n                }\r\n            } ?: profile.student.rateCents?.takeIf { it > 0 }?.let { cents ->\r\n                formatCurrency(cents.toLong(), currencyFormatter)\r\n            }\r\n            if (!rateText.isNullOrBlank()) {\r\n                Text(\r\n                    text = rateText,\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            }\r\n        }\r\n        IconButton(onClick = { onEdit(profile.student.id) }) {\r\n            Icon(\r\n                imageVector = Icons.Filled.Edit,\r\n                contentDescription = stringResource(id = R.string.student_details_edit)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileContacts(\r\n    profile: StudentProfile,\r\n    onCall: ((String) -> Unit)?,\r\n    onMessage: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Column(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        Text(\r\n            text = stringResource(id = R.string.student_details_contact_title),\r\n            style = MaterialTheme.typography.titleMedium\r\n        )\r\n        ProfileContactRow(\r\n            icon = Icons.Outlined.Phone,\r\n            label = stringResource(id = R.string.student_profile_contact_call),\r\n            value = profile.student.phone,\r\n            onClick = onCall\r\n        )\r\n        ProfileContactRow(\r\n            icon = Icons.Outlined.Email,\r\n            label = stringResource(id = R.string.student_profile_contact_message),\r\n            value = profile.student.messenger,\r\n            onClick = onMessage\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun ProfileContactRow(\r\n    icon: androidx.compose.ui.graphics.vector.ImageVector,\r\n    label: String,\r\n    value: String?,\r\n    onClick: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val hasValue = !value.isNullOrBlank()\r\n    val displayValue = value?.takeIf { it.isNotBlank() }\r\n        ?: stringResource(id = R.string.student_profile_contact_placeholder)\r\n    val background = if (hasValue) {\r\n        MaterialTheme.colorScheme.surfaceVariant\r\n    } else {\r\n        MaterialTheme.colorScheme.surfaceContainerHighest\r\n    }\r\n    val contentColor = if (hasValue) {\r\n        MaterialTheme.colorScheme.onSurface\r\n    } else {\r\n        MaterialTheme.colorScheme.onSurfaceVariant\r\n    }\r\n\r\n    Row(\r\n        modifier = modifier\r\n            .fillMaxWidth()\r\n            .clip(MaterialTheme.shapes.large)\r\n            .background(background)\r\n            .clickable(enabled = hasValue && onClick != null) {\r\n                value?.let { onClick?.invoke(it) }\r\n            }\r\n            .padding(horizontal = 16.dp, vertical = 14.dp),\r\n        verticalAlignment = Alignment.CenterVertically,\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        Icon(\r\n            imageVector = icon,\r\n            contentDescription = null,\r\n            tint = if (hasValue) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n        Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {\r\n            Text(\r\n                text = label,\r\n                style = MaterialTheme.typography.bodySmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Text(\r\n                text = displayValue,\r\n                style = MaterialTheme.typography.bodyMedium,\r\n                color = contentColor,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileMetricsSection(\r\n    profile: StudentProfile,\r\n    currencyFormatter: NumberFormat,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val scrollState = rememberScrollState()\r\n    val metrics = profile.metrics\r\n    val totalLessons = metrics.totalLessons.toString()\r\n    val totalPaid = formatCurrency(metrics.totalPaidCents, currencyFormatter)\r\n    val paidLessons = metrics.paidLessons.toString()\r\n    val debtText = if (metrics.outstandingCents > 0) {\r\n        formatCurrency(metrics.outstandingCents, currencyFormatter)\r\n    } else {\r\n        stringResource(id = R.string.student_details_no_debt)\r\n    }\r\n\r\n    Column(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        Text(\r\n            text = stringResource(id = R.string.student_profile_metrics_title),\r\n            style = MaterialTheme.typography.titleMedium\r\n        )\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .horizontalScroll(scrollState),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_lessons),\r\n                value = totalLessons\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_paid),\r\n                value = totalPaid\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_paid_lessons),\r\n                value = paidLessons\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_debt),\r\n                value = debtText,\r\n                badge = if (profile.hasDebt) {\r\n                    {\r\n                        PaymentBadge(paid = false)\r\n                    }\r\n                } else {\r\n                    null\r\n                }\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun ProfileMetricCard(\r\n    label: String,\r\n    value: String,\r\n    modifier: Modifier = Modifier,\r\n    badge: (@Composable () -> Unit)? = null\r\n) {\r\n    Surface(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 2.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 16.dp, vertical = 12.dp),\r\n            verticalArrangement = Arrangement.spacedBy(6.dp)\r\n        ) {\r\n            Text(\r\n                text = label,\r\n                style = MaterialTheme.typography.labelMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            if (badge != null) {\r\n                Row(\r\n                    verticalAlignment = Alignment.CenterVertically,\r\n                    horizontalArrangement = Arrangement.spacedBy(8.dp)\r\n                ) {\r\n                    badge()\r\n                    Text(\r\n                        text = value,\r\n                        style = MaterialTheme.typography.bodyMedium\r\n                    )\r\n                }\r\n            } else {\r\n                Text(\r\n                    text = value,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentProfileEmptyHistory(\r\n    onAddLesson: () -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Surface(\r\n        modifier = modifier.fillMaxWidth(),\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceContainerHigh\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 20.dp, vertical = 24.dp),\r\n            horizontalAlignment = Alignment.CenterHorizontally,\r\n            verticalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(id = R.string.student_details_history_empty),\r\n                style = MaterialTheme.typography.bodyMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                textAlign = TextAlign.Center\r\n            )\r\n            Button(onClick = onAddLesson) {\r\n                Text(text = stringResource(id = R.string.student_details_create_lesson))\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileLessonCard(\r\n    lesson: StudentProfileLesson,\r\n    fallbackSubject: String?,\r\n    currencyFormatter: NumberFormat,\r\n    zoneId: ZoneId,\r\n    dateFormatter: DateTimeFormatter,\r\n    timeFormatter: DateTimeFormatter,\r\n    onClick: (StudentProfileLesson) -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val start = remember(lesson.startAt, zoneId) { lesson.startAt.atZone(zoneId) }\r\n    val end = remember(lesson.endAt, zoneId) { lesson.endAt.atZone(zoneId) }\r\n    val dateText = remember(start) { dateFormatter.format(start) }\r\n    val timeText = stringResource(\r\n        id = R.string.student_details_history_time_range,\r\n        timeFormatter.format(start),\r\n        timeFormatter.format(end),\r\n        lesson.durationMinutes\r\n    )\r\n    val fallbackSubjectText = fallbackSubject?.takeIf { it.isNotBlank() }?.trim()\r\n    val title = lesson.title?.takeIf { it.isNotBlank() }?.trim()\r\n        ?: lesson.subjectName?.takeIf { it.isNotBlank() }?.trim()\r\n        ?: fallbackSubjectText\r\n        ?: stringResource(id = R.string.lesson_card_subject_placeholder)\r\n    val amount = formatCurrency(lesson.priceCents.toLong(), currencyFormatter)\r\n    val isPaid = lesson.paymentStatus == PaymentStatus.PAID\r\n\r\n    Surface(\r\n        modifier = modifier\r\n            .fillMaxWidth()\r\n            .clickable { onClick(lesson) },\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceContainerLow\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 20.dp, vertical = 18.dp),\r\n            verticalArrangement = Arrangement.spacedBy(8.dp)\r\n        ) {\r\n            Text(\r\n                text = dateText,\r\n                style = MaterialTheme.typography.labelSmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Text(\r\n                text = title,\r\n                style = MaterialTheme.typography.titleMedium,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            Text(\r\n                text = timeText,\r\n                style = MaterialTheme.typography.bodySmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Row(\r\n                modifier = Modifier.fillMaxWidth(),\r\n                horizontalArrangement = Arrangement.SpaceBetween,\r\n                verticalAlignment = Alignment.CenterVertically\r\n            ) {\r\n                Text(\r\n                    text = amount,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n                PaymentBadge(paid = isPaid)\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\nprivate fun formatCurrency(amountCents: Long, formatter: NumberFormat): String {\r\n    return formatter.format(amountCents / 100.0)\r\n}\r\n\r\n@Composable\r\nprivate fun StudentAvatar(\r\n    name: String,\r\n    size: Dp = 48.dp,\r\n) {\r\n    val initials = remember(name) {\r\n        name\r\n            .split(\" \")\r\n            .filter { it.isNotBlank() }\r\n            .take(2)\r\n            .joinToString(separator = \"\") { it.first().uppercaseChar().toString() }\r\n            .ifEmpty { \"?\" }\r\n    }\r\n\r\n    Box(\r\n        modifier = Modifier\r\n            .size(size)\r\n            .clip(CircleShape)\r\n            .background(MaterialTheme.colorScheme.surfaceVariant),\r\n        contentAlignment = Alignment.Center\r\n    ) {\r\n        Text(\r\n            text = initials,\r\n            style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold),\r\n            color = MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n    }\r\n}\r\n
-Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
-<+>UTF-8
-===================================================================
-diff --git a/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt b/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt
---- a/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt	(revision 54f423004fd990cdd5fec46b320232a9dfe77a35)
-+++ b/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt	(date 1760132228364)
-@@ -51,6 +51,7 @@
- import androidx.compose.runtime.getValue
- import androidx.compose.runtime.mutableStateOf
- import androidx.compose.foundation.rememberScrollState
-+import androidx.compose.material.icons.filled.Close
- import androidx.compose.runtime.rememberCoroutineScope
- import androidx.compose.runtime.saveable.rememberSaveable
- import androidx.compose.ui.Alignment
Index: .idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23__Changes_.xml
===================================================================
diff --git a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23__Changes_.xml b/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23__Changes_.xml
deleted file mode 100644
--- a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23__Changes_.xml	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ /dev/null	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
@@ -1,4 +0,0 @@
-<changelist name="Uncommitted_changes_before_Update_at_11_10_2025_13_23_[Changes]" date="1760178241168" recycled="true" deleted="true">
-  <option name="PATH" value="$PROJECT_DIR$/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_23_[Changes]/shelved.patch" />
-  <option name="DESCRIPTION" value="Uncommitted changes before Update at 11.10.2025 13:23 [Changes]" />
-</changelist>
\ No newline at end of file
Index: .idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49_[Changes]/shelved.patch
===================================================================
diff --git a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49_[Changes]/shelved.patch b/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49_[Changes]/shelved.patch
deleted file mode 100644
--- a/.idea/shelf/Uncommitted_changes_before_Update_at_11_10_2025_13_49_[Changes]/shelved.patch	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ /dev/null	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
@@ -1,63 +0,0 @@
-Index: app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt
-IDEA additional info:
-Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
-<+>package com.tutorly.ui\r\n\r\nimport androidx.compose.animation.AnimatedContent\r\nimport androidx.compose.animation.ExperimentalAnimationApi\r\nimport androidx.compose.animation.core.tween\r\nimport androidx.compose.animation.fadeIn\r\nimport androidx.compose.animation.fadeOut\r\nimport androidx.compose.animation.slideInHorizontally\r\nimport androidx.compose.animation.slideOutHorizontally\r\nimport androidx.compose.animation.togetherWith\r\nimport androidx.compose.foundation.BorderStroke\nimport androidx.compose.foundation.Canvas\nimport androidx.compose.foundation.gestures.detectHorizontalDragGestures\nimport androidx.compose.foundation.gestures.detectTapGestures\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.lazy.grid.GridCells\nimport androidx.compose.foundation.lazy.grid.LazyVerticalGrid\nimport androidx.compose.foundation.lazy.grid.items\nimport androidx.compose.foundation.rememberScrollState\nimport androidx.compose.foundation.verticalScroll\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.Add\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.clipToBounds\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.input.pointer.pointerInput\nimport androidx.compose.ui.platform.LocalDensity\nimport androidx.compose.ui.res.stringResource\nimport androidx.compose.ui.text.style.TextAlign\nimport androidx.compose.ui.text.style.TextOverflow\nimport androidx.compose.ui.unit.Dp\nimport androidx.compose.ui.unit.dp\nimport androidx.hilt.navigation.compose.hiltViewModel\nimport com.tutorly.R\nimport com.tutorly.ui.CalendarEvent\nimport com.tutorly.domain.model.PaymentStatusIcon\nimport com.tutorly.models.PaymentStatus\nimport com.tutorly.ui.components.AppTopBar\nimport com.tutorly.ui.components.LessonBrief\nimport com.tutorly.ui.components.WeekMosaic\nimport com.tutorly.ui.theme.NowRed\r\nimport com.tutorly.ui.lessoncreation.LessonCreationConfig\r\nimport com.tutorly.ui.lessoncreation.LessonCreationOrigin\r\nimport com.tutorly.ui.lessoncreation.LessonCreationSheet\r\nimport com.tutorly.ui.lessoncreation.LessonCreationViewModel\r\nimport com.tutorly.ui.lessoncard.LessonCardSheet\nimport com.tutorly.ui.lessoncard.LessonCardViewModel\nimport java.time.DayOfWeek\nimport java.time.Duration\nimport java.time.LocalDate\nimport java.time.LocalTime\nimport java.time.ZonedDateTime\nimport java.time.ZoneId\nimport java.time.YearMonth\nimport java.time.format.DateTimeFormatter\nimport java.time.format.TextStyle\nimport java.time.temporal.TemporalAdjusters\nimport java.util.*\nimport kotlin.math.abs\r\nimport kotlin.math.max\r\nimport kotlin.math.min\r\nimport kotlin.math.roundToInt\r\n\r\nenum class CalendarMode { DAY, WEEK, MONTH }\r\n\r\n@OptIn(ExperimentalAnimationApi::class)\r\n@Composable\r\nfun CalendarScreen(\n    modifier: Modifier = Modifier,\n    onAddStudent: () -> Unit = {},\n    creationViewModel: LessonCreationViewModel,\n    viewModel: CalendarViewModel = hiltViewModel()\n) {\n    val uiState by viewModel.uiState.collectAsState()\r\n    val creationState by creationViewModel.uiState.collectAsState()\r\n    val lessonCardViewModel: LessonCardViewModel = hiltViewModel()\n    val lessonCardState by lessonCardViewModel.uiState.collectAsState()\n    val snackbarHostState = remember { SnackbarHostState() }\n    var direction by remember { mutableStateOf(0) } // -1 назад, +1 вперёд\n    val anchor = uiState.anchor\n    val mode = uiState.mode\n    val zoneId = remember { ZoneId.systemDefault() }\n\n    LessonCardSheet(\n        state = lessonCardState,\n        onDismissRequest = lessonCardViewModel::dismiss,\n        onStudentSelect = lessonCardViewModel::onStudentSelected,\n        onDateSelect = lessonCardViewModel::onDateSelected,\n        onTimeSelect = lessonCardViewModel::onTimeSelected,\n        onDurationSelect = lessonCardViewModel::onDurationSelected,\n        onPriceChange = lessonCardViewModel::onPriceChanged,\n        onStatusSelect = lessonCardViewModel::onPaymentStatusSelected,\n        onNoteChange = lessonCardViewModel::onNoteChanged,\n        onSnackbarConsumed = lessonCardViewModel::consumeSnackbar\n    )\n\n    LaunchedEffect(viewModel) {\n        viewModel.events.collect { event ->\n            when (event) {\n                is CalendarEvent.CreateLesson -> creationViewModel.start(\n                    LessonCreationConfig(\r\n                        start = event.start,\r\n                        duration = event.duration,\r\n                        studentId = event.studentId,\r\n                        zoneId = event.start.zone,\r\n                        origin = LessonCreationOrigin.CALENDAR\r\n                    )\r\n                )\r\n                is CalendarEvent.OpenLesson -> lessonCardViewModel.open(event.lessonId)\n            }\n        }\n    }\n\r\n    LaunchedEffect(creationState.snackbarMessage) {\r\n        creationState.snackbarMessage?.let { message ->\r\n            snackbarHostState.showSnackbar(message)\r\n            creationViewModel.consumeSnackbar()\r\n        }\r\n    }\r\n\r\n    LessonCreationSheet(\r\n        state = creationState,\r\n        onDismiss = { creationViewModel.dismiss() },\r\n        onStudentQueryChange = creationViewModel::onStudentQueryChange,\r\n        onStudentSelect = creationViewModel::onStudentSelected,\r\n        onAddStudent = {\r\n            creationViewModel.prepareForStudentCreation()\r\n            creationViewModel.dismiss()\r\n            onAddStudent()\r\n        },\r\n        onSubjectSelect = creationViewModel::onSubjectSelected,\r\n        onDateSelect = creationViewModel::onDateSelected,\r\n        onTimeSelect = creationViewModel::onTimeSelected,\r\n        onDurationChange = creationViewModel::onDurationChanged,\r\n        onPriceChange = creationViewModel::onPriceChanged,\r\n        onNoteChange = creationViewModel::onNoteChanged,\r\n        onSubmit = creationViewModel::submit,\r\n        onConfirmConflict = creationViewModel::confirmConflict,\r\n        onDismissConflict = creationViewModel::dismissConflict\r\n    )\r\n\r\n    val prevPeriod = {\r\n        direction = -1\r\n        viewModel.goToPreviousPeriod()\r\n    }\r\n    val nextPeriod = {\r\n        direction = +1\r\n        viewModel.goToNextPeriod()\r\n    }\r\n\r\n    val swipeModifier = Modifier.pointerInput(mode) {\r\n        val threshold = 48.dp.toPx()\r\n        var totalDrag = 0f\r\n        var handled = false\r\n        detectHorizontalDragGestures(\r\n            onDragStart = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onDragEnd = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onDragCancel = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onHorizontalDrag = { change, dragAmount ->\r\n                if (handled) return@detectHorizontalDragGestures\r\n\r\n                totalDrag += dragAmount\r\n                if (abs(totalDrag) > threshold) {\r\n                    if (totalDrag < 0) nextPeriod() else prevPeriod()\r\n                    handled = true\r\n                    change.consume()\r\n                }\r\n            }\r\n        )\r\n    }\r\n\r\n    Scaffold(\n        modifier = modifier,\n        topBar = {\n            AppTopBar(title = stringResource(id = R.string.calendar_title))\n        },\n        snackbarHost = { SnackbarHost(snackbarHostState) },\n        floatingActionButton = {\n            FloatingActionButton(onClick = {\n                val start = uiState.currentDateTime\n                creationViewModel.start(\n                    LessonCreationConfig(\n                        start = start,\n                        zoneId = uiState.zoneId,\n                        origin = LessonCreationOrigin.CALENDAR\n                    )\n                )\n            }) {\n                Icon(Icons.Filled.Add, contentDescription = null)\n            }\n        }\n    ) { padding ->\n        Column(\n            Modifier\n                .fillMaxSize()\n                .padding(padding)\n        ) {\n        // Хедер: тут же свайп (чтобы не конфликтовал со скроллом списка)\r\n        PlanScreenHeader(\n            anchor = anchor,\n            mode = mode,\n            onModeChange = {\n                direction = 0\n                viewModel.setMode(it)\n            },\n            onPrevPeriod = prevPeriod,\n            onNextPeriod = nextPeriod,\n            onSelectDate = { selected ->\n                direction = when {\n                    selected.isAfter(anchor) -> 1\n                    selected.isBefore(anchor) -> -1\r\n                    else -> 0\r\n                }\r\n                viewModel.selectDate(selected)\r\n            },\r\n            onSwipeLeft = nextPeriod,\r\n            onSwipeRight = prevPeriod\r\n        )\r\n\r\n        // Контент занимает остаток экрана и скроллится внутри\r\n        Box(\r\n            Modifier\r\n                .weight(1f)\r\n                .fillMaxWidth()\r\n                .clipToBounds()\r\n                .then(swipeModifier)   // \uD83D\uDC48 свайп теперь работает по всему экрану\r\n        ) {\r\n            AnimatedContent(\r\n                targetState = anchor,\r\n                modifier = Modifier.fillMaxSize(),\r\n                transitionSpec = {\r\n                    if (direction > 0) {\r\n                        // вперёд (влево)\r\n                        (slideInHorizontally(\r\n                            initialOffsetX = { fullWidth -> fullWidth },\r\n                            animationSpec = tween(durationMillis = 250)\r\n                        ) + fadeIn(animationSpec = tween(250))) togetherWith\r\n                                (slideOutHorizontally(\r\n                                    targetOffsetX = { fullWidth -> -fullWidth / 2 },\r\n                                    animationSpec = tween(durationMillis = 250)\r\n                                ) + fadeOut(animationSpec = tween(250)))\r\n                    } else {\r\n                        // назад (вправо)\r\n                        (slideInHorizontally(\r\n                            initialOffsetX = { fullWidth -> -fullWidth },\r\n                            animationSpec = tween(durationMillis = 250)\r\n                        ) + fadeIn(animationSpec = tween(250))) togetherWith\r\n                                (slideOutHorizontally(\r\n                                    targetOffsetX = { fullWidth -> fullWidth / 2 },\r\n                                    animationSpec = tween(durationMillis = 250)\r\n                                ) + fadeOut(animationSpec = tween(250)))\r\n                    }\r\n                }\r\n                ,\r\n                label = \"day-switch\"\r\n            ) { currentDate ->\r\n                val lessonsForCurrent = remember(currentDate, uiState.lessonsByDate) {\r\n                    uiState.lessonsByDate[currentDate].orEmpty()\r\n                }\r\n                when (mode) {\r\n                    CalendarMode.DAY -> DayTimeline(\r\n                        date = currentDate,\r\n                        lessons = lessonsForCurrent,\r\n                        currentDateTime = uiState.currentDateTime,\r\n                        onLessonClick = { lesson ->\r\n                            lessonCardViewModel.open(lesson.id)\r\n                        },\r\n                        onEmptySlot = { startTime ->\r\n                            viewModel.onEmptySlotSelected(currentDate, startTime, DefaultSlotDuration)\r\n                        }\r\n                    )\r\n                    CalendarMode.WEEK -> WeekMosaic(\n                        anchor = currentDate,\n                        onOpenDay = { selected ->\n                            direction = when {\n                                selected.isAfter(anchor) -> 1\n                                selected.isBefore(anchor) -> -1\n                                else -> 0\n                            }\n                            viewModel.setMode(CalendarMode.DAY)\n                            viewModel.selectDate(selected)\n                        },\n                        dayDataProvider = { date ->\n                            uiState.lessonsByDate[date].orEmpty().map { it.toLessonBrief() }\n                        },\n                        currentDateTime = uiState.currentDateTime,\n                        onLessonClick = { brief -> lessonCardViewModel.open(brief.id) }\n                    )\n                    CalendarMode.MONTH -> MonthCalendar(\n                        anchor = currentDate,\n                        lessonsByDate = uiState.lessonsByDate,\n                        currentDateTime = uiState.currentDateTime,\n                        onDaySelected = { selected ->\n                            direction = when {\n                                selected.isAfter(anchor) -> 1\n                                selected.isBefore(anchor) -> -1\n                                else -> 0\n                            }\n                            viewModel.setMode(CalendarMode.DAY)\n                            viewModel.selectDate(selected)\n                        }\n                    )\n                }\n            }\n        }\n    }\n    }\r\n}\r\n\r\nprivate fun CalendarLesson.toLessonBrief(): LessonBrief {\n    return LessonBrief(\n        id = id,\n        start = start.toLocalTime(),\n        end = end.toLocalTime(),\n        student = studentName,\n        grade = studentGrade,\n        subjectName = subjectName,\n        subjectColorArgb = subjectColorArgb\n    )\n}\n\r\n\n/* ----------------------------- HEADER ----------------------------------- */\n\r\n@Composable\r\nfun PlanScreenHeader(\n    anchor: LocalDate,\n    mode: CalendarMode,\n    onModeChange: (CalendarMode) -> Unit,\n    onPrevPeriod: () -> Unit,\n    onNextPeriod: () -> Unit,\n    onSelectDate: (LocalDate) -> Unit,\n    onSwipeLeft: () -> Unit,\n    onSwipeRight: () -> Unit\n) {\n    Column(\r\n        Modifier\r\n            .fillMaxWidth()\r\n            .padding(horizontal = 16.dp, vertical = 8.dp)\r\n            // свайп только на хедере — не мешает вертикальному скроллу списка\r\n            .pointerInput(mode) {\r\n                val threshold = 48.dp.toPx()\r\n                var totalDrag = 0f\r\n                var handled = false\r\n                detectHorizontalDragGestures(\r\n                    onDragStart = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onDragEnd = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onDragCancel = {\r\n                        totalDrag = 0f\r\n                        handled = false\r\n                    },\r\n                    onHorizontalDrag = { change, dragAmount ->\r\n                        if (handled) return@detectHorizontalDragGestures\r\n\r\n                        totalDrag += dragAmount\r\n                        if (abs(totalDrag) > threshold) {\r\n                            if (totalDrag < 0) onSwipeLeft() else onSwipeRight()\r\n                            handled = true\r\n                            change.consume()\r\n                        }\r\n                    }\r\n                )\r\n            }\r\n    ) {\r\n        Text(\n            text = anchor.format(DateTimeFormatter.ofPattern(\"LLLL yyyy\", Locale(\"ru\")))\n                .replaceFirstChar { it.titlecase(Locale(\"ru\")) },\n            style = MaterialTheme.typography.titleLarge\n        )\n        TabRow(\r\n            selectedTabIndex = mode.ordinal,\r\n            containerColor = Color.Transparent,\r\n            contentColor = MaterialTheme.colorScheme.primary,\r\n            divider = {}\r\n        ) {\r\n            listOf(\"День\", \"Неделя\", \"Месяц\").forEachIndexed { i, label ->\r\n                Tab(\r\n                    selected = i == mode.ordinal,\r\n                    onClick = { onModeChange(CalendarMode.values()[i]) },\r\n                    text = { Text(label) }\r\n                )\r\n            }\r\n        }\r\n        if (mode == CalendarMode.DAY) {\r\n            DayWeekStrip(\r\n                anchor = anchor,\r\n                onSelect = onSelectDate,\r\n                modifier = Modifier.padding(top = 8.dp)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n/* --------------------------- DAY TIMELINE -------------------------------- */\r\n\r\nprivate val GridColor = Color(0xFFE9F0FF)\r\nprivate val SpineColor = Color(0xFF2D7FF9).copy(alpha = 0.6f)\r\nprivate val LabelWidth = 64.dp\r\nprivate val HourHeight = 64.dp\r\nprivate val DefaultSlotDuration: Duration = Duration.ofMinutes(60)\r\nprivate const val MinutesPerHour: Int = 60\r\nprivate const val LAST_TIMELINE_MINUTE: Int = 23 * MinutesPerHour + 30\r\nprivate const val SlotIncrementMinutes: Int = 30\r\n\r\n@Composable\r\nprivate fun DayTimeline(\r\n    date: LocalDate,\r\n    lessons: List<CalendarLesson>,\r\n    currentDateTime: ZonedDateTime,\r\n    onLessonClick: (CalendarLesson) -> Unit,\r\n    onEmptySlot: (LocalTime) -> Unit\r\n) {\r\n    val dayLessons = remember(date, lessons) { lessons }\r\n    val isToday = remember(date, currentDateTime) { currentDateTime.toLocalDate() == date }\r\n    val (startHour, endHourExclusive) = remember(dayLessons) {\r\n        computeTimelineBounds(dayLessons)\r\n    }\r\n    val hours = remember(startHour, endHourExclusive) {\r\n        (startHour until endHourExclusive).map { \"%02d:00\".format(it) }\r\n    }\r\n    val totalHeight: Dp = HourHeight * hours.size\r\n    val totalMinutes = remember(startHour, endHourExclusive) {\r\n        (endHourExclusive - startHour) * MinutesPerHour\r\n    }\r\n\r\n    val scroll = rememberScrollState()\r\n    val density = LocalDensity.current\r\n    val hourHeightPx = remember(density) { with(density) { HourHeight.toPx() } }\r\n    val labelWidthPx = remember(density) { with(density) { LabelWidth.toPx() } }\r\n    val cardInsetPx = remember(density) { with(density) { 8.dp.toPx() } }\r\n    val totalHeightPx = remember(totalHeight, density) { with(density) { totalHeight.toPx() } }\r\n    val minuteHeight = remember { HourHeight / MinutesPerHour }\r\n    val nowMinutesFromStart = remember(isToday, currentDateTime, startHour) {\r\n        if (!isToday) null else {\r\n            val currentMinutes = currentDateTime.hour * MinutesPerHour + currentDateTime.minute\r\n            currentMinutes - startHour * MinutesPerHour\r\n        }\r\n    }\r\n    val nowBadgeOffset = remember(nowMinutesFromStart, totalMinutes) {\r\n        nowMinutesFromStart?.takeIf { it in 0..totalMinutes }?.let { minutes ->\r\n            minuteHeight * minutes.toFloat()\r\n        }\r\n    }\r\n\r\n    val lessonRegions = remember(dayLessons, startHour, hourHeightPx, labelWidthPx, cardInsetPx) {\r\n        val baseMin = startHour * MinutesPerHour\r\n        dayLessons.map { lesson ->\r\n            val startTime = lesson.start.toLocalTime()\r\n            val startMin = startTime.hour * MinutesPerHour + startTime.minute\r\n            val durationMinutes = lesson.duration.toMinutes().coerceAtLeast(SlotIncrementMinutes.toLong())\r\n            val topPx = ((startMin - baseMin).coerceAtLeast(0)) * hourHeightPx / MinutesPerHour\r\n            val heightPx = durationMinutes.toFloat() * hourHeightPx / MinutesPerHour\r\n            TimelineLessonRegion(\r\n                topPx = topPx,\r\n                bottomPx = topPx + heightPx,\r\n                leftPx = labelWidthPx + cardInsetPx\r\n            )\r\n        }\r\n    }\r\n\r\n    // ВЕСЬ день = одна большая \"простыня\" высотой totalHeight; она вертикально скроллится\r\n    Box(\r\n        Modifier\r\n            .fillMaxSize()\r\n            .verticalScroll(scroll)\r\n    ) {\r\n        // Внутренний контейнер фиксированной высоты = весь день\r\n        Box(\r\n            Modifier\r\n                .fillMaxWidth()\r\n                .height(totalHeight)\r\n                .padding(horizontal = 8.dp)\r\n                .pointerInput(dayLessons, startHour, endHourExclusive, lessonRegions) {\r\n                    detectTapGestures { offset ->\r\n                        if (offset.x < labelWidthPx) return@detectTapGestures\r\n                        if (lessonRegions.any { region -> offset.x >= region.leftPx && offset.y in region.topPx..region.bottomPx }) {\r\n                            return@detectTapGestures\r\n                        }\r\n\r\n                        val clampedY = offset.y.coerceIn(0f, totalHeightPx)\r\n                        val minutesWithin = (clampedY / hourHeightPx) * MinutesPerHour\r\n                        val candidate = (startHour * MinutesPerHour) + minutesWithin.roundToInt()\r\n                        val normalized = candidate.coerceIn(0, LAST_TIMELINE_MINUTE)\r\n                        val rounded = (normalized / SlotIncrementMinutes) * SlotIncrementMinutes\r\n                        val hour = rounded / MinutesPerHour\r\n                        val minute = rounded % MinutesPerHour\r\n                        onEmptySlot(LocalTime.of(hour, minute))\r\n                    }\r\n                }\r\n        ) {\r\n            // 1) Сетка фоном\r\n            Canvas(Modifier.matchParentSize()) {\r\n                val rowH = HourHeight.toPx()\r\n                val leftPad = LabelWidth.toPx()\r\n                val spineW = 2.dp.toPx()\r\n\r\n                repeat(hours.size + 1) { i ->\r\n                    val y = i * rowH\r\n                    drawLine(\r\n                        color = GridColor,\r\n                        start = androidx.compose.ui.geometry.Offset(0f, y),\r\n                        end = androidx.compose.ui.geometry.Offset(size.width, y),\r\n                        strokeWidth = 1.dp.toPx()\r\n                    )\r\n                }\r\n                drawRect(\r\n                    color = SpineColor,\r\n                    topLeft = androidx.compose.ui.geometry.Offset(leftPad, 0f),\r\n                    size = androidx.compose.ui.geometry.Size(spineW, size.height)\r\n                )\r\n                nowMinutesFromStart?.takeIf { it in 0..totalMinutes }?.let { minutes ->\r\n                    val y = minutes * rowH / MinutesPerHour\r\n                    drawLine(\r\n                        color = NowRed,\r\n                        start = androidx.compose.ui.geometry.Offset(0f, y),\r\n                        end = androidx.compose.ui.geometry.Offset(size.width, y),\r\n                        strokeWidth = 2.dp.toPx()\r\n                    )\r\n                }\r\n            }\r\n\r\n            // 2) Уроки — точное позиционирование по времени, до правого края\r\n            dayLessons.forEach { lesson ->\n                LessonBlock(\n                    lesson = lesson,\n                    baseHour = startHour,\n                    hourHeight = HourHeight,\n                    now = currentDateTime,\n                    onLessonClick = onLessonClick\n                )\n            }\n\r\n            // 3) Метки времени слева\r\n            Column(\r\n                Modifier\r\n                    .fillMaxHeight()\r\n                    .width(LabelWidth)\r\n            ) {\r\n                hours.forEach {\r\n                    Box(\r\n                        Modifier\r\n                            .height(HourHeight),\r\n                        contentAlignment = Alignment.TopStart\r\n                    ) {\r\n                        Text(it, style = MaterialTheme.typography.labelLarge)\r\n                    }\r\n                }\r\n            }\r\n\r\n            nowBadgeOffset?.let { offset ->\r\n                val centered = offset - 12.dp\r\n                val badgeOffset = if (centered < 0.dp) 0.dp else centered\r\n                Box(\r\n                    Modifier\r\n                        .fillMaxWidth()\r\n                        .offset(y = badgeOffset)\r\n                ) {\r\n                    NowBadge(\n                        modifier = Modifier\n                            .align(Alignment.CenterStart)\n                            .padding(start = 8.dp)\n                    )\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nprivate data class TimelineLessonRegion(\r\n    val topPx: Float,\r\n    val bottomPx: Float,\r\n    val leftPx: Float\r\n)\r\n\r\n@Composable\r\nprivate fun LessonBlock(\n    lesson: CalendarLesson,\n    baseHour: Int,\n    hourHeight: Dp,\n    now: ZonedDateTime,\n    onLessonClick: (CalendarLesson) -> Unit\n) {\n    val startTime = lesson.start.toLocalTime()\r\n    val endTime = lesson.end.toLocalTime()\r\n    val startMin = startTime.hour * 60 + startTime.minute\r\n    val baseMin = baseHour * 60\r\n    val durationMinutes = lesson.duration.toMinutes().coerceAtLeast(SlotIncrementMinutes.toLong())\r\n\r\n    // Переводим минуты в dp (1 мин = hourHeight/60)\r\n    val minuteDp = hourHeight / 60f\r\n    val top = minuteDp * (startMin - baseMin)\r\n    val height = minuteDp * durationMinutes.toInt()\r\n\r\n    val subject = lesson.subjectName?.takeIf { it.isNotBlank() }?.trim()\n    val grade = lesson.studentGrade?.takeIf { it.isNotBlank() }?.trim()\n    val firstLine = remember(lesson.studentName, subject, grade) {\n        buildString {\n            append(lesson.studentName)\n            val extras = listOfNotNull(subject, grade)\n            if (extras.isNotEmpty()) {\n                append(\" • \")\n                append(extras.joinToString(\" • \"))\n            }\n        }\n    }\n    val statusInfo = lesson.statusPresentation(now)\n    val containerColor = lesson.subjectColorArgb?.let { Color(it).copy(alpha = 0.12f) }\n        ?: MaterialTheme.colorScheme.primary.copy(alpha = 0.08f)\n\n    Box(\n        Modifier\n            .fillMaxWidth()\r\n            .offset(y = top)\r\n            .height(height)\r\n            .padding(start = LabelWidth + 8.dp, end = 8.dp) // от оси до правого края\r\n    ) {\r\n        Card(\n            onClick = { onLessonClick(lesson) },\n            shape = MaterialTheme.shapes.medium,\n            colors = CardDefaults.cardColors(\n                containerColor = containerColor\n            ),\n            modifier = Modifier.fillMaxSize()\n        ) {\n            Column(\n                Modifier\n                    .fillMaxSize()\n                    .padding(12.dp),\n                verticalArrangement = Arrangement.spacedBy(6.dp)\n            ) {\n                Text(\n                    text = firstLine,\n                    style = MaterialTheme.typography.bodyLarge,\n                    maxLines = 2,\n                    overflow = TextOverflow.Ellipsis\n                )\n                Text(\n                    text = statusInfo.text,\n                    style = MaterialTheme.typography.labelLarge,\n                    color = statusInfo.color\n                )\n            }\n        }\n    }\n}\n\r\nprivate data class LessonStatusPresentation(val text: String, val color: Color)\n\n@Composable\nprivate fun CalendarLesson.statusPresentation(now: ZonedDateTime): LessonStatusPresentation {\n    val todayColor = MaterialTheme.colorScheme.primary\n    val paidColor = MaterialTheme.colorScheme.tertiary\n    val dueColor = MaterialTheme.colorScheme.error\n    val cancelledColor = MaterialTheme.colorScheme.outline\n\n    val status = paymentStatus\n    val text: String\n    val color: Color\n\n    if (status == PaymentStatus.CANCELLED) {\n        text = stringResource(R.string.lesson_status_cancelled)\n        color = cancelledColor\n    } else if (now.isBefore(start)) {\n        if (status == PaymentStatus.PAID) {\n            text = stringResource(R.string.calendar_status_prepaid)\n            color = paidColor\n        } else {\n            text = stringResource(R.string.calendar_status_planned)\n            color = todayColor\n        }\n    } else if (now.isAfter(end)) {\n        if (status == PaymentStatus.PAID) {\n            text = stringResource(R.string.lesson_status_paid)\n            color = paidColor\n        } else {\n            text = stringResource(R.string.lesson_status_due)\n            color = dueColor\n        }\n    } else {\n        text = stringResource(R.string.calendar_status_in_progress)\n        color = todayColor\n    }\n\n    return LessonStatusPresentation(text = text, color = color)\n}\n\r\n@Composable\r\nprivate fun NowBadge(modifier: Modifier = Modifier) {\r\n    Surface(\r\n        color = NowRed,\r\n        contentColor = Color.White,\r\n        shape = MaterialTheme.shapes.small,\r\n        modifier = modifier\r\n    ) {\r\n        Text(\r\n            text = stringResource(R.string.calendar_now_badge),\r\n            style = MaterialTheme.typography.labelSmall,\r\n            modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)\r\n        )\r\n    }\r\n}\r\n\r\nprivate fun computeTimelineBounds(lessons: List<CalendarLesson>): Pair<Int, Int> {\r\n    val defaultStart = 9\r\n    val defaultEnd = 21\r\n    if (lessons.isEmpty()) return defaultStart to defaultEnd\r\n\r\n    val earliestMinutes = lessons.minOf { it.start.hour * 60 + it.start.minute }\r\n    val latestMinutes = lessons.maxOf { it.end.hour * 60 + it.end.minute }\r\n    val startHour = min(defaultStart, earliestMinutes / 60)\r\n    val endHourExclusive = max(defaultEnd, ((latestMinutes + 59) / 60))\r\n    return startHour to max(endHourExclusive, startHour + 1)\r\n}\r\n\r\n/* ----------------------------- MONTH GRID -------------------------------- */\n\n@Composable\nprivate fun MonthCalendar(\n    anchor: LocalDate,\n    lessonsByDate: Map<LocalDate, List<CalendarLesson>>,\n    currentDateTime: ZonedDateTime,\n    onDaySelected: (LocalDate) -> Unit\n) {\n    val month = remember(anchor) { YearMonth.from(anchor) }\n    val firstDay = remember(month) { month.atDay(1) }\n    val lastDay = remember(month) { month.atEndOfMonth() }\n    val rangeStart = remember(firstDay) { firstDay.with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY)) }\n    val rangeEnd = remember(lastDay) { lastDay.with(TemporalAdjusters.nextOrSame(DayOfWeek.SUNDAY)) }\n    val days = remember(rangeStart, rangeEnd) {\n        generateSequence(rangeStart) { it.plusDays(1) }\n            .takeWhile { !it.isAfter(rangeEnd) }\n            .toList()\n    }\n    val today = remember(currentDateTime) { currentDateTime.toLocalDate() }\n    val weekDays = remember {\n        listOf(\n            DayOfWeek.MONDAY,\n            DayOfWeek.TUESDAY,\n            DayOfWeek.WEDNESDAY,\n            DayOfWeek.THURSDAY,\n            DayOfWeek.FRIDAY,\n            DayOfWeek.SATURDAY,\n            DayOfWeek.SUNDAY\n        )\n    }\n\n    Column(Modifier.fillMaxSize()) {\n        Row(\n            modifier = Modifier\n                .fillMaxWidth()\n                .padding(horizontal = 12.dp, vertical = 4.dp),\n            horizontalArrangement = Arrangement.SpaceBetween\n        ) {\n            weekDays.forEach { dayOfWeek ->\n                val label = dayOfWeek.getDisplayName(TextStyle.NARROW_STANDALONE, Locale(\"ru\"))\n                    .uppercase(Locale(\"ru\"))\n                Text(\n                    text = label,\n                    style = MaterialTheme.typography.labelSmall,\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\n                    modifier = Modifier.weight(1f),\n                    textAlign = TextAlign.Center\n                )\n            }\n        }\n\n        LazyVerticalGrid(\n            columns = GridCells.Fixed(7),\n            modifier = Modifier.fillMaxSize(),\n            contentPadding = PaddingValues(horizontal = 8.dp, vertical = 8.dp),\n            verticalArrangement = Arrangement.spacedBy(8.dp),\n            horizontalArrangement = Arrangement.spacedBy(8.dp)\n        ) {\n            items(days) { date ->\n                val lessons = lessonsByDate[date].orEmpty()\n                MonthDayCell(\n                    date = date,\n                    inCurrentMonth = date.month == month.month,\n                    isToday = date == today,\n                    lessons = lessons,\n                    onClick = { onDaySelected(date) }\n                )\n            }\n        }\n    }\n}\n\n@Composable\nprivate fun MonthDayCell(\n    date: LocalDate,\n    inCurrentMonth: Boolean,\n    isToday: Boolean,\n    lessons: List<CalendarLesson>,\n    onClick: () -> Unit\n) {\n    val containerColor = when {\n        isToday -> MaterialTheme.colorScheme.primary.copy(alpha = 0.12f)\n        lessons.isNotEmpty() -> MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.35f)\n        else -> Color.Transparent\n    }\n    val border = if (isToday) BorderStroke(1.dp, MaterialTheme.colorScheme.primary) else null\n    val contentColor = if (inCurrentMonth) {\n        MaterialTheme.colorScheme.onSurface\n    } else {\n        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.4f)\n    }\n\n    Surface(\n        color = containerColor,\n        shape = MaterialTheme.shapes.medium,\n        border = border,\n        modifier = Modifier\n            .aspectRatio(1f)\n            .clip(MaterialTheme.shapes.medium)\n            .clickable { onClick() }\n    ) {\n        Column(\n            modifier = Modifier\n                .fillMaxSize()\n                .padding(8.dp),\n            verticalArrangement = Arrangement.SpaceBetween\n        ) {\n            Text(\n                text = date.dayOfMonth.toString(),\n                style = MaterialTheme.typography.bodyMedium,\n                color = contentColor\n            )\n            if (lessons.isNotEmpty()) {\n                Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {\n                    lessons.take(2).forEach { lesson ->\n                        Text(\n                            text = lesson.studentName,\n                            style = MaterialTheme.typography.labelSmall,\n                            color = contentColor,\n                            maxLines = 1,\n                            overflow = TextOverflow.Ellipsis\n                        )\n                    }\n                    val remaining = lessons.size - min(lessons.size, 2)\n                    if (remaining > 0) {\n                        Text(\n                            text = \"+$remaining\",\n                            style = MaterialTheme.typography.labelSmall,\n                            color = contentColor.copy(alpha = 0.8f)\n                        )\n                    }\n                }\n            }\n        }\n    }\n}\n\r\n/* --------------------------- DAY/WEEK STRIP ------------------------------ */\r\n\r\n@Composable\r\nfun DayWeekStrip(\r\n    anchor: LocalDate,\r\n    onSelect: (LocalDate) -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val monday = anchor.with(DayOfWeek.MONDAY)\r\n    val days = remember(monday) { (0..6).map { monday.plusDays(it.toLong()) } }\r\n\r\n    Row(modifier.padding(top = 8.dp)) {\r\n        days.forEachIndexed { idx, d ->\r\n            val selected = d == anchor\r\n            DayTwoLineChip(\r\n                date = d,\r\n                selected = selected,\r\n                onClick = { onSelect(d) },\r\n                modifier = Modifier\r\n                    .weight(1f)\r\n                    .height(48.dp)\r\n                    .then(if (idx < days.lastIndex) Modifier.padding(end = 8.dp) else Modifier)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun DayTwoLineChip(\r\n    date: LocalDate,\r\n    selected: Boolean,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val bg = if (selected) Color(0x1A2D7FF9) else Color(0xFFF2F3F7)\r\n    val fg = if (selected) Color(0xFF2D7FF9) else MaterialTheme.colorScheme.onSurface.copy(alpha = 0.8f)\r\n    Surface(\r\n        color = bg,\r\n        shape = MaterialTheme.shapes.medium,\r\n        onClick = onClick,\r\n        modifier = modifier\r\n    ) {\r\n        Column(\r\n            Modifier\r\n                .fillMaxSize()\r\n                .padding(horizontal = 8.dp),\r\n            horizontalAlignment = Alignment.CenterHorizontally,\r\n            verticalArrangement = Arrangement.Center\r\n        ) {\r\n            Text(\r\n                date.dayOfWeek.getDisplayName(TextStyle.SHORT, Locale(\"ru\"))\r\n                    .replaceFirstChar { it.titlecase(Locale(\"ru\")) },\r\n                style = MaterialTheme.typography.labelSmall,\r\n                color = fg\r\n            )\r\n            Text(\r\n                \"${date.dayOfMonth}\",\r\n                style = MaterialTheme.typography.labelLarge,\r\n                color = fg\r\n            )\r\n        }\r\n    }\r\n}\r\n
-Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
-<+>UTF-8
-===================================================================
-diff --git a/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt b/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt
---- a/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt	(revision 5a5d2381924feba4c0c6d16382ccd2363c0a1233)
-+++ b/app/src/main/java/com/tutorly/ui/screens/CalendarScreen.kt	(date 1760178241062)
-@@ -10,6 +10,7 @@
- import androidx.compose.animation.togetherWith
- import androidx.compose.foundation.BorderStroke
- import androidx.compose.foundation.Canvas
-+import androidx.compose.foundation.clickable
- import androidx.compose.foundation.gestures.detectHorizontalDragGestures
- import androidx.compose.foundation.gestures.detectTapGestures
- import androidx.compose.foundation.layout.*
-@@ -25,6 +26,7 @@
- import androidx.compose.runtime.collectAsState
- import androidx.compose.ui.Alignment
- import androidx.compose.ui.Modifier
-+import androidx.compose.ui.draw.clip
- import androidx.compose.ui.draw.clipToBounds
- import androidx.compose.ui.graphics.Color
- import androidx.compose.ui.input.pointer.pointerInput
-Index: app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt
-IDEA additional info:
-Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
-<+>package com.tutorly.ui.screens\r\n\r\nimport androidx.compose.foundation.BorderStroke\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.horizontalScroll\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.Column\r\nimport androidx.compose.foundation.layout.PaddingValues\r\nimport androidx.compose.foundation.layout.Row\r\nimport androidx.compose.foundation.layout.Spacer\r\nimport androidx.compose.foundation.layout.fillMaxSize\r\nimport androidx.compose.foundation.layout.fillMaxWidth\r\nimport androidx.compose.foundation.layout.height\r\nimport androidx.compose.foundation.layout.navigationBarsPadding\r\nimport androidx.compose.foundation.layout.imePadding\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.layout.size\r\nimport androidx.compose.foundation.layout.width\r\nimport androidx.compose.foundation.lazy.LazyColumn\r\nimport androidx.compose.foundation.lazy.items\r\nimport androidx.compose.foundation.lazy.rememberLazyListState\r\nimport androidx.compose.foundation.shape.CircleShape\r\nimport androidx.compose.material.icons.Icons\r\nimport androidx.compose.material.icons.filled.Add\r\nimport androidx.compose.material.icons.filled.Edit\r\nimport androidx.compose.material.icons.filled.Search\r\nimport androidx.compose.material.icons.outlined.Email\r\nimport androidx.compose.material.icons.outlined.Phone\r\nimport androidx.compose.material3.Button\r\nimport androidx.compose.material3.Card\r\nimport androidx.compose.material3.CardDefaults\r\nimport androidx.compose.material3.CircularProgressIndicator\r\nimport androidx.compose.material3.ExtendedFloatingActionButton\r\nimport androidx.compose.material3.ExperimentalMaterial3Api\r\nimport androidx.compose.material3.FloatingActionButton\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.ModalBottomSheet\r\nimport androidx.compose.material3.OutlinedButton\r\nimport androidx.compose.material3.OutlinedTextField\r\nimport androidx.compose.material3.Scaffold\r\nimport androidx.compose.material3.SnackbarHost\r\nimport androidx.compose.material3.SnackbarHostState\r\nimport androidx.compose.material3.Surface\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.material3.IconButton\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.foundation.rememberScrollState\r\nimport androidx.compose.runtime.rememberCoroutineScope\r\nimport androidx.compose.runtime.saveable.rememberSaveable\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.draw.clip\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.style.TextAlign\r\nimport androidx.compose.ui.text.style.TextOverflow\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.compose.ui.unit.Dp\r\nimport androidx.hilt.navigation.compose.hiltViewModel\r\nimport androidx.compose.material3.BottomSheetDefaults\r\nimport androidx.compose.material3.rememberModalBottomSheetState\r\nimport androidx.compose.runtime.LaunchedEffect\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.setValue\r\nimport com.tutorly.R\r\nimport com.tutorly.domain.model.StudentProfile\r\nimport com.tutorly.domain.model.StudentProfileLesson\r\nimport com.tutorly.models.PaymentStatus\r\nimport com.tutorly.ui.lessoncard.LessonCardSheet\r\nimport com.tutorly.ui.lessoncard.LessonCardViewModel\r\nimport com.tutorly.ui.components.PaymentBadge\r\nimport kotlinx.coroutines.launch\r\nimport java.text.NumberFormat\r\nimport java.time.ZoneId\r\nimport java.time.YearMonth\r\nimport java.time.format.DateTimeFormatter\r\nimport java.util.Currency\r\nimport java.util.Locale\r\n\r\n@OptIn(ExperimentalMaterial3Api::class)\r\n@Composable\r\nfun StudentsScreen(\r\n    onStudentEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onStudentCreatedFromLesson: (Long) -> Unit = {},\r\n    initialEditorOrigin: StudentEditorOrigin = StudentEditorOrigin.NONE,\r\n    modifier: Modifier = Modifier,\r\n    vm: StudentsViewModel = hiltViewModel(),\r\n) {\r\n    val query by vm.query.collectAsState()\r\n    val students by vm.students.collectAsState()\r\n    val formState by vm.editorFormState.collectAsState()\r\n    val profileUiState by vm.profileUiState.collectAsState()\r\n    val lessonCardViewModel: LessonCardViewModel = hiltViewModel()\r\n    val lessonCardState by lessonCardViewModel.uiState.collectAsState()\r\n    LessonCardSheet(\r\n        state = lessonCardState,\r\n        onDismissRequest = lessonCardViewModel::dismiss,\r\n        onStudentSelect = lessonCardViewModel::onStudentSelected,\r\n        onDateSelect = lessonCardViewModel::onDateSelected,\r\n        onTimeSelect = lessonCardViewModel::onTimeSelected,\r\n        onDurationSelect = lessonCardViewModel::onDurationSelected,\r\n        onPriceChange = lessonCardViewModel::onPriceChanged,\r\n        onStatusSelect = lessonCardViewModel::onPaymentStatusSelected,\r\n        onNoteChange = lessonCardViewModel::onNoteChanged,\r\n        onSnackbarConsumed = lessonCardViewModel::consumeSnackbar\r\n    )\r\n\r\n    val snackbarHostState = remember { SnackbarHostState() }\r\n    val coroutineScope = rememberCoroutineScope()\r\n    val context = LocalContext.current\r\n    val editorSheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)\r\n    val profileSheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)\r\n    var showEditor by rememberSaveable { mutableStateOf(false) }\r\n    var editorOrigin by rememberSaveable { mutableStateOf(StudentEditorOrigin.NONE) }\r\n    var pendingProfileId by remember { mutableStateOf<Long?>(null) }\r\n\r\n    val openCreationEditor: (StudentEditorOrigin) -> Unit = { origin ->\r\n        editorOrigin = origin\r\n        pendingProfileId = null\r\n        vm.startStudentCreation()\r\n        showEditor = true\r\n    }\r\n\r\n    LaunchedEffect(initialEditorOrigin) {\r\n        if (initialEditorOrigin != StudentEditorOrigin.NONE) {\r\n            editorOrigin = initialEditorOrigin\r\n            pendingProfileId = null\r\n            vm.startStudentCreation()\r\n            showEditor = true\r\n        }\r\n    }\r\n\r\n    val closeEditor = {\r\n        showEditor = false\r\n        vm.resetStudentForm()\r\n        editorOrigin = StudentEditorOrigin.NONE\r\n    }\r\n\r\n    val handleSave = {\r\n        if (!formState.isSaving) {\r\n            vm.submitStudent(\r\n                onSuccess = { id, name, isNew ->\r\n                    closeEditor()\r\n                    val message = if (isNew) {\r\n                        context.getString(R.string.student_added_message, name)\r\n                    } else {\r\n                        context.getString(R.string.student_updated_message, name)\r\n                    }\r\n                    coroutineScope.launch { snackbarHostState.showSnackbar(message) }\r\n                    if (isNew) {\r\n                        if (editorOrigin == StudentEditorOrigin.LESSON_CREATION) {\r\n                            onStudentCreatedFromLesson(id)\r\n                        }\r\n                    } else {\r\n                        pendingProfileId?.let { vm.openStudentProfile(it) }\r\n                    }\r\n                    pendingProfileId = null\r\n                },\r\n                onError = { error ->\r\n                    val message = if (error.isNotBlank()) {\r\n                        error\r\n                    } else {\r\n                        context.getString(R.string.student_editor_save_error)\r\n                    }\r\n                    coroutineScope.launch { snackbarHostState.showSnackbar(message) }\r\n                }\r\n            )\r\n        }\r\n    }\r\n\r\n    Scaffold(\r\n        modifier = modifier,\r\n        snackbarHost = { SnackbarHost(hostState = snackbarHostState) },\r\n        containerColor = MaterialTheme.colorScheme.surface,\r\n        floatingActionButton = {\r\n            FloatingActionButton(\r\n                onClick = { openCreationEditor(StudentEditorOrigin.STUDENTS) },\r\n                containerColor = MaterialTheme.colorScheme.primary,\r\n                contentColor = MaterialTheme.colorScheme.onPrimary\r\n            ) {\r\n                Icon(\r\n                    imageVector = Icons.Default.Add,\r\n                    contentDescription = stringResource(id = R.string.add_student)\r\n                )\r\n            }\r\n        }\r\n    ) { innerPadding ->\r\n        Column(\r\n            modifier\r\n                .fillMaxSize()\r\n                .padding(innerPadding)\r\n                .padding(horizontal = 16.dp, vertical = 12.dp)\r\n        ) {\r\n            OutlinedTextField(\r\n                value = query,\r\n                onValueChange = vm::onQueryChange,\r\n                modifier = Modifier.fillMaxWidth(),\r\n                singleLine = true,\r\n                leadingIcon = { Icon(Icons.Default.Search, contentDescription = null) },\r\n                placeholder = { Text(text = stringResource(id = R.string.search_students_hint)) },\r\n                shape = MaterialTheme.shapes.large\r\n            )\r\n\r\n            Spacer(Modifier.height(16.dp))\r\n\r\n            if (students.isEmpty()) {\r\n                EmptyStudentsState(Modifier.fillMaxSize())\r\n            } else {\r\n                LazyColumn(\r\n                    modifier = Modifier.fillMaxSize(),\r\n                    verticalArrangement = Arrangement.spacedBy(12.dp),\r\n                    contentPadding = PaddingValues(bottom = 16.dp)\r\n                ) {\r\n                    items(\r\n                        items = students,\r\n                        key = { it.student.id }\r\n                    ) { item ->\r\n                        StudentCard(\r\n                            item = item,\r\n                            onClick = { vm.openStudentProfile(item.student.id) }\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if (showEditor) {\r\n        ModalBottomSheet(\r\n            onDismissRequest = {\r\n                if (!formState.isSaving) {\r\n                    pendingProfileId = null\r\n                    closeEditor()\r\n                }\r\n            },\r\n            sheetState = editorSheetState,\r\n            dragHandle = { BottomSheetDefaults.DragHandle() }\r\n        ) {\r\n            StudentEditorSheet(\r\n                state = formState,\r\n                onNameChange = vm::onEditorNameChange,\r\n                onPhoneChange = vm::onEditorPhoneChange,\r\n                onMessengerChange = vm::onEditorMessengerChange,\r\n                onRateChange = vm::onEditorRateChange,\r\n                onSubjectChange = vm::onEditorSubjectChange,\r\n                onGradeChange = vm::onEditorGradeChange,\r\n                onNoteChange = vm::onEditorNoteChange,\r\n                onArchivedChange = vm::onEditorArchivedChange,\r\n                onActiveChange = vm::onEditorActiveChange,\r\n                onCancel = {\r\n                    if (!formState.isSaving) {\r\n                        pendingProfileId = null\r\n                        closeEditor()\r\n                    }\r\n                },\r\n                onSave = handleSave\r\n            )\r\n        }\r\n    }\r\n\r\n    if (profileUiState !is StudentProfileUiState.Hidden) {\r\n        ModalBottomSheet(\r\n            onDismissRequest = vm::clearSelectedStudent,\r\n            sheetState = profileSheetState,\r\n            dragHandle = { BottomSheetDefaults.DragHandle() }\r\n        ) {\r\n            StudentProfileSheet(\r\n                state = profileUiState,\r\n                onClose = vm::clearSelectedStudent,\r\n                onEdit = { studentId ->\r\n                    val profileStudent = (profileUiState as? StudentProfileUiState.Content)?.profile?.student\r\n                    if (profileStudent != null && profileStudent.id == studentId) {\r\n                        vm.clearSelectedStudent()\r\n                        editorOrigin = StudentEditorOrigin.STUDENTS\r\n                        pendingProfileId = studentId\r\n                        vm.startStudentEdit(profileStudent)\r\n                        showEditor = true\r\n                    } else {\r\n                        vm.clearSelectedStudent()\r\n                        onStudentEdit(studentId)\r\n                    }\r\n                },\r\n                onAddLesson = { studentId ->\r\n                    vm.clearSelectedStudent()\r\n                    onAddLesson(studentId)\r\n                },\r\n                onLessonClick = { lessonId ->\r\n                    vm.clearSelectedStudent()\r\n                    lessonCardViewModel.open(lessonId)\r\n                }\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentEditorSheet(\r\n    state: StudentEditorFormState,\r\n    onNameChange: (String) -> Unit,\r\n    onPhoneChange: (String) -> Unit,\r\n    onMessengerChange: (String) -> Unit,\r\n    onRateChange: (String) -> Unit,\r\n    onSubjectChange: (String) -> Unit,\r\n    onGradeChange: (String) -> Unit,\r\n    onNoteChange: (String) -> Unit,\r\n    onArchivedChange: (Boolean) -> Unit,\r\n    onActiveChange: (Boolean) -> Unit,\r\n    onCancel: () -> Unit,\r\n    onSave: () -> Unit,\r\n) {\r\n    val isEditing = state.studentId != null\r\n    Column(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .navigationBarsPadding()\r\n            .imePadding()\r\n            .padding(horizontal = 24.dp, vertical = 16.dp),\r\n        verticalArrangement = Arrangement.spacedBy(20.dp)\r\n    ) {\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.SpaceBetween,\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            Text(\r\n                text = stringResource(\r\n                    id = if (isEditing) R.string.student_editor_edit_title else R.string.add_student\r\n                ),\r\n                style = MaterialTheme.typography.titleLarge\r\n            )\r\n            IconButton(onClick = onCancel, enabled = !state.isSaving) {\r\n                Icon(\r\n                    imageVector = Icons.Default.Close,\r\n                    contentDescription = stringResource(id = R.string.student_editor_close)\r\n                )\r\n            }\r\n        }\r\n\r\n        StudentEditorForm(\r\n            state = state,\r\n            onNameChange = onNameChange,\r\n            onPhoneChange = onPhoneChange,\r\n            onMessengerChange = onMessengerChange,\r\n            onRateChange = onRateChange,\r\n            onSubjectChange = onSubjectChange,\r\n            onGradeChange = onGradeChange,\r\n            onNoteChange = onNoteChange,\r\n            onArchivedChange = onArchivedChange,\r\n            onActiveChange = onActiveChange,\r\n            modifier = Modifier\r\n                .weight(1f, fill = false)\r\n                .fillMaxWidth(),\r\n            focusOnStart = true,\r\n            enabled = !state.isSaving,\r\n            onSubmit = onSave\r\n        )\r\n\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            OutlinedButton(\r\n                onClick = onCancel,\r\n                modifier = Modifier.weight(1f),\r\n                enabled = !state.isSaving\r\n            ) {\r\n                Text(text = stringResource(id = R.string.student_editor_cancel))\r\n            }\r\n\r\n            Button(\r\n                onClick = onSave,\r\n                modifier = Modifier.weight(1f),\r\n                enabled = !state.isSaving && state.name.isNotBlank()\r\n            ) {\r\n                if (state.isSaving) {\r\n                    CircularProgressIndicator(\r\n                        modifier = Modifier.size(20.dp),\r\n                        strokeWidth = 2.dp\r\n                    )\r\n                } else {\r\n                    Text(\r\n                        text = stringResource(id = R.string.student_editor_save)\r\n                    )\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun EmptyStudentsState(modifier: Modifier = Modifier) {\r\n    Box(modifier, contentAlignment = Alignment.Center) {\r\n        Text(\r\n            text = stringResource(id = R.string.students_empty_state),\r\n            style = MaterialTheme.typography.bodyMedium\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentCard(\r\n    item: StudentsViewModel.StudentListItem,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier,\r\n) {\r\n    val currencyFormatter = remember {\r\n        NumberFormat.getCurrencyInstance(Locale(\"ru\", \"RU\")).apply {\r\n            currency = Currency.getInstance(\"RUB\")\r\n        }\r\n    }\r\n    val subject = item.profile.subject?.takeIf { it.isNotBlank() }?.trim()\r\n    val grade = item.profile.grade?.takeIf { it.isNotBlank() }?.trim()\r\n    val rate = item.profile.rate?.let { formatCurrency(it.priceCents.toLong(), currencyFormatter) }\r\n    val subtitle = listOfNotNull(subject, grade, rate)\r\n        .joinToString(separator = \" • \")\r\n        .takeIf { it.isNotBlank() }\r\n\r\n    val phone = item.student.phone?.takeIf { it.isNotBlank() }?.trim()\r\n    val email = item.student.messenger?.takeIf { it.isNotBlank() }?.trim()\r\n    val showTrailingRow = phone != null || email != null || item.hasDebt\r\n\r\n    Card(\r\n        onClick = onClick,\r\n        modifier = modifier.fillMaxWidth(),\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),\r\n        border = BorderStroke(1.dp, MaterialTheme.colorScheme.outlineVariant),\r\n        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)\r\n    ) {\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 16.dp, vertical = 12.dp),\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            StudentAvatar(name = item.student.name, size = 48.dp)\r\n            Spacer(Modifier.width(12.dp))\r\n            Column(\r\n                modifier = Modifier.weight(1f),\r\n                verticalArrangement = Arrangement.spacedBy(4.dp)\r\n            ) {\r\n                Text(\r\n                    text = item.student.name,\r\n                    style = MaterialTheme.typography.titleMedium,\r\n                    fontWeight = FontWeight.Medium,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n                subtitle?.let {\r\n                    Text(\r\n                        text = it,\r\n                        style = MaterialTheme.typography.bodySmall,\r\n                        color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                        maxLines = 1,\r\n                        overflow = TextOverflow.Ellipsis\r\n                    )\r\n                }\r\n                if (showTrailingRow) {\r\n                    Row(\r\n                        modifier = Modifier\r\n                            .fillMaxWidth()\r\n                            .padding(top = 4.dp),\r\n                        horizontalArrangement = Arrangement.End,\r\n                        verticalAlignment = Alignment.CenterVertically\r\n                    ) {\r\n                        if (phone != null) {\r\n                            Icon(\r\n                                imageVector = Icons.Outlined.Phone,\r\n                                contentDescription = phone,\r\n                                tint = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                                modifier = Modifier.size(18.dp)\r\n                            )\r\n                        }\r\n                        if (email != null) {\r\n                            if (phone != null) {\r\n                                Spacer(Modifier.width(12.dp))\r\n                            }\r\n                            Icon(\r\n                                imageVector = Icons.Outlined.Email,\r\n                                contentDescription = email,\r\n                                tint = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                                modifier = Modifier.size(18.dp)\r\n                            )\r\n                        }\r\n                        if (item.hasDebt) {\r\n                            if (phone != null || email != null) {\r\n                                Spacer(Modifier.width(12.dp))\r\n                            }\r\n                            PaymentBadge(paid = false)\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nfun StudentProfileSheet(\r\n    state: StudentProfileUiState,\r\n    onClose: () -> Unit,\r\n    onEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onLessonClick: (Long) -> Unit,\r\n    onCall: ((String) -> Unit)? = null,\r\n    onMessage: ((String) -> Unit)? = null,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    when (state) {\r\n        StudentProfileUiState.Hidden -> Unit\r\n        StudentProfileUiState.Loading -> {\r\n            Box(\r\n                modifier = modifier\r\n                    .fillMaxWidth()\r\n                    .padding(vertical = 48.dp),\r\n                contentAlignment = Alignment.Center\r\n            ) {\r\n                CircularProgressIndicator()\r\n            }\r\n        }\r\n\r\n        StudentProfileUiState.Error -> {\r\n            Column(\r\n                modifier = modifier\r\n                    .fillMaxWidth()\r\n                    .padding(horizontal = 24.dp, vertical = 32.dp),\r\n                verticalArrangement = Arrangement.spacedBy(16.dp),\r\n                horizontalAlignment = Alignment.CenterHorizontally\r\n            ) {\r\n                Text(\r\n                    text = stringResource(id = R.string.student_profile_error),\r\n                    style = MaterialTheme.typography.bodyLarge,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    textAlign = TextAlign.Center\r\n                )\r\n                Button(onClick = onClose) {\r\n                    Text(text = stringResource(id = R.string.student_editor_close))\r\n                }\r\n            }\r\n        }\r\n\r\n        is StudentProfileUiState.Content -> {\r\n            StudentProfileContent(\r\n                profile = state.profile,\r\n                onEdit = onEdit,\r\n                onAddLesson = onAddLesson,\r\n                onLessonClick = onLessonClick,\r\n                onCall = onCall,\r\n                onMessage = onMessage,\r\n                modifier = modifier\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileContent(\r\n    profile: StudentProfile,\r\n    onEdit: (Long) -> Unit,\r\n    onAddLesson: (Long) -> Unit,\r\n    onLessonClick: (Long) -> Unit,\r\n    onCall: ((String) -> Unit)?,\r\n    onMessage: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val listState = rememberLazyListState()\r\n    val locale = remember { Locale(\"ru\", \"RU\") }\r\n    val currencyFormatter = remember(locale) {\r\n        NumberFormat.getCurrencyInstance(locale).apply {\r\n            currency = Currency.getInstance(\"RUB\")\r\n        }\r\n    }\r\n    val zoneId = remember { ZoneId.systemDefault() }\r\n    val dateFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"d MMMM yyyy\", locale) }\r\n    val timeFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"HH:mm\", locale) }\r\n    val monthFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"LLLL yyyy\", locale) }\r\n\r\n    val groupedLessons = remember(profile.recentLessons, zoneId) {\r\n        val sorted = profile.recentLessons.sortedByDescending { it.startAt }\r\n        val groups = linkedMapOf<YearMonth, MutableList<StudentProfileLesson>>()\r\n        sorted.forEach { lesson ->\r\n            val key = YearMonth.from(lesson.startAt.atZone(zoneId))\r\n            groups.getOrPut(key) { mutableListOf() }.add(lesson)\r\n        }\r\n        groups.map { it.key to it.value.toList() }\r\n    }\r\n\r\n    Box(modifier = modifier.fillMaxWidth()) {\r\n        LazyColumn(\r\n            state = listState,\r\n            modifier = Modifier.fillMaxWidth(),\r\n            contentPadding = PaddingValues(start = 20.dp, end = 20.dp, top = 16.dp, bottom = 140.dp),\r\n            verticalArrangement = Arrangement.spacedBy(20.dp)\r\n        ) {\r\n            item {\r\n                StudentProfileHeader(\r\n                    profile = profile,\r\n                    onEdit = onEdit,\r\n                    currencyFormatter = currencyFormatter\r\n                )\r\n            }\r\n            item {\r\n                StudentProfileContacts(\r\n                    profile = profile,\r\n                    onCall = onCall,\r\n                    onMessage = onMessage\r\n                )\r\n            }\r\n            item {\r\n                StudentProfileMetricsSection(\r\n                    profile = profile,\r\n                    currencyFormatter = currencyFormatter\r\n                )\r\n            }\r\n            item {\r\n                Text(\r\n                    text = stringResource(id = R.string.student_details_history_title),\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n            if (profile.recentLessons.isEmpty()) {\r\n                item {\r\n                    StudentProfileEmptyHistory(\r\n                        onAddLesson = { onAddLesson(profile.student.id) }\r\n                    )\r\n                }\r\n            } else {\r\n                groupedLessons.forEach { (month, lessons) ->\r\n                    item(key = \"month-$month\") {\r\n                        val monthTitle = remember(month) {\r\n                            month.format(monthFormatter).replaceFirstChar { char ->\r\n                                if (char.isLowerCase()) char.titlecase(locale) else char.toString()\r\n                            }\r\n                        }\r\n                        Text(\r\n                            text = monthTitle,\r\n                            style = MaterialTheme.typography.titleSmall,\r\n                            color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                            modifier = Modifier.padding(top = 4.dp, bottom = 8.dp)\r\n                        )\r\n                    }\r\n                    items(lessons, key = { it.id }) { lesson ->\r\n                        StudentProfileLessonCard(\r\n                            lesson = lesson,\r\n                            fallbackSubject = profile.subject,\r\n                            currencyFormatter = currencyFormatter,\r\n                            zoneId = zoneId,\r\n                            dateFormatter = dateFormatter,\r\n                            timeFormatter = timeFormatter,\r\n                            onClick = { onLessonClick(lesson.id) }\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        ExtendedFloatingActionButton(\r\n            onClick = { onAddLesson(profile.student.id) },\r\n            icon = { Icon(imageVector = Icons.Filled.Add, contentDescription = null) },\r\n            text = { Text(text = stringResource(id = R.string.student_details_create_lesson)) },\r\n            modifier = Modifier\r\n                .align(Alignment.BottomEnd)\r\n                .padding(horizontal = 20.dp, vertical = 16.dp)\r\n                .navigationBarsPadding()\r\n        )\r\n    }\r\n}\r\n\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileHeader(\r\n    profile: StudentProfile,\r\n    onEdit: (Long) -> Unit,\r\n    currencyFormatter: NumberFormat,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Row(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalAlignment = Alignment.CenterVertically,\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        StudentAvatar(name = profile.student.name, size = 64.dp)\r\n        Column(\r\n            modifier = Modifier.weight(1f),\r\n            verticalArrangement = Arrangement.spacedBy(6.dp)\r\n        ) {\r\n            Text(\r\n                text = profile.student.name,\r\n                style = MaterialTheme.typography.headlineSmall,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            val subject = profile.subject?.takeIf { it.isNotBlank() }?.trim()\r\n            val grade = profile.grade?.takeIf { it.isNotBlank() }?.trim()\r\n            val details = listOfNotNull(subject, grade).joinToString(separator = \" \")\r\n            if (details.isNotEmpty()) {\r\n                Text(\r\n                    text = details,\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    maxLines = 2,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n            }\r\n            val rateText = profile.rate?.let { rate ->\r\n                val price = formatCurrency(rate.priceCents.toLong(), currencyFormatter)\r\n                if (rate.durationMinutes > 0) {\r\n                    \"$price • ${rate.durationMinutes} мин\"\r\n                } else {\r\n                    price\r\n                }\r\n            } ?: profile.student.rateCents?.takeIf { it > 0 }?.let { cents ->\r\n                formatCurrency(cents.toLong(), currencyFormatter)\r\n            }\r\n            if (!rateText.isNullOrBlank()) {\r\n                Text(\r\n                    text = rateText,\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            }\r\n        }\r\n        IconButton(onClick = { onEdit(profile.student.id) }) {\r\n            Icon(\r\n                imageVector = Icons.Filled.Edit,\r\n                contentDescription = stringResource(id = R.string.student_details_edit)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileContacts(\r\n    profile: StudentProfile,\r\n    onCall: ((String) -> Unit)?,\r\n    onMessage: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Column(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        Text(\r\n            text = stringResource(id = R.string.student_details_contact_title),\r\n            style = MaterialTheme.typography.titleMedium\r\n        )\r\n        ProfileContactRow(\r\n            icon = Icons.Outlined.Phone,\r\n            label = stringResource(id = R.string.student_profile_contact_call),\r\n            value = profile.student.phone,\r\n            onClick = onCall\r\n        )\r\n        ProfileContactRow(\r\n            icon = Icons.Outlined.Email,\r\n            label = stringResource(id = R.string.student_profile_contact_message),\r\n            value = profile.student.messenger,\r\n            onClick = onMessage\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun ProfileContactRow(\r\n    icon: androidx.compose.ui.graphics.vector.ImageVector,\r\n    label: String,\r\n    value: String?,\r\n    onClick: ((String) -> Unit)?,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val hasValue = !value.isNullOrBlank()\r\n    val displayValue = value?.takeIf { it.isNotBlank() }\r\n        ?: stringResource(id = R.string.student_profile_contact_placeholder)\r\n    val background = if (hasValue) {\r\n        MaterialTheme.colorScheme.surfaceVariant\r\n    } else {\r\n        MaterialTheme.colorScheme.surfaceContainerHighest\r\n    }\r\n    val contentColor = if (hasValue) {\r\n        MaterialTheme.colorScheme.onSurface\r\n    } else {\r\n        MaterialTheme.colorScheme.onSurfaceVariant\r\n    }\r\n\r\n    Row(\r\n        modifier = modifier\r\n            .fillMaxWidth()\r\n            .clip(MaterialTheme.shapes.large)\r\n            .background(background)\r\n            .clickable(enabled = hasValue && onClick != null) {\r\n                value?.let { onClick?.invoke(it) }\r\n            }\r\n            .padding(horizontal = 16.dp, vertical = 14.dp),\r\n        verticalAlignment = Alignment.CenterVertically,\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        Icon(\r\n            imageVector = icon,\r\n            contentDescription = null,\r\n            tint = if (hasValue) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n        Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {\r\n            Text(\r\n                text = label,\r\n                style = MaterialTheme.typography.bodySmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Text(\r\n                text = displayValue,\r\n                style = MaterialTheme.typography.bodyMedium,\r\n                color = contentColor,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileMetricsSection(\r\n    profile: StudentProfile,\r\n    currencyFormatter: NumberFormat,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val scrollState = rememberScrollState()\r\n    val metrics = profile.metrics\r\n    val totalLessons = metrics.totalLessons.toString()\r\n    val totalPaid = formatCurrency(metrics.totalPaidCents, currencyFormatter)\r\n    val paidLessons = metrics.paidLessons.toString()\r\n    val debtText = if (metrics.outstandingCents > 0) {\r\n        formatCurrency(metrics.outstandingCents, currencyFormatter)\r\n    } else {\r\n        stringResource(id = R.string.student_details_no_debt)\r\n    }\r\n\r\n    Column(\r\n        modifier = modifier.fillMaxWidth(),\r\n        verticalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        Text(\r\n            text = stringResource(id = R.string.student_profile_metrics_title),\r\n            style = MaterialTheme.typography.titleMedium\r\n        )\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .horizontalScroll(scrollState),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_lessons),\r\n                value = totalLessons\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_paid),\r\n                value = totalPaid\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_paid_lessons),\r\n                value = paidLessons\r\n            )\r\n            ProfileMetricCard(\r\n                label = stringResource(id = R.string.student_details_stats_debt),\r\n                value = debtText,\r\n                badge = if (profile.hasDebt) {\r\n                    {\r\n                        PaymentBadge(paid = false)\r\n                    }\r\n                } else {\r\n                    null\r\n                }\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun ProfileMetricCard(\r\n    label: String,\r\n    value: String,\r\n    modifier: Modifier = Modifier,\r\n    badge: (@Composable () -> Unit)? = null\r\n) {\r\n    Surface(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 2.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 16.dp, vertical = 12.dp),\r\n            verticalArrangement = Arrangement.spacedBy(6.dp)\r\n        ) {\r\n            Text(\r\n                text = label,\r\n                style = MaterialTheme.typography.labelMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            if (badge != null) {\r\n                Row(\r\n                    verticalAlignment = Alignment.CenterVertically,\r\n                    horizontalArrangement = Arrangement.spacedBy(8.dp)\r\n                ) {\r\n                    badge()\r\n                    Text(\r\n                        text = value,\r\n                        style = MaterialTheme.typography.bodyMedium\r\n                    )\r\n                }\r\n            } else {\r\n                Text(\r\n                    text = value,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentProfileEmptyHistory(\r\n    onAddLesson: () -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Surface(\r\n        modifier = modifier.fillMaxWidth(),\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceContainerHigh\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 20.dp, vertical = 24.dp),\r\n            horizontalAlignment = Alignment.CenterHorizontally,\r\n            verticalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(id = R.string.student_details_history_empty),\r\n                style = MaterialTheme.typography.bodyMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                textAlign = TextAlign.Center\r\n            )\r\n            Button(onClick = onAddLesson) {\r\n                Text(text = stringResource(id = R.string.student_details_create_lesson))\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\n@Composable\r\nprivate fun StudentProfileLessonCard(\r\n    lesson: StudentProfileLesson,\r\n    fallbackSubject: String?,\r\n    currencyFormatter: NumberFormat,\r\n    zoneId: ZoneId,\r\n    dateFormatter: DateTimeFormatter,\r\n    timeFormatter: DateTimeFormatter,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val start = remember(lesson.startAt, zoneId) { lesson.startAt.atZone(zoneId) }\r\n    val end = remember(lesson.endAt, zoneId) { lesson.endAt.atZone(zoneId) }\r\n    val dateText = remember(start) { dateFormatter.format(start) }\r\n    val timeText = stringResource(\r\n        id = R.string.student_details_history_time_range,\r\n        timeFormatter.format(start),\r\n        timeFormatter.format(end),\r\n        lesson.durationMinutes\r\n    )\r\n    val fallbackSubjectText = fallbackSubject?.takeIf { it.isNotBlank() }?.trim()\r\n    val title = lesson.title?.takeIf { it.isNotBlank() }?.trim()\r\n        ?: lesson.subjectName?.takeIf { it.isNotBlank() }?.trim()\r\n        ?: fallbackSubjectText\r\n        ?: stringResource(id = R.string.lesson_card_subject_placeholder)\r\n    val amount = formatCurrency(lesson.priceCents.toLong(), currencyFormatter)\r\n    val isPaid = lesson.paymentStatus == PaymentStatus.PAID\r\n\r\n    Surface(\r\n        modifier = modifier\r\n            .fillMaxWidth()\r\n            .clickable { onClick() },\r\n        shape = MaterialTheme.shapes.large,\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceContainerLow\r\n    ) {\r\n        Column(\r\n            modifier = Modifier.padding(horizontal = 20.dp, vertical = 18.dp),\r\n            verticalArrangement = Arrangement.spacedBy(8.dp)\r\n        ) {\r\n            Text(\r\n                text = dateText,\r\n                style = MaterialTheme.typography.labelSmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Text(\r\n                text = title,\r\n                style = MaterialTheme.typography.titleMedium,\r\n                maxLines = 2,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            Text(\r\n                text = timeText,\r\n                style = MaterialTheme.typography.bodySmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Row(\r\n                modifier = Modifier.fillMaxWidth(),\r\n                horizontalArrangement = Arrangement.SpaceBetween,\r\n                verticalAlignment = Alignment.CenterVertically\r\n            ) {\r\n                Text(\r\n                    text = amount,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n                PaymentBadge(paid = isPaid)\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n\r\nprivate fun formatCurrency(amountCents: Long, formatter: NumberFormat): String {\r\n    return formatter.format(amountCents / 100.0)\r\n}\r\n\r\n@Composable\r\nprivate fun StudentAvatar(\r\n    name: String,\r\n    size: Dp = 48.dp,\r\n) {\r\n    val initials = remember(name) {\r\n        name\r\n            .split(\" \")\r\n            .filter { it.isNotBlank() }\r\n            .take(2)\r\n            .joinToString(separator = \"\") { it.first().uppercaseChar().toString() }\r\n            .ifEmpty { \"?\" }\r\n    }\r\n\r\n    Box(\r\n        modifier = Modifier\r\n            .size(size)\r\n            .clip(CircleShape)\r\n            .background(MaterialTheme.colorScheme.surfaceVariant),\r\n        contentAlignment = Alignment.Center\r\n    ) {\r\n        Text(\r\n            text = initials,\r\n            style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold),\r\n            color = MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n    }\r\n}\r\n
-Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
-<+>UTF-8
-===================================================================
-diff --git a/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt b/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt
---- a/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt	(revision 5a5d2381924feba4c0c6d16382ccd2363c0a1233)
-+++ b/app/src/main/java/com/tutorly/ui/screens/StudentsScreen.kt	(date 1760178241085)
-@@ -51,6 +51,7 @@
- import androidx.compose.runtime.getValue
- import androidx.compose.runtime.mutableStateOf
- import androidx.compose.foundation.rememberScrollState
-+import androidx.compose.material.icons.filled.Close
- import androidx.compose.runtime.rememberCoroutineScope
- import androidx.compose.runtime.saveable.rememberSaveable
- import androidx.compose.ui.Alignment
-Index: app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt
-IDEA additional info:
-Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
-<+>package com.tutorly.ui.lessoncard\r\n\r\nimport android.app.DatePickerDialog\r\nimport android.app.TimePickerDialog\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.Column\r\nimport androidx.compose.foundation.layout.Row\r\nimport androidx.compose.foundation.layout.Spacer\r\nimport androidx.compose.foundation.layout.fillMaxWidth\r\nimport androidx.compose.foundation.layout.height\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.layout.size\r\nimport androidx.compose.foundation.layout.weight\r\nimport androidx.compose.foundation.lazy.LazyColumn\r\nimport androidx.compose.foundation.lazy.items\r\nimport androidx.compose.foundation.rememberScrollState\r\nimport androidx.compose.foundation.shape.CircleShape\r\nimport androidx.compose.foundation.shape.RoundedCornerShape\r\nimport androidx.compose.foundation.text.KeyboardOptions\r\nimport androidx.compose.foundation.verticalScroll\r\nimport androidx.compose.material.icons.Icons\r\nimport androidx.compose.material.icons.filled.KeyboardArrowDown\r\nimport androidx.compose.material.icons.outlined.CalendarMonth\r\nimport androidx.compose.material.icons.outlined.Schedule\r\nimport androidx.compose.material.icons.outlined.Timelapse\r\nimport androidx.compose.material3.AlertDialog\r\nimport androidx.compose.material3.CircularProgressIndicator\r\nimport androidx.compose.material3.DropdownMenu\r\nimport androidx.compose.material3.DropdownMenuItem\r\nimport androidx.compose.material3.ExperimentalMaterial3Api\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.LinearProgressIndicator\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.ModalBottomSheet\r\nimport androidx.compose.material3.OutlinedTextField\r\nimport androidx.compose.material3.SnackbarHost\r\nimport androidx.compose.material3.SnackbarHostState\r\nimport androidx.compose.material3.SuggestionChip\r\nimport androidx.compose.material3.SuggestionChipDefaults\r\nimport androidx.compose.material3.Surface\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.material3.TextButton\r\nimport androidx.compose.material3.rememberModalBottomSheetState\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.LaunchedEffect\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.rememberCoroutineScope\r\nimport androidx.compose.runtime.setValue\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.graphics.vector.ImageVector\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.input.KeyboardType\r\nimport androidx.compose.ui.text.style.TextOverflow\r\nimport androidx.compose.ui.unit.dp\r\nimport com.tutorly.R\r\nimport com.tutorly.models.PaymentStatus\r\nimport java.text.NumberFormat\r\nimport java.time.LocalDate\r\nimport java.time.LocalTime\r\nimport java.time.ZonedDateTime\r\nimport java.time.format.DateTimeFormatter\r\nimport java.util.Locale\r\nimport kotlinx.coroutines.launch\r\n\r\n@OptIn(ExperimentalMaterial3Api::class)\r\n@Composable\r\ninternal fun LessonCardSheet(\r\n    state: LessonCardUiState,\r\n    onDismissRequest: () -> Unit,\r\n    onStudentSelect: (Long) -> Unit,\r\n    onDateSelect: (LocalDate) -> Unit,\r\n    onTimeSelect: (LocalTime) -> Unit,\r\n    onDurationSelect: (Int) -> Unit,\r\n    onPriceChange: (Int) -> Unit,\r\n    onStatusSelect: (PaymentStatus) -> Unit,\r\n    onNoteChange: (String) -> Unit,\r\n    onSnackbarConsumed: () -> Unit,\r\n) {\r\n    if (!state.isVisible) return\r\n\r\n    val context = LocalContext.current\r\n    val sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)\r\n    val snackbarHostState = remember { SnackbarHostState() }\r\n    val scope = rememberCoroutineScope()\r\n\r\n    var showStudentPicker by remember { mutableStateOf(false) }\r\n    var showDurationDialog by remember { mutableStateOf(false) }\r\n    var showPriceDialog by remember { mutableStateOf(false) }\r\n    var showNoteDialog by remember { mutableStateOf(false) }\r\n    var statusMenuExpanded by remember { mutableStateOf(false) }\r\n\r\n    val locale = state.locale\r\n    val dateFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"EEEE, d MMMM\", locale) }\r\n    val timeFormatter = remember(locale) { DateTimeFormatter.ofPattern(\"HH:mm\", locale) }\r\n    val currencyFormatter = remember(locale, state.currencyCode) {\r\n        runCatching {\r\n            NumberFormat.getCurrencyInstance(locale).apply {\r\n                currency = java.util.Currency.getInstance(state.currencyCode)\r\n            }\r\n        }.getOrElse { NumberFormat.getCurrencyInstance(locale) }\r\n    }\r\n    val priceText = remember(state.priceCents, currencyFormatter) {\r\n        currencyFormatter.format(state.priceCents / 100.0)\r\n    }\r\n    val formattedDate = remember(state.date, locale) {\r\n        dateFormatter.format(state.date).replaceFirstChar { char ->\r\n            if (char.isLowerCase()) char.titlecase(locale) else char.toString()\r\n        }\r\n    }\r\n    val startDateTime = remember(state.date, state.time, state.zoneId) {\r\n        ZonedDateTime.of(state.date, state.time, state.zoneId)\r\n    }\r\n    val statusDisplay = remember(state.paymentStatus, startDateTime) {\r\n        paymentStatusDisplay(state.paymentStatus, startDateTime)\r\n    }\r\n\r\n    val snackbarText = when (val message = state.snackbarMessage) {\r\n        is LessonCardMessage.Error -> message.message ?: stringResource(R.string.lesson_card_snackbar_error)\r\n        null -> null\r\n    }\r\n\r\n    LaunchedEffect(snackbarText) {\r\n        if (snackbarText != null) {\r\n            snackbarHostState.showSnackbar(snackbarText)\r\n            onSnackbarConsumed()\r\n        }\r\n    }\r\n\r\n    val onStudentClick: () -> Unit = {\r\n        if (state.studentOptions.isNotEmpty()) {\r\n            showStudentPicker = true\r\n        }\r\n    }\r\n    val onDateClick: () -> Unit = {\r\n        DatePickerDialog(\r\n            context,\r\n            { _, year, month, day -> onDateSelect(LocalDate.of(year, month + 1, day)) },\r\n            state.date.year,\r\n            state.date.monthValue - 1,\r\n            state.date.dayOfMonth\r\n        ).show()\r\n    }\r\n    val onTimeClick: () -> Unit = {\r\n        TimePickerDialog(\r\n            context,\r\n            { _, hour, minute -> onTimeSelect(LocalTime.of(hour, minute)) },\r\n            state.time.hour,\r\n            state.time.minute,\r\n            true\r\n        ).show()\r\n    }\r\n    val onDurationClick: () -> Unit = { showDurationDialog = true }\r\n    val onPriceClick: () -> Unit = { showPriceDialog = true }\r\n    val onStatusClick: () -> Unit = {\r\n        if (!state.isPaymentActionRunning) {\r\n            statusMenuExpanded = true\r\n        }\r\n    }\r\n    val onNoteClick: () -> Unit = { showNoteDialog = true }\r\n\r\n    ModalBottomSheet(\r\n        onDismissRequest = {\r\n            scope.launch { sheetState.hide() }.invokeOnCompletion { onDismissRequest() }\r\n        },\r\n        sheetState = sheetState,\r\n        containerColor = Color.White,\r\n    ) {\r\n        Box(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp)\r\n        ) {\r\n            if (state.isLoading) {\r\n                Box(\r\n                    modifier = Modifier\r\n                        .fillMaxWidth()\r\n                        .height(200.dp),\r\n                    contentAlignment = Alignment.Center\r\n                ) {\r\n                    CircularProgressIndicator()\r\n                }\r\n            } else {\r\n                Column(\r\n                    modifier = Modifier\r\n                        .fillMaxWidth()\r\n                        .verticalScroll(rememberScrollState()),\r\n                    verticalArrangement = Arrangement.spacedBy(20.dp)\r\n                ) {\r\n                    if (state.isSaving) {\r\n                        LinearProgressIndicator(modifier = Modifier.fillMaxWidth())\r\n                    }\r\n\r\n                    LessonHeader(\r\n                        name = state.studentName,\r\n                        grade = state.studentGrade,\r\n                        subject = state.subjectName,\r\n                        onClick = onStudentClick\r\n                    )\r\n\r\n                    DateRow(\r\n                        dateText = formattedDate,\r\n                        onClick = onDateClick\r\n                    )\r\n\r\n                    TimeDurationRow(\r\n                        timeLabel = stringResource(id = R.string.lesson_details_time_label),\r\n                        timeText = state.time.format(timeFormatter),\r\n                        durationLabel = stringResource(id = R.string.lesson_details_duration_label),\r\n                        durationText = stringResource(id = R.string.lesson_card_duration_value, state.durationMinutes),\r\n                        onTimeClick = onTimeClick,\r\n                        onDurationClick = onDurationClick\r\n                    )\r\n\r\n                    PriceRow(\r\n                        price = priceText,\r\n                        statusLabel = stringResource(id = statusDisplay.labelRes),\r\n                        statusSymbol = statusDisplay.symbol,\r\n                        startDateTime = startDateTime,\r\n                        statusMenuExpanded = statusMenuExpanded,\r\n                        onPriceClick = onPriceClick,\r\n                        onStatusClick = onStatusClick,\r\n                        onStatusDismiss = { statusMenuExpanded = false },\r\n                        onStatusSelect = onStatusSelect,\r\n                        isStatusBusy = state.isPaymentActionRunning\r\n                    )\r\n\r\n                    NoteRow(\r\n                        note = state.note,\r\n                        onClick = onNoteClick\r\n                    )\r\n\r\n                    Spacer(modifier = Modifier.height(8.dp))\r\n                }\r\n            }\r\n\r\n            SnackbarHost(\r\n                hostState = snackbarHostState,\r\n                modifier = Modifier\r\n                    .align(Alignment.BottomCenter)\r\n                    .padding(bottom = 8.dp)\r\n            )\r\n        }\r\n    }\r\n\r\n    if (showStudentPicker) {\r\n        StudentPickerDialog(\r\n            options = state.studentOptions,\r\n            onSelect = {\r\n                onStudentSelect(it)\r\n                showStudentPicker = false\r\n            },\r\n            onDismiss = { showStudentPicker = false }\r\n        )\r\n    }\r\n\r\n    if (showDurationDialog) {\r\n        DurationDialog(\r\n            currentMinutes = state.durationMinutes,\r\n            onDismiss = { showDurationDialog = false },\r\n            onConfirm = {\r\n                onDurationSelect(it)\r\n                showDurationDialog = false\r\n            }\r\n        )\r\n    }\r\n\r\n    if (showPriceDialog) {\r\n        PriceDialog(\r\n            currentPriceCents = state.priceCents,\r\n            currencySymbol = state.currencySymbol,\r\n            onDismiss = { showPriceDialog = false },\r\n            onConfirm = {\r\n                onPriceChange(it)\r\n                showPriceDialog = false\r\n            }\r\n        )\r\n    }\r\n\r\n    if (showNoteDialog) {\r\n        NoteDialog(\r\n            currentNote = state.note.orEmpty(),\r\n            onDismiss = { showNoteDialog = false },\r\n            onConfirm = {\r\n                onNoteChange(it)\r\n                showNoteDialog = false\r\n            }\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun LessonHeader(\r\n    name: String,\r\n    grade: String?,\r\n    subject: String?,\r\n    onClick: () -> Unit,\r\n) {\r\n    val initials = remember(name) {\r\n        name.split(\" \").filter { it.isNotBlank() }.take(2).map { it.first().uppercase() }.joinToString(\"\")\r\n    }\r\n    Row(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .clickable { onClick() },\r\n        verticalAlignment = Alignment.CenterVertically,\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        Surface(\r\n            modifier = Modifier.size(48.dp),\r\n            shape = CircleShape,\r\n            color = MaterialTheme.colorScheme.primary.copy(alpha = 0.1f)\r\n        ) {\r\n            Box(contentAlignment = Alignment.Center) {\r\n                Text(\r\n                    text = initials.ifBlank { \"?\" },\r\n                    style = MaterialTheme.typography.titleMedium,\r\n                    fontWeight = FontWeight.SemiBold,\r\n                    color = MaterialTheme.colorScheme.primary\r\n                )\r\n            }\r\n        }\r\n        Column(modifier = Modifier.weight(1f)) {\r\n            Text(\r\n                text = name.ifBlank { stringResource(id = R.string.lesson_card_student_placeholder) },\r\n                style = MaterialTheme.typography.titleLarge,\r\n                maxLines = 1,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            val subtitle = listOfNotNull(grade, subject).filter { it.isNotBlank() }.joinToString(\" • \")\r\n            if (subtitle.isNotBlank()) {\r\n                Text(\r\n                    text = subtitle,\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n            }\r\n        }\r\n        Icon(\r\n            imageVector = Icons.Filled.KeyboardArrowDown,\r\n            contentDescription = null,\r\n            tint = MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun DateRow(\r\n    dateText: String,\r\n    onClick: () -> Unit,\r\n) {\r\n    Surface(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .clickable { onClick() },\r\n        shape = RoundedCornerShape(20.dp),\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp),\r\n            verticalAlignment = Alignment.CenterVertically,\r\n            horizontalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Icon(\r\n                imageVector = Icons.Outlined.CalendarMonth,\r\n                contentDescription = null,\r\n                tint = MaterialTheme.colorScheme.primary\r\n            )\r\n            Column {\r\n                Text(\r\n                    text = stringResource(id = R.string.lesson_card_date_label),\r\n                    style = MaterialTheme.typography.labelMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n                Text(\r\n                    text = dateText,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun TimeDurationRow(\r\n    timeLabel: String,\r\n    timeText: String,\r\n    durationLabel: String,\r\n    durationText: String,\r\n    onTimeClick: () -> Unit,\r\n    onDurationClick: () -> Unit,\r\n) {\r\n    Row(\r\n        modifier = Modifier.fillMaxWidth(),\r\n        horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        TimeCard(\r\n            label = timeLabel,\r\n            value = timeText,\r\n            icon = Icons.Outlined.Schedule,\r\n            onClick = onTimeClick,\r\n            modifier = Modifier.weight(1f)\r\n        )\r\n        TimeCard(\r\n            label = durationLabel,\r\n            value = durationText,\r\n            icon = Icons.Outlined.Timelapse,\r\n            onClick = onDurationClick,\r\n            modifier = Modifier.weight(1f)\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun TimeCard(\r\n    label: String,\r\n    value: String,\r\n    icon: ImageVector,\r\n    onClick: () -> Unit,\r\n    modifier: Modifier = Modifier,\r\n) {\r\n    Surface(\r\n        modifier = modifier.clickable { onClick() },\r\n        shape = RoundedCornerShape(20.dp),\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp),\r\n            verticalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            Icon(\r\n                imageVector = icon,\r\n                contentDescription = null,\r\n                tint = MaterialTheme.colorScheme.primary,\r\n                modifier = Modifier.size(24.dp)\r\n            )\r\n            Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {\r\n                Text(\r\n                    text = label,\r\n                    style = MaterialTheme.typography.labelMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n                Text(\r\n                    text = value,\r\n                    style = MaterialTheme.typography.titleMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun PriceRow(\r\n    price: String,\r\n    statusLabel: String,\r\n    statusSymbol: String,\r\n    startDateTime: ZonedDateTime,\r\n    statusMenuExpanded: Boolean,\r\n    onPriceClick: () -> Unit,\r\n    onStatusClick: () -> Unit,\r\n    onStatusDismiss: () -> Unit,\r\n    onStatusSelect: (PaymentStatus) -> Unit,\r\n    isStatusBusy: Boolean,\r\n) {\r\n    Row(\r\n        modifier = Modifier.fillMaxWidth(),\r\n        horizontalArrangement = Arrangement.spacedBy(16.dp),\r\n        verticalAlignment = Alignment.CenterVertically\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .weight(1f)\r\n                .clickable { onPriceClick() }\r\n        ) {\r\n            Text(\r\n                text = stringResource(id = R.string.lesson_card_price_label),\r\n                style = MaterialTheme.typography.labelMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            Text(\r\n                text = price,\r\n                style = MaterialTheme.typography.titleLarge\r\n            )\r\n        }\r\n        Box {\r\n            Surface(\r\n                shape = RoundedCornerShape(20.dp),\r\n                color = MaterialTheme.colorScheme.surfaceVariant,\r\n                modifier = Modifier\r\n                    .clickable { onStatusClick() }\r\n                    .padding(vertical = 4.dp)\r\n            ) {\r\n                Row(\r\n                    modifier = Modifier\r\n                        .padding(horizontal = 14.dp, vertical = 8.dp),\r\n                    horizontalArrangement = Arrangement.spacedBy(8.dp),\r\n                    verticalAlignment = Alignment.CenterVertically\r\n                ) {\r\n                    if (isStatusBusy) {\r\n                        CircularProgressIndicator(\r\n                            modifier = Modifier.size(16.dp),\r\n                            strokeWidth = 2.dp\r\n                        )\r\n                    } else {\r\n                        Text(text = statusSymbol, style = MaterialTheme.typography.titleMedium)\r\n                    }\r\n                    Text(\r\n                        text = statusLabel,\r\n                        style = MaterialTheme.typography.labelLarge\r\n                    )\r\n                }\r\n            }\r\n            DropdownMenu(\r\n                expanded = statusMenuExpanded,\r\n                onDismissRequest = onStatusDismiss\r\n            ) {\r\n                listOf(PaymentStatus.UNPAID, PaymentStatus.PAID, PaymentStatus.DUE).forEach { status ->\r\n                    val display = paymentStatusDisplay(status, startDateTime)\r\n                    DropdownMenuItem(\r\n                        text = { Text(\"${display.symbol} ${stringResource(id = display.labelRes)}\") },\r\n                        onClick = {\r\n                            onStatusSelect(status)\r\n                            onStatusDismiss()\r\n                        }\r\n                    )\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun NoteRow(\r\n    note: String?,\r\n    onClick: () -> Unit,\r\n) {\r\n    Surface(\r\n        modifier = Modifier\r\n            .fillMaxWidth()\r\n            .clickable { onClick() },\r\n        shape = RoundedCornerShape(20.dp),\r\n        tonalElevation = 1.dp,\r\n        color = MaterialTheme.colorScheme.surfaceVariant\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp),\r\n            verticalArrangement = Arrangement.spacedBy(8.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(id = R.string.lesson_card_note_label),\r\n                style = MaterialTheme.typography.labelMedium,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant\r\n            )\r\n            val content = note?.takeIf { it.isNotBlank() }\r\n            if (content == null) {\r\n                Text(\r\n                    text = stringResource(id = R.string.lesson_card_note_placeholder),\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            } else {\r\n                Text(\r\n                    text = content,\r\n                    style = MaterialTheme.typography.bodyMedium\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun StudentPickerDialog(\r\n    options: List<LessonStudentOption>,\r\n    onSelect: (Long) -> Unit,\r\n    onDismiss: () -> Unit,\r\n) {\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        title = { Text(text = stringResource(id = R.string.lesson_card_student_picker_title)) },\r\n        text = {\r\n            if (options.isEmpty()) {\r\n                Text(text = stringResource(id = R.string.lesson_card_student_picker_empty))\r\n            } else {\r\n                LazyColumn(verticalArrangement = Arrangement.spacedBy(12.dp)) {\r\n                    items(options, key = { it.id }) { option ->\r\n                        Column(\r\n                            modifier = Modifier\r\n                                .fillMaxWidth()\r\n                                .clickable { onSelect(option.id) }\r\n                                .padding(vertical = 4.dp)\r\n                        ) {\r\n                            Text(\r\n                                text = option.name,\r\n                                style = MaterialTheme.typography.titleMedium\r\n                            )\r\n                            val subtitle = listOfNotNull(option.grade, option.subject)\r\n                                .filter { it.isNotBlank() }\r\n                                .joinToString(\" • \")\r\n                            if (subtitle.isNotBlank()) {\r\n                                Text(\r\n                                    text = subtitle,\r\n                                    style = MaterialTheme.typography.bodySmall,\r\n                                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                                )\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        confirmButton = {},\r\n        dismissButton = {\r\n            TextButton(onClick = onDismiss) {\r\n                Text(text = stringResource(id = R.string.lesson_create_cancel))\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\n@Composable\r\nprivate fun DurationDialog(\r\n    currentMinutes: Int,\r\n    onDismiss: () -> Unit,\r\n    onConfirm: (Int) -> Unit,\r\n) {\r\n    var customInput by remember(currentMinutes) {\r\n        mutableStateOf(currentMinutes.takeIf { it > 0 }?.toString().orEmpty())\r\n    }\r\n    val presets = listOf(25, 60, 90, 120)\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        title = { Text(text = stringResource(id = R.string.lesson_card_duration_title)) },\r\n        text = {\r\n            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {\r\n                Row(\r\n                    modifier = Modifier.fillMaxWidth(),\r\n                    horizontalArrangement = Arrangement.spacedBy(8.dp)\r\n                ) {\r\n                    presets.forEach { preset ->\r\n                        SuggestionChip(\r\n                            onClick = {\r\n                                customInput = preset.toString()\r\n                            },\r\n                            label = { Text(text = preset.toString()) },\r\n                            colors = SuggestionChipDefaults.suggestionChipColors()\r\n                        )\r\n                    }\r\n                }\r\n                OutlinedTextField(\r\n                    value = customInput,\r\n                    onValueChange = { value ->\r\n                        customInput = value.filter { it.isDigit() }\r\n                    },\r\n                    label = { Text(text = stringResource(id = R.string.lesson_card_duration_hint)) },\r\n                    suffix = { Text(text = stringResource(id = R.string.lesson_create_minutes_suffix)) },\r\n                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),\r\n                    singleLine = true\r\n                )\r\n            }\r\n        },\r\n        confirmButton = {\r\n            TextButton(onClick = {\r\n                customInput.toIntOrNull()?.takeIf { it > 0 }?.let(onConfirm)\r\n            }) {\r\n                Text(text = stringResource(id = R.string.lesson_details_save))\r\n            }\r\n        },\r\n        dismissButton = {\r\n            TextButton(onClick = onDismiss) {\r\n                Text(text = stringResource(id = R.string.lesson_create_cancel))\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\n@Composable\r\nprivate fun PriceDialog(\r\n    currentPriceCents: Int,\r\n    currencySymbol: String,\r\n    onDismiss: () -> Unit,\r\n    onConfirm: (Int) -> Unit,\r\n) {\r\n    var input by remember(currentPriceCents) {\r\n        mutableStateOf(currentPriceCents.takeIf { it >= 0 }?.let { (it / 100).toString() } ?: \"\")\r\n    }\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        title = { Text(text = stringResource(id = R.string.lesson_card_price_title)) },\r\n        text = {\r\n            OutlinedTextField(\r\n                value = input,\r\n                onValueChange = { value ->\r\n                    input = value.filter { it.isDigit() }\r\n                },\r\n                label = { Text(text = stringResource(id = R.string.lesson_card_price_hint, currencySymbol)) },\r\n                keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),\r\n                singleLine = true\r\n            )\r\n        },\r\n        confirmButton = {\r\n            TextButton(onClick = {\r\n                input.toIntOrNull()?.let { onConfirm(it * 100) }\r\n            }) {\r\n                Text(text = stringResource(id = R.string.lesson_details_save))\r\n            }\r\n        },\r\n        dismissButton = {\r\n            TextButton(onClick = onDismiss) {\r\n                Text(text = stringResource(id = R.string.lesson_create_cancel))\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\n@Composable\r\nprivate fun NoteDialog(\r\n    currentNote: String,\r\n    onDismiss: () -> Unit,\r\n    onConfirm: (String) -> Unit,\r\n) {\r\n    var noteInput by remember(currentNote) { mutableStateOf(currentNote) }\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        title = { Text(text = stringResource(id = R.string.lesson_card_note_title)) },\r\n        text = {\r\n            OutlinedTextField(\r\n                value = noteInput,\r\n                onValueChange = { value ->\r\n                    noteInput = value.take(LESSON_CARD_NOTE_LIMIT)\r\n                },\r\n                label = { Text(text = stringResource(id = R.string.lesson_card_note_hint)) },\r\n                modifier = Modifier.height(120.dp)\r\n            )\r\n        },\r\n        confirmButton = {\r\n            TextButton(onClick = { onConfirm(noteInput) }) {\r\n                Text(text = stringResource(id = R.string.lesson_details_save))\r\n            }\r\n        },\r\n        dismissButton = {\r\n            TextButton(onClick = onDismiss) {\r\n                Text(text = stringResource(id = R.string.lesson_create_cancel))\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\nprivate data class PaymentStatusDisplay(val symbol: String, val labelRes: Int)\r\n\r\nprivate fun paymentStatusDisplay(status: PaymentStatus, start: ZonedDateTime): PaymentStatusDisplay {\r\n    val isFuture = start.isAfter(ZonedDateTime.now(start.zone))\r\n    val labelRes = when (status) {\r\n        PaymentStatus.UNPAID -> R.string.lesson_card_status_planned\r\n        PaymentStatus.PAID -> if (isFuture) R.string.lesson_card_status_prepaid else R.string.lesson_status_paid\r\n        PaymentStatus.DUE -> R.string.lesson_status_due\r\n        PaymentStatus.CANCELLED -> R.string.lesson_status_cancelled\r\n    }\r\n    val symbol = when (status) {\r\n        PaymentStatus.UNPAID -> \"•\"\r\n        PaymentStatus.PAID -> if (isFuture) \"◎\" else \"✓\"\r\n        PaymentStatus.DUE -> \"–\"\r\n        PaymentStatus.CANCELLED -> \"×\"\r\n    }\r\n    return PaymentStatusDisplay(symbol, labelRes)\r\n}\r\n
-Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
-<+>UTF-8
-===================================================================
-diff --git a/app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt b/app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt
---- a/app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt	(revision 5a5d2381924feba4c0c6d16382ccd2363c0a1233)
-+++ b/app/src/main/java/com/tutorly/ui/lessoncard/LessonCardSheet.kt	(date 1760178241115)
-@@ -356,7 +356,7 @@
- @Composable
- private fun DateRow(
-     dateText: String,
--    onClick: () -> Unit,
-+    onClick: @Composable () -> Unit,
- ) {
-     Surface(
-         modifier = Modifier
Index: app/src/main/java/com/tutorly/navigation/AppNav.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.tutorly.navigation\r\n\r\nimport androidx.compose.animation.ExperimentalAnimationApi\r\nimport androidx.compose.animation.ExperimentalSharedTransitionApi\r\nimport androidx.compose.animation.SharedTransitionLayout\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.RowScope\r\nimport androidx.compose.foundation.layout.WindowInsets\r\nimport androidx.compose.foundation.layout.fillMaxSize\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.layout.systemBars\r\nimport androidx.compose.material.icons.Icons\r\nimport androidx.compose.material.icons.outlined.Archive\r\nimport androidx.compose.material.icons.outlined.Unarchive\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.IconButton\r\nimport androidx.compose.material3.IconButtonDefaults\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.Scaffold\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableIntStateOf\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.saveable.rememberSaveable\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.graphics.Brush\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.window.DialogProperties\r\nimport androidx.hilt.navigation.compose.hiltViewModel\r\nimport androidx.navigation.NavHostController\r\nimport androidx.navigation.NavType\r\nimport androidx.navigation.compose.currentBackStackEntryAsState\r\nimport androidx.navigation.navArgument\r\nimport com.google.accompanist.navigation.animation.AnimatedNavHost\r\nimport com.google.accompanist.navigation.animation.composable\r\nimport androidx.navigation.compose.dialog\r\nimport com.google.accompanist.navigation.animation.rememberAnimatedNavController\r\nimport com.tutorly.ui.CalendarMode\r\nimport com.tutorly.ui.CalendarScreen\r\nimport com.tutorly.ui.CalendarViewModel\r\nimport com.tutorly.ui.lessoncreation.LessonCreationConfig\r\nimport com.tutorly.ui.lessoncreation.LessonCreationOrigin\r\nimport com.tutorly.ui.lessoncreation.LessonCreationViewModel\r\nimport com.tutorly.ui.components.AppBottomBar\r\nimport com.tutorly.ui.components.AppTopBar\r\nimport com.tutorly.ui.screens.*\r\nimport java.time.LocalDate\r\nimport java.time.ZonedDateTime\r\nimport com.tutorly.ui.theme.extendedColors\r\nimport com.tutorly.R\r\n\r\nconst val ROUTE_CALENDAR = \"calendar\"\r\nprivate const val ROUTE_CALENDAR_PATTERN = \"${ROUTE_CALENDAR}?${CalendarViewModel.ARG_ANCHOR_DATE}={${CalendarViewModel.ARG_ANCHOR_DATE}}&${CalendarViewModel.ARG_CALENDAR_MODE}={${CalendarViewModel.ARG_CALENDAR_MODE}}\"\r\nconst val ROUTE_TODAY = \"today\"\r\nconst val ROUTE_STUDENTS = \"students\"\r\nconst val ROUTE_SETTINGS = \"settings\"\r\nprivate const val ARG_STUDENT_EDITOR_ORIGIN = \"studentEditorOrigin\"\r\nprivate const val ROUTE_STUDENTS_PATTERN = \"$ROUTE_STUDENTS?$ARG_STUDENT_EDITOR_ORIGIN={$ARG_STUDENT_EDITOR_ORIGIN}\"\r\nconst val ROUTE_FINANCE = \"finance\"\r\nconst val ROUTE_STUDENT_DETAILS = \"student/{studentId}\"\r\nprivate const val ROUTE_STUDENT_EDIT_BASE = \"student/{studentId}/edit\"\r\nprivate const val ARG_STUDENT_EDIT_TARGET = \"editTarget\"\r\nconst val ROUTE_STUDENT_EDIT = \"$ROUTE_STUDENT_EDIT_BASE?$ARG_STUDENT_EDIT_TARGET={$ARG_STUDENT_EDIT_TARGET}\"\r\nprivate fun studentDetailsRoute(studentId: Long) = ROUTE_STUDENT_DETAILS.replace(\"{studentId}\", studentId.toString())\r\nprivate fun studentsRoute(origin: StudentEditorOrigin = StudentEditorOrigin.NONE) =\r\n    \"$ROUTE_STUDENTS?$ARG_STUDENT_EDITOR_ORIGIN=${origin.name}\"\r\nprivate fun studentEditRoute(studentId: Long, target: StudentEditTarget? = null): String {\r\n    val base = ROUTE_STUDENT_EDIT_BASE.replace(\"{studentId}\", studentId.toString())\r\n    return if (target != null) {\r\n        \"$base?$ARG_STUDENT_EDIT_TARGET=${target.name}\"\r\n    } else {\r\n        base\r\n    }\r\n}\r\n\r\n@OptIn(\r\n    ExperimentalSharedTransitionApi::class,\r\n    ExperimentalAnimationApi::class\r\n)\r\n@Composable\r\nfun AppNavRoot() {\r\n    val nav = rememberAnimatedNavController()\r\n    val backStack by nav.currentBackStackEntryAsState()\r\n    val destinationRoute = backStack?.destination?.route ?: ROUTE_CALENDAR\r\n    val route = destinationRoute.substringBefore(\"?\")\r\n\r\n    val extendedColors = MaterialTheme.extendedColors\r\n\r\n    var financePeriod by rememberSaveable { mutableStateOf(FinancePeriod.WEEK) }\r\n    var financePeriodOffset by rememberSaveable { mutableIntStateOf(0) }\r\n\r\n    Box(\r\n        modifier = Modifier\r\n            .fillMaxSize()\r\n            .background(\r\n                Brush.verticalGradient(\r\n                    colors = listOf(extendedColors.backgroundTop, extendedColors.backgroundBottom)\r\n                )\r\n            )\r\n    ) {\r\n        Scaffold(\r\n            topBar = {\r\n                when (route) {\r\n                    ROUTE_STUDENTS -> StudentsTopBar(nav)\r\n                    ROUTE_FINANCE -> FinanceTopBar(\r\n                        selectedPeriod = financePeriod,\r\n                        onSelectPeriod = {\r\n                            financePeriod = it\r\n                            financePeriodOffset = 0\r\n                        }\r\n                    )\r\n                }\r\n            },\r\n            bottomBar = {\r\n                AppBottomBar(\r\n                    currentRoute = route,\r\n                    onSelect = { dest ->\r\n                        if (dest == ROUTE_STUDENTS) {\r\n                            val returnedToList = nav.popBackStack(ROUTE_STUDENTS_PATTERN, inclusive = false)\r\n                            if (returnedToList) {\r\n                                return@AppBottomBar\r\n                            }\r\n                        }\r\n\r\n                        val target = when (dest) {\r\n                            ROUTE_CALENDAR -> calendarRoute(nav)\r\n                            ROUTE_STUDENTS -> studentsRoute()\r\n                            else -> dest\r\n                        }\r\n                        nav.navigate(target) {\r\n                            launchSingleTop = true\r\n                            restoreState = true\r\n                            popUpTo(nav.graph.startDestinationId) { saveState = true }\r\n                        }\r\n                    }\r\n                )\r\n            },\r\n            containerColor = Color.Transparent,\r\n            // чтобы контент корректно учитывал статус/навигационные панели\r\n            contentWindowInsets = WindowInsets.systemBars\r\n        ) { innerPadding ->\r\n            SharedTransitionLayout {\r\n                val sharedScope = this\r\n                AnimatedNavHost(\r\n                    navController = nav,\r\n                    startDestination = ROUTE_CALENDAR_PATTERN,\r\n                    modifier = Modifier.padding(innerPadding)\r\n                ) {\r\n                composable(\r\n                    route = ROUTE_CALENDAR_PATTERN,\r\n                    arguments = listOf(\r\n                        navArgument(CalendarViewModel.ARG_ANCHOR_DATE) {\r\n                            type = NavType.StringType\r\n                            defaultValue = \"\"\r\n                        },\r\n                        navArgument(CalendarViewModel.ARG_CALENDAR_MODE) {\r\n                            type = NavType.StringType\r\n                            defaultValue = CalendarMode.DAY.name\r\n                        }\r\n                    )\r\n                ) { entry ->\r\n                    val creationViewModel: LessonCreationViewModel = hiltViewModel(entry)\r\n                    CalendarScreen(\r\n                        onAddStudent = {\r\n                            nav.navigate(studentsRoute(StudentEditorOrigin.LESSON_CREATION)) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        },\r\n                        onOpenSettings = {\r\n                            nav.navigate(ROUTE_SETTINGS) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        },\r\n                        creationViewModel = creationViewModel\r\n                    )\r\n                }\r\n                composable(ROUTE_TODAY) {\r\n                    TodayScreen(\r\n                        onAddStudent = {\r\n                            nav.navigate(studentsRoute(StudentEditorOrigin.LESSON_CREATION)) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        },\r\n                        onOpenStudentProfile = { studentId ->\r\n                            nav.navigate(studentDetailsRoute(studentId)) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        },\r\n                        onOpenDebtors = {\r\n                            nav.navigate(ROUTE_FINANCE) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        }\r\n                    )\r\n                }      // сам рисует свой верх (заголовок + счетчики)\r\n                composable(\r\n                    route = ROUTE_STUDENTS_PATTERN,\r\n                    arguments = listOf(\r\n                        navArgument(ARG_STUDENT_EDITOR_ORIGIN) {\r\n                            type = NavType.StringType\r\n                            defaultValue = StudentEditorOrigin.NONE.name\r\n                        }\r\n                    )\r\n                ) { entry ->\r\n                    val calendarEntry =\r\n                        remember(nav) { nav.getBackStackEntry(ROUTE_CALENDAR_PATTERN) }\r\n                    val creationViewModel: LessonCreationViewModel = hiltViewModel(calendarEntry)\r\n                    val originName = entry.arguments?.getString(ARG_STUDENT_EDITOR_ORIGIN).orEmpty()\r\n                    val origin =\r\n                        runCatching { StudentEditorOrigin.valueOf(originName) }.getOrDefault(\r\n                            StudentEditorOrigin.NONE\r\n                        )\r\n                    StudentsScreen(\r\n                        onStudentEdit = { id ->\r\n                            nav.navigate(studentEditRoute(id)) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        },\r\n                        onAddLesson = { studentId ->\r\n                            creationViewModel.start(\r\n                                LessonCreationConfig(\r\n                                    studentId = studentId,\r\n                                    zoneId = ZonedDateTime.now().zone,\r\n                                    origin = LessonCreationOrigin.STUDENT\r\n                                )\r\n                            )\r\n                            nav.navigate(calendarRoute(nav)) {\r\n                                launchSingleTop = true\r\n                                restoreState = true\r\n                            }\r\n                        },\r\n                        onStudentOpen = { id ->\r\n                            nav.navigate(studentDetailsRoute(id)) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        },\r\n                        onStudentCreatedFromLesson = { newId ->\r\n                            val reopened = creationViewModel.onStudentCreated(newId)\r\n                            nav.popBackStack()\r\n                            nav.navigate(calendarRoute(nav)) {\r\n                                launchSingleTop = true\r\n                                restoreState = true\r\n                            }\r\n                            if (!reopened) {\r\n                                creationViewModel.dismiss()\r\n                            }\r\n                        },\r\n                        initialEditorOrigin = origin,\r\n                        sharedTransitionScope = sharedScope,\r\n                        animatedVisibilityScope = this\r\n                    )\r\n                }\r\n                composable(\r\n                    route = ROUTE_STUDENT_DETAILS,\r\n                    arguments = listOf(navArgument(\"studentId\") { type = NavType.LongType })\r\n                ) { entry ->\r\n                    val studentId = entry.arguments?.getLong(\"studentId\") ?: return@composable\r\n                    val calendarEntry =\r\n                        remember(nav) { nav.getBackStackEntry(ROUTE_CALENDAR_PATTERN) }\r\n                    val creationViewModel: LessonCreationViewModel = hiltViewModel(calendarEntry)\r\n                    StudentDetailsScreen(\r\n                        onBack = { nav.popBackStack() },\r\n                        onAddStudentFromCreation = {\r\n                            nav.navigate(studentsRoute(StudentEditorOrigin.LESSON_CREATION)) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        },\r\n                        creationViewModel = creationViewModel\r\n                    )\r\n                }\r\n                dialog(\r\n                    route = ROUTE_STUDENT_EDIT,\r\n                    arguments = listOf(\r\n                        navArgument(\"studentId\") { type = NavType.LongType },\r\n                        navArgument(ARG_STUDENT_EDIT_TARGET) {\r\n                            type = NavType.StringType\r\n                            defaultValue = StudentEditTarget.PROFILE.name\r\n                        }\r\n                    ),\r\n                    dialogProperties = DialogProperties(usePlatformDefaultWidth = false)\r\n                ) {\r\n                    StudentEditorDialog(\r\n                        onDismiss = { nav.popBackStack() },\r\n                        onSaved = {\r\n                            nav.popBackStack()\r\n                        }\r\n                    )\r\n                }\r\n                composable(ROUTE_FINANCE) {\r\n                    FinanceScreen(\r\n                        selectedPeriod = financePeriod,\r\n                        periodOffset = financePeriodOffset,\r\n                        onPeriodOffsetChange = { financePeriodOffset = it },\r\n                        onOpenStudent = { studentId ->\r\n                            nav.navigate(studentDetailsRoute(studentId)) {\r\n                                launchSingleTop = true\r\n                            }\r\n                        }\r\n                    )\r\n                }\r\n                composable(ROUTE_SETTINGS) {\r\n                    SettingsScreen(\r\n                        onBack = { nav.popBackStack() }\r\n                    )\r\n                }\r\n            }\r\n        }\r\n    }\r\n}}\r\n\r\nfun calendarRoute(nav: NavHostController): String {\r\n    val entry = runCatching { nav.getBackStackEntry(ROUTE_CALENDAR_PATTERN) }.getOrNull()\r\n    val savedDate = entry?.savedStateHandle?.get<String>(CalendarViewModel.ARG_ANCHOR_DATE)\r\n    val savedMode = entry?.savedStateHandle?.get<String>(CalendarViewModel.ARG_CALENDAR_MODE)\r\n    return buildCalendarRoute(savedDate, savedMode)\r\n}\r\n\r\n@Composable\r\nprivate fun StudentsTopBar(navController: NavHostController) {\r\n    val backStackEntry = remember(navController) { navController.getBackStackEntry(ROUTE_STUDENTS_PATTERN) }\r\n    val viewModel: StudentsViewModel = hiltViewModel(backStackEntry)\r\n    val isArchiveMode by viewModel.isArchiveMode.collectAsState()\r\n\r\n    val titleRes = if (isArchiveMode) {\r\n        R.string.students_archive_title\r\n    } else {\r\n        R.string.students_title\r\n    }\r\n\r\n    AppTopBar(\r\n        title = stringResource(id = titleRes),\r\n        actions = {\r\n            StudentsArchiveAction(\r\n                isArchiveMode = isArchiveMode,\r\n                onToggle = viewModel::toggleArchiveMode\r\n            )\r\n        }\r\n    )\r\n}\r\n\r\n@Composable\r\nprivate fun RowScope.StudentsArchiveAction(\r\n    isArchiveMode: Boolean,\r\n    onToggle: () -> Unit\r\n) {\r\n    val icon = if (isArchiveMode) {\r\n        Icons.Outlined.Unarchive\r\n    } else {\r\n        Icons.Outlined.Archive\r\n    }\r\n    val contentDescription = stringResource(\r\n        id = if (isArchiveMode) {\r\n            R.string.students_archive_show_active\r\n        } else {\r\n            R.string.students_archive_show\r\n        }\r\n    )\r\n    val buttonColors = IconButtonDefaults.iconButtonColors(\r\n        contentColor = Color.White,\r\n        disabledContentColor = Color.White.copy(alpha = 0.4f)\r\n    )\r\n\r\n    IconButton(\r\n        onClick = onToggle,\r\n        colors = buttonColors\r\n    ) {\r\n        Icon(imageVector = icon, contentDescription = contentDescription)\r\n    }\r\n}\r\n\r\nfun buildCalendarRoute(date: String?, mode: String?): String {\r\n    val anchor = date?.takeIf { it.isNotBlank() } ?: LocalDate.now().toString()\r\n    val tab = mode?.takeIf { it.isNotBlank() } ?: CalendarMode.DAY.name\r\n    return \"${ROUTE_CALENDAR}?${CalendarViewModel.ARG_ANCHOR_DATE}=$anchor&${CalendarViewModel.ARG_CALENDAR_MODE}=$tab\"\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/tutorly/navigation/AppNav.kt b/app/src/main/java/com/tutorly/navigation/AppNav.kt
--- a/app/src/main/java/com/tutorly/navigation/AppNav.kt	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ b/app/src/main/java/com/tutorly/navigation/AppNav.kt	(date 1760877318414)
@@ -25,6 +25,7 @@
 import androidx.compose.runtime.mutableStateOf
 import androidx.compose.runtime.remember
 import androidx.compose.runtime.saveable.rememberSaveable
+import androidx.compose.runtime.setValue
 import androidx.compose.ui.Modifier
 import androidx.compose.ui.graphics.Brush
 import androidx.compose.ui.graphics.Color
Index: app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.tutorly.ui.screens\r\n\r\nimport androidx.compose.foundation.Canvas\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.gestures.detectHorizontalDragGestures\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.Column\r\nimport androidx.compose.foundation.layout.Row\r\nimport androidx.compose.foundation.layout.Spacer\r\nimport androidx.compose.foundation.layout.fillMaxSize\r\nimport androidx.compose.foundation.layout.fillMaxWidth\r\nimport androidx.compose.foundation.layout.height\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.rememberScrollState\r\nimport androidx.compose.foundation.shape.RoundedCornerShape\r\nimport androidx.compose.foundation.verticalScroll\r\nimport androidx.compose.foundation.selection.selectableGroup\r\nimport androidx.compose.material3.Card\r\nimport androidx.compose.material3.CircularProgressIndicator\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.Surface\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.ui.input.pointer.pointerInput\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.geometry.CornerRadius\r\nimport androidx.compose.ui.geometry.Offset\r\nimport androidx.compose.ui.geometry.Size\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.graphics.toArgb\r\nimport androidx.compose.ui.platform.LocalDensity\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.style.TextAlign\r\nimport androidx.compose.ui.text.style.TextOverflow\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.compose.ui.unit.sp\r\nimport androidx.hilt.navigation.compose.hiltViewModel\r\nimport com.tutorly.R\r\nimport com.tutorly.ui.components.GradientTopBarContainer\r\nimport com.tutorly.ui.theme.TutorlyCardDefaults\r\nimport java.text.NumberFormat\r\nimport java.time.format.DateTimeFormatter\r\nimport java.time.format.TextStyle\r\nimport java.util.Currency\r\nimport java.util.Locale\r\nimport kotlin.math.abs\r\n\r\n@Composable\r\nfun FinanceTopBar(\r\n    selectedPeriod: FinancePeriod,\r\n    onSelectPeriod: (FinancePeriod) -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    GradientTopBarContainer {\r\n        Row(\r\n            modifier = modifier\r\n                .fillMaxWidth()\r\n                .height(80.dp)\r\n                .padding(horizontal = 16.dp),\r\n            horizontalArrangement = Arrangement.SpaceBetween,\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            Text(\r\n                text = stringResource(id = R.string.finance_title),\r\n                style = MaterialTheme.typography.titleLarge,\r\n                color = MaterialTheme.colorScheme.onPrimary,\r\n                maxLines = 1,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n\r\n            FinancePeriodToggle(\r\n                selected = selectedPeriod,\r\n                onSelect = onSelectPeriod\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinancePeriodToggle(\r\n    selected: FinancePeriod,\r\n    onSelect: (FinancePeriod) -> Unit,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Row(\r\n        modifier = modifier\r\n            .selectableGroup()\r\n            .padding(4.dp),\r\n        horizontalArrangement = Arrangement.spacedBy(4.dp)\r\n    ) {\r\n        FinancePeriod.entries.forEach { period ->\r\n            val isSelected = period == selected\r\n            val segmentShape = RoundedCornerShape(20.dp)\r\n            val background = if (isSelected) Color.White else Color.White.copy(alpha = 0.12f)\r\n            val contentColor = if (isSelected) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onPrimary\r\n\r\n            Surface(\r\n                onClick = { onSelect(period) },\r\n                shape = segmentShape,\r\n                color = background,\r\n                contentColor = contentColor,\r\n                tonalElevation = 0.dp,\r\n                shadowElevation = if (isSelected) 2.dp else 0.dp\r\n            ) {\r\n                Text(\r\n                    modifier = Modifier.padding(horizontal = 18.dp, vertical = 8.dp),\r\n                    text = stringResource(period.tabLabelRes),\r\n                    style = MaterialTheme.typography.labelLarge,\r\n                    color = contentColor\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nfun FinanceScreen(\r\n    selectedPeriod: FinancePeriod,\r\n    periodOffset: Int,\r\n    onPeriodOffsetChange: (Int) -> Unit,\r\n    modifier: Modifier = Modifier,\r\n    viewModel: FinanceViewModel = hiltViewModel(),\r\n    onOpenStudent: (Long) -> Unit = {}\r\n) {\r\n    val state by viewModel.uiState.collectAsState()\r\n\r\n    when (val uiState = state) {\r\n        FinanceUiState.Loading -> FinanceLoading(modifier)\r\n        is FinanceUiState.Content -> FinanceContent(\r\n            modifier = modifier,\r\n            selectedPeriod = selectedPeriod,\r\n            periodOffset = periodOffset,\r\n            state = uiState,\r\n            onPeriodOffsetChange = onPeriodOffsetChange,\r\n            onOpenStudent = onOpenStudent\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceLoading(modifier: Modifier) {\r\n    Box(\r\n        modifier = modifier\r\n            .fillMaxSize()\r\n            .background(MaterialTheme.colorScheme.background),\r\n        contentAlignment = Alignment.Center\r\n    ) {\r\n        CircularProgressIndicator()\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceContent(\r\n    modifier: Modifier,\r\n    selectedPeriod: FinancePeriod,\r\n    periodOffset: Int,\r\n    state: FinanceUiState.Content,\r\n    onPeriodOffsetChange: (Int) -> Unit,\r\n    onOpenStudent: (Long) -> Unit\r\n) {\r\n    val currencyFormatter = rememberCurrencyFormatter()\r\n    val dateFormatter = rememberDateFormatter()\r\n    val scrollState = rememberScrollState()\r\n\r\n    val temporalContext = state.temporalContext\r\n    val bounds = remember(temporalContext, selectedPeriod, periodOffset) {\r\n        selectedPeriod.bounds(temporalContext, periodOffset)\r\n    }\r\n    val summary = remember(state, bounds) {\r\n        calculateFinanceSummary(\r\n            lessons = state.lessons,\r\n            payments = state.payments,\r\n            bounds = bounds,\r\n            accountsReceivableRubles = state.accountsReceivable,\r\n            prepaymentsRubles = state.prepayments\r\n        )\r\n    }\r\n    val chartPoints = remember(state, bounds) {\r\n        calculateFinanceChart(\r\n            lessons = state.lessons,\r\n            bounds = bounds,\r\n            now = temporalContext.now.toInstant(),\r\n            zoneId = temporalContext.zoneId\r\n        )\r\n    }\r\n    val debtors = state.debtors\r\n\r\n    val periodLabel = stringResource(selectedPeriod.periodLabelRes)\r\n    val periodText = stringResource(R.string.finance_metric_period, periodLabel)\r\n    val cashInValue = currencyFormatter.format(summary.cashIn)\r\n    val accruedValue = currencyFormatter.format(summary.accrued)\r\n    val debtValue = currencyFormatter.format(summary.accountsReceivable)\r\n    val prepaymentValue = currencyFormatter.format(summary.prepayments)\r\n    val lessonsValue = summary.lessons.total.toString()\r\n\r\n    val swipeModifier = Modifier.pointerInput(selectedPeriod, periodOffset) {\r\n        val threshold = 48.dp.toPx()\r\n        var totalDrag = 0f\r\n        var handled = false\r\n        detectHorizontalDragGestures(\r\n            onDragStart = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onDragEnd = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onDragCancel = {\r\n                totalDrag = 0f\r\n                handled = false\r\n            },\r\n            onHorizontalDrag = { change, dragAmount ->\r\n                if (handled) return@detectHorizontalDragGestures\r\n\r\n                totalDrag += dragAmount\r\n                if (abs(totalDrag) > threshold) {\r\n                    val newOffset = if (totalDrag < 0) periodOffset + 1 else periodOffset - 1\r\n                    onPeriodOffsetChange(newOffset)\r\n                    handled = true\r\n                    change.consume()\r\n                }\r\n            }\r\n        )\r\n    }\r\n\r\n    val zoneId = temporalContext.zoneId\r\n    val periodStartDate = remember(bounds, zoneId) {\r\n        bounds.start.atZone(zoneId).toLocalDate()\r\n    }\r\n    val periodEndDate = remember(bounds, zoneId, periodStartDate) {\r\n        val exclusive = bounds.end.atZone(zoneId).toLocalDate()\r\n        if (exclusive.isAfter(periodStartDate)) exclusive.minusDays(1) else periodStartDate\r\n    }\r\n    val periodRange = stringResource(\r\n        R.string.finance_period_range,\r\n        dateFormatter.format(periodStartDate),\r\n        dateFormatter.format(periodEndDate)\r\n    )\r\n\r\n    Column(\r\n        modifier = modifier\r\n            .fillMaxSize()\r\n            .background(MaterialTheme.colorScheme.background)\r\n            .then(swipeModifier)\r\n            .verticalScroll(scrollState)\r\n            .padding(horizontal = 16.dp, vertical = 24.dp),\r\n        verticalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        Text(\r\n            text = periodRange,\r\n            style = MaterialTheme.typography.bodySmall,\r\n            color = MaterialTheme.colorScheme.onSurfaceVariant\r\n        )\r\n\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            FinanceMetricCard(\r\n                modifier = Modifier.weight(1f),\r\n                title = stringResource(R.string.finance_cash_in_label),\r\n                value = cashInValue,\r\n                subtitle = periodText\r\n            )\r\n            FinanceMetricCard(\r\n                modifier = Modifier.weight(1f),\r\n                title = stringResource(R.string.finance_accrued_label),\r\n                value = accruedValue,\r\n                subtitle = periodText\r\n            )\r\n        }\r\n\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            FinanceMetricCard(\r\n                modifier = Modifier.weight(1f),\r\n                title = stringResource(R.string.finance_ar_label),\r\n                value = debtValue\r\n            )\r\n            FinanceMetricCard(\r\n                modifier = Modifier.weight(1f),\r\n                title = stringResource(R.string.finance_prepayments_label),\r\n                value = prepaymentValue\r\n            )\r\n        }\r\n\r\n        FinanceMetricCard(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            title = stringResource(R.string.finance_lessons_label),\r\n            value = lessonsValue,\r\n            subtitle = periodText\r\n        )\r\n\r\n        FinanceChartCard(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            points = chartPoints,\r\n            period = selectedPeriod,\r\n            currencyFormatter = currencyFormatter,\r\n            dateFormatter = dateFormatter\r\n        )\r\n\r\n        FinanceDebtorsSection(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            debtors = debtors,\r\n            currencyFormatter = currencyFormatter,\r\n            dateFormatter = dateFormatter,\r\n            onOpenStudent = onOpenStudent\r\n        )\r\n\r\n        Spacer(modifier = Modifier.height(8.dp))\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceMetricCard(\r\n    title: String,\r\n    value: String,\r\n    modifier: Modifier = Modifier,\r\n    subtitle: String? = null,\r\n    footer: (@Composable () -> Unit)? = null\r\n) {\r\n    Card(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = TutorlyCardDefaults.colors(containerColor = Color.White),\r\n        elevation = TutorlyCardDefaults.elevation()\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp),\r\n            verticalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            Text(\r\n                text = title,\r\n                style = MaterialTheme.typography.bodySmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                maxLines = 1,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            Text(\r\n                text = value,\r\n                style = MaterialTheme.typography.headlineMedium,\r\n                maxLines = 1,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            subtitle?.let {\r\n                Text(\r\n                    text = it,\r\n                    style = MaterialTheme.typography.bodySmall,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            }\r\n            footer?.let {\r\n                it()\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceChartCard(\r\n    modifier: Modifier,\r\n    points: List<FinanceChartPoint>,\r\n    period: FinancePeriod,\r\n    currencyFormatter: NumberFormat,\r\n    dateFormatter: DateTimeFormatter\r\n) {\r\n    Card(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = TutorlyCardDefaults.colors(containerColor = Color.White),\r\n        elevation = TutorlyCardDefaults.elevation()\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 20.dp),\r\n            verticalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(R.string.finance_chart_title),\r\n                style = MaterialTheme.typography.titleMedium,\r\n                maxLines = 1\r\n            )\r\n            if (points.isEmpty()) {\r\n                Text(\r\n                    text = stringResource(R.string.finance_chart_empty),\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            } else {\r\n                FinanceBarChart(\r\n                    points = points,\r\n                    period = period,\r\n                    dateFormatter = dateFormatter,\r\n                    modifier = Modifier\r\n                        .fillMaxWidth()\r\n                        .height(160.dp)\r\n                )\r\n                val total = points.sumOf { it.amount }\r\n                Text(\r\n                    modifier = Modifier.fillMaxWidth(),\r\n                    text = stringResource(\r\n                        R.string.finance_chart_total,\r\n                        currencyFormatter.format(total)\r\n                    ),\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    fontWeight = FontWeight.SemiBold,\r\n                    textAlign = TextAlign.Center\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceBarChart(\r\n    points: List<FinanceChartPoint>,\r\n    period: FinancePeriod,\r\n    dateFormatter: DateTimeFormatter,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val maxValue = remember(points) { points.maxOfOrNull { it.amount } ?: 0L }\r\n    val barColor = MaterialTheme.colorScheme.primary\r\n    val labels = remember(points, period, dateFormatter) {\r\n        buildChartLabels(points, period, dateFormatter)\r\n    }\r\n    Column(\r\n        modifier = modifier,\r\n        verticalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        val density = LocalDensity.current\r\n        val labelColor = MaterialTheme.colorScheme.onSurfaceVariant\r\n        val textSizePx = with(density) { 12.sp.toPx() }\r\n        val labelPaint = remember(labelColor, textSizePx) {\r\n            android.graphics.Paint().apply {\r\n                isAntiAlias = true\r\n                color = labelColor.toArgb()\r\n                textAlign = android.graphics.Paint.Align.CENTER\r\n                textSize = textSizePx\r\n            }\r\n        }\r\n        Canvas(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .height(120.dp)\r\n        ) {\r\n            if (points.isEmpty()) return@Canvas\r\n            val max = maxValue.toFloat().coerceAtLeast(1f)\r\n            val height = size.height\r\n            val width = size.width\r\n            val bars = points.size\r\n            val barWidth = width / (bars * 1.6f)\r\n            val stepX = width / bars\r\n\r\n            points.forEachIndexed { index, point ->\r\n                val ratio = point.amount.toFloat() / max\r\n                val barHeight = ratio * height\r\n                val left = stepX * index + (stepX - barWidth) / 2f\r\n                drawRoundRect(\r\n                    color = barColor,\r\n                    topLeft = Offset(x = left, y = height - barHeight),\r\n                    size = Size(width = barWidth, height = barHeight),\r\n                    cornerRadius = CornerRadius(x = 12.dp.toPx(), y = 12.dp.toPx())\r\n                )\r\n            }\r\n        }\r\n        Canvas(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .height(24.dp)\r\n        ) {\r\n            if (points.isEmpty()) return@Canvas\r\n            val bars = points.size\r\n            val width = size.width\r\n            val stepX = width / bars\r\n            val baseline = size.height - labelPaint.fontMetrics.descent\r\n\r\n            labels.forEachIndexed { index, label ->\r\n                if (label.isNotBlank()) {\r\n                    val x = stepX * index + stepX / 2f\r\n                    drawContext.canvas.nativeCanvas.drawText(label, x, baseline, labelPaint)\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceDebtorsSection(\r\n    modifier: Modifier,\r\n    debtors: List<FinanceDebtor>,\r\n    currencyFormatter: NumberFormat,\r\n    dateFormatter: DateTimeFormatter,\r\n    onOpenStudent: (Long) -> Unit\r\n) {\r\n    Card(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = TutorlyCardDefaults.colors(containerColor = Color.White),\r\n        elevation = TutorlyCardDefaults.elevation()\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 20.dp),\r\n            verticalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(R.string.finance_debtors_title),\r\n                style = MaterialTheme.typography.titleMedium\r\n            )\r\n\r\n            if (debtors.isEmpty()) {\r\n                Text(\r\n                    text = stringResource(R.string.finance_debtors_empty),\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            } else {\r\n                Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {\r\n                    debtors.forEach { debtor ->\r\n                        FinanceDebtorRow(\r\n                            debtor = debtor,\r\n                            currencyFormatter = currencyFormatter,\r\n                            dateFormatter = dateFormatter,\r\n                            onOpenStudent = onOpenStudent\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceDebtorRow(\r\n    debtor: FinanceDebtor,\r\n    currencyFormatter: NumberFormat,\r\n    dateFormatter: DateTimeFormatter,\r\n    onOpenStudent: (Long) -> Unit\r\n) {\r\n    Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.SpaceBetween,\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            Column(modifier = Modifier.weight(1f), verticalArrangement = Arrangement.spacedBy(4.dp)) {\r\n                Text(\r\n                    modifier = Modifier.clickable { onOpenStudent(debtor.studentId) },\r\n                    text = debtor.name,\r\n                    style = MaterialTheme.typography.titleSmall,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n                Text(\r\n                    text = stringResource(R.string.finance_debtors_last_debt, dateFormatter.format(debtor.lastDueDate)),\r\n                    style = MaterialTheme.typography.bodySmall,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n            }\r\n            Text(\r\n                text = currencyFormatter.format(debtor.amount),\r\n                style = MaterialTheme.typography.titleSmall,\r\n                fontWeight = FontWeight.SemiBold\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\nprivate fun buildChartLabels(\r\n    points: List<FinanceChartPoint>,\r\n    period: FinancePeriod,\r\n    dateFormatter: DateTimeFormatter\r\n): List<String> {\r\n    if (points.isEmpty()) return emptyList()\r\n    val locale = Locale.getDefault()\r\n    return when (period) {\r\n        FinancePeriod.WEEK -> points.map { point ->\r\n            point.date.dayOfWeek.getDisplayName(TextStyle.SHORT, locale)\r\n        }\r\n\r\n        FinancePeriod.MONTH -> {\r\n            val lastDay = points.maxOfOrNull { it.date.dayOfMonth } ?: 1\r\n            val labeledDays = setOf(1, 7, 14, 21, lastDay)\r\n            points.map { point ->\r\n                val day = point.date.dayOfMonth\r\n                if (day in labeledDays) day.toString() else \"\"\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun rememberCurrencyFormatter(): NumberFormat {\r\n    return remember {\r\n        NumberFormat.getCurrencyInstance(Locale.getDefault()).apply {\r\n            currency = Currency.getInstance(\"RUB\")\r\n            maximumFractionDigits = 0\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun rememberDateFormatter(): DateTimeFormatter {\r\n    return remember {\r\n        DateTimeFormatter.ofPattern(\"d MMM\", Locale.getDefault())\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt b/app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt
--- a/app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ b/app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt	(date 1760877318435)
@@ -33,6 +33,7 @@
 import androidx.compose.ui.geometry.Offset
 import androidx.compose.ui.geometry.Size
 import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.graphics.nativeCanvas
 import androidx.compose.ui.graphics.toArgb
 import androidx.compose.ui.platform.LocalDensity
 import androidx.compose.ui.res.stringResource
@@ -496,7 +497,6 @@
         }
     }
 }
-}
 
 @Composable
 private fun FinanceDebtorsSection(
Index: app/src/main/java/com/tutorly/ui/screens/FinanceCalculations.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.tutorly.ui.screens\r\n\r\nimport com.tutorly.domain.model.LessonDetails\r\nimport com.tutorly.models.LessonStatus\r\nimport com.tutorly.models.Payment\r\nimport com.tutorly.models.PaymentStatus\r\nimport java.time.Instant\r\nimport java.time.LocalDate\r\nimport java.time.ZoneId\r\nimport java.time.ZonedDateTime\r\nimport java.time.temporal.WeekFields\r\nimport kotlin.math.roundToLong\r\n\r\ninternal data class FinanceTemporalContext(\r\n    val now: ZonedDateTime,\r\n    val zoneId: ZoneId,\r\n    val weekFields: WeekFields\r\n)\r\n\r\ninternal data class FinancePeriodBounds(\r\n    val start: Instant,\r\n    val end: Instant\r\n)\r\n\r\ninternal fun FinancePeriod.bounds(\r\n    context: FinanceTemporalContext,\r\n    offset: Int = 0\r\n): FinancePeriodBounds {\r\n    val zone = context.zoneId\r\n    return when (this) {\r\n        FinancePeriod.WEEK -> {\r\n            val baseDate = context.now.toLocalDate().with(context.weekFields.dayOfWeek(), 1)\r\n            val startDate = baseDate.plusWeeks(offset.toLong())\r\n            val start = startDate.atStartOfDay(zone)\r\n            FinancePeriodBounds(start = start.toInstant(), end = start.plusWeeks(1).toInstant())\r\n        }\r\n\r\n        FinancePeriod.MONTH -> {\r\n            val baseDate = context.now.toLocalDate().withDayOfMonth(1)\r\n            val startDate = baseDate.plusMonths(offset.toLong())\r\n            val start = startDate.atStartOfDay(zone)\r\n            FinancePeriodBounds(start = start.toInstant(), end = start.plusMonths(1).toInstant())\r\n        }\r\n    }\r\n}\r\n\r\ninternal fun calculateFinanceSummary(\r\n    lessons: List<LessonDetails>,\r\n    payments: List<Payment>,\r\n    bounds: FinancePeriodBounds,\r\n    accountsReceivableRubles: Long,\r\n    prepaymentsRubles: Long\r\n): FinanceSummary {\r\n    val periodLessons = lessons.filter { lesson ->\r\n        !lesson.startAt.isBefore(bounds.start) && lesson.startAt.isBefore(bounds.end)\r\n    }\r\n\r\n    val accruedCents = periodLessons\r\n        .filter { it.paymentStatus != PaymentStatus.CANCELLED }\r\n        .sumOf { it.priceCents.toLong() }\r\n\r\n    val cashInCents = payments\r\n        .filter { payment ->\r\n            !payment.at.isBefore(bounds.start) && payment.at.isBefore(bounds.end) &&\r\n                payment.status == PaymentStatus.PAID\r\n        }\r\n        .sumOf { it.amountCents.toLong() }\r\n\r\n    val totalLessons = periodLessons.size\r\n    val conducted = periodLessons.count { it.lessonStatus == LessonStatus.DONE }\r\n    val cancelled = periodLessons.count { it.lessonStatus == LessonStatus.CANCELED }\r\n\r\n    return FinanceSummary(\r\n        cashIn = centsToRubles(cashInCents),\r\n        accrued = centsToRubles(accruedCents),\r\n        accountsReceivable = accountsReceivableRubles,\r\n        prepayments = prepaymentsRubles,\r\n        lessons = FinanceLessonsSummary(\r\n            total = totalLessons,\r\n            conducted = conducted,\r\n            cancelled = cancelled\r\n        )\r\n    )\r\n}\r\n\r\ninternal fun calculateFinanceChart(\r\n    lessons: List<LessonDetails>,\r\n    bounds: FinancePeriodBounds,\r\n    now: Instant,\r\n    zoneId: ZoneId\r\n): List<FinanceChartPoint> {\r\n    val accruedByDate = lessons\r\n        .asSequence()\r\n        .filter { lesson ->\r\n            !lesson.startAt.isBefore(bounds.start) &&\r\n                lesson.startAt.isBefore(bounds.end) &&\r\n                !lesson.startAt.isAfter(now) &&\r\n                lesson.paymentStatus != PaymentStatus.CANCELLED &&\r\n                lesson.lessonStatus != LessonStatus.CANCELED\r\n        }\r\n        .groupBy { lesson -> lesson.startAt.atZone(zoneId).toLocalDate() }\r\n        .mapValues { (_, items) -> centsToRubles(items.sumOf { it.priceCents.toLong() }) }\r\n\r\n    val startDate = bounds.start.atZone(zoneId).toLocalDate()\r\n    val endExclusive = bounds.end.atZone(zoneId).toLocalDate()\r\n\r\n    val dates = mutableListOf<LocalDate>()\r\n    var cursor = startDate\r\n    while (cursor.isBefore(endExclusive)) {\r\n        dates.add(cursor)\r\n        cursor = cursor.plusDays(1)\r\n    }\r\n\r\n    if (dates.isEmpty()) {\r\n        dates.add(startDate)\r\n    }\r\n\r\n    return dates.map { date ->\r\n        FinanceChartPoint(\r\n            date = date,\r\n            amount = accruedByDate[date] ?: 0\r\n        )\r\n    }\r\n}\r\n\r\ninternal fun centsToRubles(value: Long): Long = (value / 100.0).roundToLong()\r\n\r\ninternal fun LessonDetails.outstandingAmountCents(): Long {\r\n    if (paymentStatus !in PaymentStatus.outstandingStatuses) return 0\r\n    return (priceCents - paidCents).coerceAtLeast(0).toLong()\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/tutorly/ui/screens/FinanceCalculations.kt b/app/src/main/java/com/tutorly/ui/screens/FinanceCalculations.kt
--- a/app/src/main/java/com/tutorly/ui/screens/FinanceCalculations.kt	(revision 3db436a205ddfa6fc849fa0673ea4992c4e02da7)
+++ b/app/src/main/java/com/tutorly/ui/screens/FinanceCalculations.kt	(date 1760877318447)
@@ -11,7 +11,7 @@
 import java.time.temporal.WeekFields
 import kotlin.math.roundToLong
 
-internal data class FinanceTemporalContext(
+data class FinanceTemporalContext(
     val now: ZonedDateTime,
     val zoneId: ZoneId,
     val weekFields: WeekFields
