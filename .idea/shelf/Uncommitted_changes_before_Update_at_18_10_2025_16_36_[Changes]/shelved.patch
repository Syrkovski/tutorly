Index: app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.tutorly.ui.screens\r\n\r\nimport androidx.compose.foundation.Canvas\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.Column\r\nimport androidx.compose.foundation.layout.Row\r\nimport androidx.compose.foundation.layout.Spacer\r\nimport androidx.compose.foundation.layout.fillMaxSize\r\nimport androidx.compose.foundation.layout.fillMaxWidth\r\nimport androidx.compose.foundation.layout.height\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.rememberScrollState\r\nimport androidx.compose.foundation.shape.RoundedCornerShape\r\nimport androidx.compose.foundation.verticalScroll\r\nimport androidx.compose.material.icons.Icons\r\nimport androidx.compose.material.icons.outlined.Check\r\nimport androidx.compose.material3.Card\r\nimport androidx.compose.material3.CircularProgressIndicator\r\nimport androidx.compose.material3.FilterChip\r\nimport androidx.compose.material3.FilterChipDefaults\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.Surface\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.saveable.rememberSaveable\r\nimport androidx.compose.runtime.setValue\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.geometry.CornerRadius\r\nimport androidx.compose.ui.geometry.Offset\r\nimport androidx.compose.ui.geometry.Size\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.graphics.toArgb\r\nimport androidx.compose.ui.platform.LocalDensity\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.style.TextAlign\r\nimport androidx.compose.ui.text.style.TextOverflow\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.compose.ui.unit.sp\r\nimport androidx.hilt.navigation.compose.hiltViewModel\r\nimport com.tutorly.R\r\nimport com.tutorly.ui.theme.TutorlyCardDefaults\r\nimport com.tutorly.ui.theme.extendedColors\r\nimport java.text.NumberFormat\r\nimport java.time.format.DateTimeFormatter\r\nimport java.time.format.TextStyle\r\nimport java.util.Currency\r\nimport java.util.Locale\r\n\r\n@Composable\r\nfun FinanceScreen(\r\n    modifier: Modifier = Modifier,\r\n    viewModel: FinanceViewModel = hiltViewModel(),\r\n    onOpenStudent: (Long) -> Unit = {}\r\n) {\r\n    var selectedPeriod by rememberSaveable { mutableStateOf(FinancePeriod.WEEK) }\r\n    val state by viewModel.uiState.collectAsState()\r\n\r\n    when (val uiState = state) {\r\n        FinanceUiState.Loading -> FinanceLoading(modifier)\r\n        is FinanceUiState.Content -> FinanceContent(\r\n            modifier = modifier,\r\n            selectedPeriod = selectedPeriod,\r\n            onSelectPeriod = { selectedPeriod = it },\r\n            state = uiState,\r\n            onOpenStudent = onOpenStudent\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceLoading(modifier: Modifier) {\r\n    Box(\r\n        modifier = modifier\r\n            .fillMaxSize()\r\n            .background(MaterialTheme.colorScheme.background),\r\n        contentAlignment = Alignment.Center\r\n    ) {\r\n        CircularProgressIndicator()\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceContent(\r\n    modifier: Modifier,\r\n    selectedPeriod: FinancePeriod,\r\n    onSelectPeriod: (FinancePeriod) -> Unit,\r\n    state: FinanceUiState.Content,\r\n    onOpenStudent: (Long) -> Unit\r\n) {\r\n    val currencyFormatter = rememberCurrencyFormatter()\r\n    val dateFormatter = rememberDateFormatter()\r\n    val scrollState = rememberScrollState()\r\n\r\n    val summary = state.summaries[selectedPeriod] ?: FinanceSummary.EMPTY\r\n    val chartPoints = state.chart[selectedPeriod].orEmpty()\r\n    val debtors = state.debtors\r\n\r\n    val periodLabel = stringResource(selectedPeriod.periodLabelRes)\r\n    val periodText = stringResource(R.string.finance_metric_period, periodLabel)\r\n    val cashInValue = currencyFormatter.format(summary.cashIn)\r\n    val accruedValue = currencyFormatter.format(summary.accrued)\r\n    val debtValue = currencyFormatter.format(summary.accountsReceivable)\r\n    val prepaymentValue = currencyFormatter.format(summary.prepayments)\r\n    val lessonsValue = summary.lessons.total.toString()\r\n    val conductedText = stringResource(R.string.finance_lessons_badge_conducted, summary.lessons.conducted)\r\n    val cancelledText = stringResource(R.string.finance_lessons_badge_cancelled, summary.lessons.cancelled)\r\n\r\n    Column(\r\n        modifier = modifier\r\n            .fillMaxSize()\r\n            .background(MaterialTheme.colorScheme.background)\r\n            .verticalScroll(scrollState)\r\n            .padding(horizontal = 16.dp, vertical = 24.dp),\r\n        verticalArrangement = Arrangement.spacedBy(16.dp)\r\n    ) {\r\n        FinancePeriodSelector(\r\n            selected = selectedPeriod,\r\n            onSelect = onSelectPeriod\r\n        )\r\n\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            FinanceMetricCard(\r\n                modifier = Modifier.weight(1f),\r\n                title = stringResource(R.string.finance_cash_in_label),\r\n                value = cashInValue,\r\n                subtitle = periodText\r\n            )\r\n            FinanceMetricCard(\r\n                modifier = Modifier.weight(1f),\r\n                title = stringResource(R.string.finance_accrued_label),\r\n                value = accruedValue,\r\n                subtitle = periodText\r\n            )\r\n        }\r\n\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            FinanceMetricCard(\r\n                modifier = Modifier.weight(1f),\r\n                title = stringResource(R.string.finance_ar_label),\r\n                value = debtValue\r\n            )\r\n            FinanceMetricCard(\r\n                modifier = Modifier.weight(1f),\r\n                title = stringResource(R.string.finance_prepayments_label),\r\n                value = prepaymentValue\r\n            )\r\n        }\r\n\r\n        FinanceMetricCard(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            title = stringResource(R.string.finance_lessons_label),\r\n            value = lessonsValue,\r\n            subtitle = periodText,\r\n            footer = {\r\n                Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {\r\n                    FinanceBadge(\r\n                        text = conductedText,\r\n                        color = MaterialTheme.colorScheme.primaryContainer,\r\n                        contentColor = MaterialTheme.colorScheme.onPrimaryContainer\r\n                    )\r\n                    FinanceBadge(\r\n                        text = cancelledText,\r\n                        color = Color(0xFFD05E6E),\r\n                        contentColor = Color.White\r\n                    )\r\n                }\r\n            }\r\n        )\r\n\r\n        FinanceChartCard(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            points = chartPoints,\r\n            period = selectedPeriod,\r\n            currencyFormatter = currencyFormatter,\r\n            dateFormatter = dateFormatter\r\n        )\r\n\r\n        FinanceDebtorsSection(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            debtors = debtors,\r\n            currencyFormatter = currencyFormatter,\r\n            dateFormatter = dateFormatter,\r\n            onOpenStudent = onOpenStudent\r\n        )\r\n\r\n        Spacer(modifier = Modifier.height(8.dp))\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinancePeriodSelector(\r\n    selected: FinancePeriod,\r\n    onSelect: (FinancePeriod) -> Unit\r\n) {\r\n    Row(\r\n        horizontalArrangement = Arrangement.spacedBy(8.dp)\r\n    ) {\r\n        FinancePeriod.entries.forEach { period ->\r\n            val isSelected = period == selected\r\n            FilterChip(\r\n                selected = isSelected,\r\n                onClick = { onSelect(period) },\r\n                label = {\r\n                    Text(text = stringResource(period.tabLabelRes))\r\n                },\r\n                leadingIcon = if (isSelected) {\r\n                    {\r\n                        Icon(\r\n                            imageVector = Icons.Outlined.Check,\r\n                            contentDescription = null\r\n                        )\r\n                    }\r\n                } else {\r\n                    null\r\n                },\r\n                shape = RoundedCornerShape(12.dp),\r\n                colors = FilterChipDefaults.filterChipColors(\r\n                    selectedContainerColor = MaterialTheme.extendedColors.chipSelected,\r\n                    selectedLabelColor = MaterialTheme.colorScheme.onSecondaryContainer,\r\n                    selectedLeadingIconColor = MaterialTheme.colorScheme.onSecondaryContainer,\r\n                    containerColor = MaterialTheme.colorScheme.surface,\r\n                    labelColor = MaterialTheme.colorScheme.onSurface\r\n                )\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceMetricCard(\r\n    title: String,\r\n    value: String,\r\n    modifier: Modifier = Modifier,\r\n    subtitle: String? = null,\r\n    footer: (@Composable () -> Unit)? = null\r\n) {\r\n    Card(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = TutorlyCardDefaults.colors(containerColor = Color.White),\r\n        elevation = TutorlyCardDefaults.elevation()\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 16.dp),\r\n            verticalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            Text(\r\n                text = title,\r\n                style = MaterialTheme.typography.bodySmall,\r\n                color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                maxLines = 1,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            Text(\r\n                text = value,\r\n                style = MaterialTheme.typography.headlineMedium,\r\n                maxLines = 1,\r\n                overflow = TextOverflow.Ellipsis\r\n            )\r\n            subtitle?.let {\r\n                Text(\r\n                    text = it,\r\n                    style = MaterialTheme.typography.bodySmall,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            }\r\n            footer?.let {\r\n                it()\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceBadge(\r\n    text: String,\r\n    color: Color,\r\n    contentColor: Color,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    Surface(\r\n        modifier = modifier,\r\n        shape = RoundedCornerShape(50),\r\n        color = color,\r\n        contentColor = contentColor\r\n    ) {\r\n        Text(\r\n            modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),\r\n            text = text,\r\n            style = MaterialTheme.typography.labelLarge,\r\n            maxLines = 1,\r\n            overflow = TextOverflow.Ellipsis\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceChartCard(\r\n    modifier: Modifier,\r\n    points: List<FinanceChartPoint>,\r\n    period: FinancePeriod,\r\n    currencyFormatter: NumberFormat,\r\n    dateFormatter: DateTimeFormatter\r\n) {\r\n    Card(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = TutorlyCardDefaults.colors(containerColor = Color.White),\r\n        elevation = TutorlyCardDefaults.elevation()\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 20.dp),\r\n            verticalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(R.string.finance_chart_title),\r\n                style = MaterialTheme.typography.titleMedium,\r\n                maxLines = 1\r\n            )\r\n            if (points.isEmpty()) {\r\n                Text(\r\n                    text = stringResource(R.string.finance_chart_empty),\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            } else {\r\n                FinanceBarChart(\r\n                    points = points,\r\n                    period = period,\r\n                    dateFormatter = dateFormatter,\r\n                    modifier = Modifier\r\n                        .fillMaxWidth()\r\n                        .height(160.dp)\r\n                )\r\n                val total = points.sumOf { it.amount }\r\n                Text(\r\n                    modifier = Modifier.fillMaxWidth(),\r\n                    text = stringResource(\r\n                        R.string.finance_chart_total,\r\n                        currencyFormatter.format(total)\r\n                    ),\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    fontWeight = FontWeight.SemiBold,\r\n                    textAlign = TextAlign.Center\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceBarChart(\r\n    points: List<FinanceChartPoint>,\r\n    period: FinancePeriod,\r\n    dateFormatter: DateTimeFormatter,\r\n    modifier: Modifier = Modifier\r\n) {\r\n    val maxValue = remember(points) { points.maxOfOrNull { it.amount } ?: 0L }\r\n    val barColor = MaterialTheme.colorScheme.primary\r\n    val labels = remember(points, period, dateFormatter) {\r\n        buildChartLabels(points, period, dateFormatter)\r\n    }\r\n    Column(\r\n        modifier = modifier,\r\n        verticalArrangement = Arrangement.spacedBy(12.dp)\r\n    ) {\r\n        val density = LocalDensity.current\r\n        val labelColor = MaterialTheme.colorScheme.onSurfaceVariant\r\n        val textSizePx = with(density) { 12.sp.toPx() }\r\n        val labelPaint = remember(labelColor, textSizePx) {\r\n            android.graphics.Paint().apply {\r\n                isAntiAlias = true\r\n                color = labelColor.toArgb()\r\n                textAlign = android.graphics.Paint.Align.CENTER\r\n                textSize = textSizePx\r\n            }\r\n        }\r\n        Canvas(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .height(120.dp)\r\n        ) {\r\n            if (points.isEmpty()) return@Canvas\r\n            val max = maxValue.toFloat().coerceAtLeast(1f)\r\n            val height = size.height\r\n            val width = size.width\r\n            val bars = points.size\r\n            val barWidth = width / (bars * 1.6f)\r\n            val stepX = width / bars\r\n\r\n            points.forEachIndexed { index, point ->\r\n                val ratio = point.amount.toFloat() / max\r\n                val barHeight = ratio * height\r\n                val left = stepX * index + (stepX - barWidth) / 2f\r\n                drawRoundRect(\r\n                    color = barColor,\r\n                    topLeft = Offset(x = left, y = height - barHeight),\r\n                    size = Size(width = barWidth, height = barHeight),\r\n                    cornerRadius = CornerRadius(x = 12.dp.toPx(), y = 12.dp.toPx())\r\n                )\r\n            }\r\n        }\r\n        Canvas(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .height(24.dp)\r\n        ) {\r\n            if (points.isEmpty()) return@Canvas\r\n            val bars = points.size\r\n            val width = size.width\r\n            val stepX = width / bars\r\n            val baseline = size.height - labelPaint.fontMetrics.descent\r\n\r\n            labels.forEachIndexed { index, label ->\r\n                if (label.isNotBlank()) {\r\n                    val x = stepX * index + stepX / 2f\r\n                    drawContext.canvas.nativeCanvas.drawText(label, x, baseline, labelPaint)\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceDebtorsSection(\r\n    modifier: Modifier,\r\n    debtors: List<FinanceDebtor>,\r\n    currencyFormatter: NumberFormat,\r\n    dateFormatter: DateTimeFormatter,\r\n    onOpenStudent: (Long) -> Unit\r\n) {\r\n    Card(\r\n        modifier = modifier,\r\n        shape = MaterialTheme.shapes.large,\r\n        colors = TutorlyCardDefaults.colors(containerColor = Color.White),\r\n        elevation = TutorlyCardDefaults.elevation()\r\n    ) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(horizontal = 20.dp, vertical = 20.dp),\r\n            verticalArrangement = Arrangement.spacedBy(16.dp)\r\n        ) {\r\n            Text(\r\n                text = stringResource(R.string.finance_debtors_title),\r\n                style = MaterialTheme.typography.titleMedium\r\n            )\r\n\r\n            if (debtors.isEmpty()) {\r\n                Text(\r\n                    text = stringResource(R.string.finance_debtors_empty),\r\n                    style = MaterialTheme.typography.bodyMedium,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant\r\n                )\r\n            } else {\r\n                Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {\r\n                    debtors.forEach { debtor ->\r\n                        FinanceDebtorRow(\r\n                            debtor = debtor,\r\n                            currencyFormatter = currencyFormatter,\r\n                            dateFormatter = dateFormatter,\r\n                            onOpenStudent = onOpenStudent\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun FinanceDebtorRow(\r\n    debtor: FinanceDebtor,\r\n    currencyFormatter: NumberFormat,\r\n    dateFormatter: DateTimeFormatter,\r\n    onOpenStudent: (Long) -> Unit\r\n) {\r\n    Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            horizontalArrangement = Arrangement.SpaceBetween,\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            Column(modifier = Modifier.weight(1f), verticalArrangement = Arrangement.spacedBy(4.dp)) {\r\n                Text(\r\n                    modifier = Modifier.clickable { onOpenStudent(debtor.studentId) },\r\n                    text = debtor.name,\r\n                    style = MaterialTheme.typography.titleSmall,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n                Text(\r\n                    text = stringResource(R.string.finance_debtors_last_debt, dateFormatter.format(debtor.lastDueDate)),\r\n                    style = MaterialTheme.typography.bodySmall,\r\n                    color = MaterialTheme.colorScheme.onSurfaceVariant,\r\n                    maxLines = 1,\r\n                    overflow = TextOverflow.Ellipsis\r\n                )\r\n            }\r\n            Text(\r\n                text = currencyFormatter.format(debtor.amount),\r\n                style = MaterialTheme.typography.titleSmall,\r\n                fontWeight = FontWeight.SemiBold\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\nprivate fun buildChartLabels(\r\n    points: List<FinanceChartPoint>,\r\n    period: FinancePeriod,\r\n    dateFormatter: DateTimeFormatter\r\n): List<String> {\r\n    if (points.isEmpty()) return emptyList()\r\n    val locale = Locale.getDefault()\r\n    return when (period) {\r\n        FinancePeriod.WEEK -> points.map { point ->\r\n            point.date.dayOfWeek.getDisplayName(TextStyle.SHORT, locale)\r\n        }\r\n\r\n        FinancePeriod.MONTH -> {\r\n            val lastDay = points.maxOfOrNull { it.date.dayOfMonth } ?: 1\r\n            val labeledDays = setOf(1, 7, 14, 21, lastDay)\r\n            points.map { point ->\r\n                val day = point.date.dayOfMonth\r\n                if (day in labeledDays) day.toString() else \"\"\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun rememberCurrencyFormatter(): NumberFormat {\r\n    return remember {\r\n        NumberFormat.getCurrencyInstance(Locale.getDefault()).apply {\r\n            currency = Currency.getInstance(\"RUB\")\r\n            maximumFractionDigits = 0\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nprivate fun rememberDateFormatter(): DateTimeFormatter {\r\n    return remember {\r\n        DateTimeFormatter.ofPattern(\"d MMM\", Locale.getDefault())\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt b/app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt
--- a/app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt	(revision 973a8ae3a7afb2fa833e3d26dfd050c8a6421b9b)
+++ b/app/src/main/java/com/tutorly/ui/screens/FinanceScreen.kt	(date 1760794245497)
@@ -38,6 +38,7 @@
 import androidx.compose.ui.geometry.Offset
 import androidx.compose.ui.geometry.Size
 import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.graphics.nativeCanvas
 import androidx.compose.ui.graphics.toArgb
 import androidx.compose.ui.platform.LocalDensity
 import androidx.compose.ui.res.stringResource
@@ -440,7 +441,7 @@
         }
     }
 }
-}
+
 
 @Composable
 private fun FinanceDebtorsSection(
